---
phase: 12-search-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/searchFilterStore.ts
  - src/components/SearchBar.tsx
  - src/components/MainLayout.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Typing in toolbar search bar updates a global filter term accessible by all columns"
    - "Clearing search or pressing Escape restores empty filter state"
    - "Search bar shows match count badge when filter is active"
  artifacts:
    - path: "src/stores/searchFilterStore.ts"
      provides: "Global search filter state with fuzzy matching"
      exports: ["useSearchFilterStore"]
    - path: "src/components/SearchBar.tsx"
      provides: "Rewired search bar that updates filter store instead of dropdown"
  key_links:
    - from: "src/components/SearchBar.tsx"
      to: "src/stores/searchFilterStore.ts"
      via: "Zustand store subscription"
      pattern: "useSearchFilterStore"
---

<objective>
Install fuzzy matching dependencies, create a global search filter store, and rewire the SearchBar component to drive in-place column filtering instead of the old dropdown search results panel.

Purpose: Establishes the shared state foundation that FileTree and ChangelistPanel will consume for in-place filtering.
Output: searchFilterStore with filter term + match counts, rewired SearchBar component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/stores/searchFilterStore.ts (will be created)
@src/components/SearchBar.tsx
@src/components/SearchResultsPanel.tsx
@src/hooks/useSearch.ts
@src/components/MainLayout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create searchFilterStore</name>
  <files>package.json, src/stores/searchFilterStore.ts</files>
  <action>
    1. Install `@nozbe/microfuzz` (fuzzy matching with highlight ranges). Do NOT install react-highlight-words yet — highlight rendering will be done in Plan 02.
       ```
       npm install @nozbe/microfuzz
       ```

    2. Create `src/stores/searchFilterStore.ts` with Zustand:
       ```typescript
       import { create } from 'zustand';

       interface SearchFilterState {
         // State
         filterTerm: string;          // Current search/filter text
         isActive: boolean;           // Whether filter is active (term is non-empty)
         fileTreeMatchCount: number;  // Match count from file tree
         changelistMatchCount: number; // Match count from changelist panel

         // Actions
         setFilterTerm: (term: string) => void;
         clearFilter: () => void;
         setFileTreeMatchCount: (count: number) => void;
         setChangelistMatchCount: (count: number) => void;
       }

       export const useSearchFilterStore = create<SearchFilterState>((set) => ({
         filterTerm: '',
         isActive: false,
         fileTreeMatchCount: 0,
         changelistMatchCount: 0,

         setFilterTerm: (term) => set({
           filterTerm: term,
           isActive: term.trim().length > 0,
         }),

         clearFilter: () => set({
           filterTerm: '',
           isActive: false,
           fileTreeMatchCount: 0,
           changelistMatchCount: 0,
         }),

         setFileTreeMatchCount: (count) => set({ fileTreeMatchCount: count }),
         setChangelistMatchCount: (count) => set({ changelistMatchCount: count }),
       }));
       ```

    No debounce — instant filtering on every keystroke per CONTEXT.md. Use `useDeferredValue` in consumers (Plan 02) for performance.
  </action>
  <verify>
    - `npm ls @nozbe/microfuzz` shows installed package
    - `src/stores/searchFilterStore.ts` exists and exports `useSearchFilterStore`
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>searchFilterStore created with filterTerm, isActive, match counts, and actions. microfuzz installed.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire SearchBar to use filter store</name>
  <files>src/components/SearchBar.tsx, src/components/MainLayout.tsx</files>
  <action>
    Rewrite `SearchBar.tsx` to:

    1. **Remove** the old dropdown search pattern entirely:
       - Remove `useSearch` hook import and usage
       - Remove `SearchResultsPanel` import and rendering
       - Remove `debouncedTerm` state (no debounce needed)
       - Remove the old click-outside-to-close and click-to-expand pattern

    2. **New behavior** — always-visible search input in toolbar:
       - Import `useSearchFilterStore` from the new store
       - The search bar is always an input field (not a collapsible icon button). Use a compact design: search icon + input + optional clear X button + match count badge.
       - On every keystroke, call `setFilterTerm(value)` on the store (instant, no debounce)
       - Show match count badge next to input when `isActive` is true: display `fileTreeMatchCount + changelistMatchCount` as total, e.g., "12 matches"
       - Show X clear button only when input has text
       - Ctrl+F should focus the search input (add a `data-testid="search-filter-input"` for the input ref)

    3. **Escape key behavior** (progressive):
       - If input has text: clear text first (call `clearFilter()`)
       - If input is empty: blur the input (unfocus)
       - Use `stopPropagation()` to prevent Escape from propagating to other handlers

    4. **Visual design:**
       - Compact inline input: `bg-muted rounded-md px-2 py-1 border border-border`
       - Search icon (lucide `Search`) on the left, 4x4
       - Input with placeholder "Filter files & changelists..." (w-48 or similar)
       - Match count badge: small text `text-xs text-muted-foreground` shown inline after input when active
       - Clear X button: small ghost button, only shown when text present

    5. **Wire Ctrl+F in MainLayout.tsx:**
       - Add a `useHotkeys('ctrl+f', ...)` that focuses the search input
       - Use a ref or a custom event `p4now:focus-search` dispatched from MainLayout, listened to by SearchBar
       - preventDefault on Ctrl+F to avoid browser's native find

    6. **Cleanup:** Delete `src/components/SearchResultsPanel.tsx` and `src/hooks/useSearch.ts` — they are replaced by the filter store. Remove any imports of these files from other components.
  </action>
  <verify>
    - App compiles: `npm run build`
    - SearchBar renders as always-visible input in toolbar header
    - Typing updates the store (can verify by adding a temporary console.log in store)
    - No remaining imports of `SearchResultsPanel` or `useSearch` in codebase
  </verify>
  <done>SearchBar rewired to update global filter store. Old dropdown search removed. Ctrl+F focuses search. Match count badge shows when filtering. Escape clears then blurs.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no TypeScript errors
- SearchBar always visible in toolbar as input field
- Typing in search bar updates `useSearchFilterStore.filterTerm` instantly
- Escape key clears text first, then blurs
- Match count badge area visible (will show 0 until Plan 02 wires consumers)
- `SearchResultsPanel.tsx` and `useSearch.ts` deleted
- No broken imports
</verification>

<success_criteria>
- Global search filter store exists and is reactive
- SearchBar drives filter state, not dropdown results
- Old search dropdown code removed
- Ctrl+F focuses search input
</success_criteria>

<output>
After completion, create `.planning/phases/12-search-filtering/12-01-SUMMARY.md`
</output>
