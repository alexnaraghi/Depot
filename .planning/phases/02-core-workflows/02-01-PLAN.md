---
phase: 02-core-workflows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/p4.ts
  - src/stores/fileTreeStore.ts
  - src/stores/changelistStore.ts
  - src/hooks/useP4Events.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types exist for Perforce files, changelists, and file status"
    - "Zustand stores can hold file tree and changelist data"
    - "Frontend can subscribe to Tauri events for file status updates"
  artifacts:
    - path: "src/types/p4.ts"
      provides: "P4 type definitions"
      exports: ["P4File", "P4Changelist", "FileStatus", "FileAction"]
    - path: "src/stores/fileTreeStore.ts"
      provides: "File tree state management"
      exports: ["useFileTreeStore"]
    - path: "src/stores/changelistStore.ts"
      provides: "Changelist state management"
      exports: ["useChangelistStore"]
    - path: "src/hooks/useP4Events.ts"
      provides: "Tauri event subscription hook"
      exports: ["useP4Events"]
  key_links:
    - from: "src/stores/fileTreeStore.ts"
      to: "src/types/p4.ts"
      via: "type imports"
      pattern: "import.*P4File.*from.*types/p4"
    - from: "src/hooks/useP4Events.ts"
      to: "@tauri-apps/api/event"
      via: "listen function"
      pattern: "listen.*file-status"
---

<objective>
Create TypeScript types and Zustand stores for Perforce data models with Tauri event subscription infrastructure.

Purpose: Establish the data layer that file tree and changelist components will consume. Types ensure consistency across the app. Stores provide reactive state. Event hooks enable real-time updates from backend operations.

Output: Type definitions, two Zustand stores, and a Tauri event subscription hook.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-workflows/02-CONTEXT.md
@.planning/phases/02-core-workflows/02-RESEARCH.md
@src/store/operation.ts
@src/hooks/useP4Command.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create P4 TypeScript types</name>
  <files>src/types/p4.ts</files>
  <action>
Create comprehensive TypeScript types for Perforce data models:

**FileStatus enum:**
- synced (at head, no local changes)
- checkedOut (opened for edit)
- added (opened for add)
- deleted (opened for delete)
- modified (local changes detected)
- outOfDate (newer version in depot)
- conflict (local edit vs depot change)

**FileAction enum:** (matches p4 action field)
- edit, add, delete, branch, integrate, move/add, move/delete

**P4File interface:**
- depotPath: string (//depot/path)
- localPath: string (absolute local path)
- status: FileStatus
- action?: FileAction (if opened)
- revision: number (have revision)
- headRevision: number (depot head)
- changelist?: number (if opened, which CL)
- fileType: string (text, binary, etc.)
- isDirectory: boolean

**P4Changelist interface:**
- id: number (changelist number, 'default' is 0)
- description: string
- user: string
- client: string
- status: 'pending' | 'submitted' | 'shelved'
- files: P4File[] (files in this changelist)
- fileCount: number

**TreeNode interface:** (for react-arborist)
- id: string (unique identifier)
- name: string (display name)
- data: P4File | P4Changelist
- children?: TreeNode[]

Export all types.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/types/p4.ts`</verify>
  <done>All P4 types exported and compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create Zustand stores for file tree and changelists</name>
  <files>src/stores/fileTreeStore.ts, src/stores/changelistStore.ts</files>
  <action>
**fileTreeStore.ts:**
- State: files (Map<string, P4File> keyed by depotPath), rootPath (workspace root), isLoading
- Actions:
  - setFiles(files: P4File[]) - bulk set from p4 fstat
  - updateFile(depotPath: string, updates: Partial<P4File>) - update single file
  - setRootPath(path: string)
  - setLoading(loading: boolean)
  - getFileByPath(depotPath: string): P4File | undefined
  - getFilesInFolder(folderPath: string): P4File[]
- Use Map for O(1) lookups by path
- Do NOT include tree-building logic here (that's UI layer)

**changelistStore.ts:**
- State: changelists (Map<number, P4Changelist>), isLoading
- Actions:
  - setChangelists(cls: P4Changelist[]) - bulk set from p4 changes
  - updateChangelist(id: number, updates: Partial<P4Changelist>)
  - addFileToChangelist(changelistId: number, file: P4File)
  - removeFileFromChangelist(changelistId: number, depotPath: string)
  - setLoading(loading: boolean)
  - getChangelist(id: number): P4Changelist | undefined
  - getPendingChangelists(): P4Changelist[]
- Default changelist (id=0) always exists

Import types from @/types/p4.
Follow pattern from existing src/store/operation.ts (create function signature).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/stores/fileTreeStore.ts src/stores/changelistStore.ts`</verify>
  <done>Both stores export properly typed state and actions</done>
</task>

<task type="auto">
  <name>Task 3: Create Tauri event subscription hook</name>
  <files>src/hooks/useP4Events.ts</files>
  <action>
Create useP4Events hook for subscribing to backend events:

**Event types to handle:**
- 'file-status-changed': { depotPath: string, status: FileStatus, action?: FileAction, revision?: number }
- 'changelist-updated': { id: number, description?: string, fileCount?: number }
- 'sync-progress': { depotPath: string, action: string, revision: number }
- 'operation-complete': { operation: string, success: boolean, error?: string }

**Hook implementation:**
- useEffect to set up listeners on mount
- Return cleanup function to remove listeners on unmount
- Call appropriate store actions when events received:
  - file-status-changed -> fileTreeStore.updateFile()
  - changelist-updated -> changelistStore.updateChangelist()
- Accept optional config object for selective event subscription

Import listen from '@tauri-apps/api/event'.
Import store hooks for updating state.
Ensure cleanup runs on unmount to prevent memory leaks.

**Usage pattern:**
```typescript
// In App.tsx or top-level component
useP4Events(); // subscribes to all events

// Or selective
useP4Events({ fileStatus: true, changelists: false });
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/hooks/useP4Events.ts`</verify>
  <done>Hook subscribes to Tauri events and updates stores on event receipt</done>
</task>

</tasks>

<verification>
- All three files exist and export expected items
- TypeScript compilation succeeds for all files
- Import paths resolve correctly (@/types/p4, @/stores/*)
- No circular dependencies
</verification>

<success_criteria>
- P4 types cover all file states and changelist data needed for UI
- Stores provide reactive state management with efficient lookups
- Event hook enables real-time updates from backend operations
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-workflows/02-01-SUMMARY.md`
</output>
