---
phase: 13-workspace-stream-switching
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Header/WorkspaceSwitcher.tsx
  - src/components/MainLayout.tsx
autonomous: true

must_haves:
  truths:
    - "User sees workspace dropdown in header showing current workspace name"
    - "User can select a different workspace from dropdown and UI refreshes"
    - "Header label says 'Workspace' not 'Repository'"
    - "Toast notification appears on successful workspace switch"
    - "Detail pane resets to workspace summary after switch"
  artifacts:
    - path: "src/components/Header/WorkspaceSwitcher.tsx"
      provides: "Workspace dropdown component with switch logic"
    - path: "src/components/MainLayout.tsx"
      provides: "Updated header with WorkspaceSwitcher replacing static text"
  key_links:
    - from: "src/components/Header/WorkspaceSwitcher.tsx"
      to: "src/stores/connectionStore.ts"
      via: "useConnectionStore hook"
      pattern: "useConnectionStore"
    - from: "src/components/Header/WorkspaceSwitcher.tsx"
      to: "src/lib/tauri.ts"
      via: "invokeListWorkspaces + invokeP4Info"
      pattern: "invokeListWorkspaces|invokeP4Info"
---

<objective>
Create workspace switcher dropdown in header and fix "Repository" label to "Workspace".

Purpose: Users can quickly switch between P4 workspaces without opening settings dialog.
Output: WorkspaceSwitcher component integrated into header, replacing static workspace text.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-workspace-stream-switching/13-CONTEXT.md
@.planning/phases/13-workspace-stream-switching/13-RESEARCH.md
@src/components/MainLayout.tsx
@src/stores/connectionStore.ts
@src/stores/detailPaneStore.ts
@src/lib/tauri.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkspaceSwitcher component</name>
  <files>src/components/Header/WorkspaceSwitcher.tsx</files>
  <action>
Create src/components/Header/WorkspaceSwitcher.tsx:

1. **Fetch workspaces** on mount when p4port and p4user are available using existing invokeListWorkspaces(server, user). Store in local state. Refetch when p4port/p4user change.

2. **Dropdown UI** using Radix Select (already installed, use from @/components/ui/select):
   - SelectTrigger shows current workspace name (from connectionStore)
   - Width: auto, min-width ~180px, styled to match header aesthetic
   - Label above: "Workspace" in text-[10px] uppercase tracking-wider text-muted-foreground (matching existing stream label style)
   - SelectContent lists all workspaces. Each SelectItem shows workspace name. Optionally show root path in smaller muted text if workspaces share similar names.
   - Disable trigger while switching (isSwitching state)

3. **Switch logic** (onValueChange handler):
   - Set isSwitching = true
   - Call invokeP4Info(p4port, p4user, newClient) to validate and get updated info
   - Call connectionStore.setConnected() with all fields from response + current p4port/p4user + new p4client
   - Call queryClient.invalidateQueries() to refresh all data
   - Call detailPaneStore.clear() to reset detail pane to workspace summary
   - Show toast.success(`Switched to workspace ${newClient}`)
   - On error: toast.error with message, don't change state
   - Set isSwitching = false in finally block

4. **Loading indicator**: Show Loader2 spinner (from lucide-react) when isSwitching, replacing the chevron.

5. **Don't render** if status !== 'connected' (no workspaces to show when disconnected).
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles</verify>
  <done>WorkspaceSwitcher component exists and compiles</done>
</task>

<task type="auto">
  <name>Task 2: Integrate WorkspaceSwitcher into header and fix label</name>
  <files>src/components/MainLayout.tsx</files>
  <action>
In MainLayout.tsx:

1. **Fix "Repository" label**: Change the text "Repository" to "Workspace" in the header's left section (line ~217). Also update the comment on line ~214 from "Repository and Stream info" to "Workspace and Stream info", and the JSDoc comment on line ~31.

2. **Replace static workspace text** with WorkspaceSwitcher component:
   - Import WorkspaceSwitcher from '@/components/Header/WorkspaceSwitcher'
   - Replace the static div showing workspace name:
     ```tsx
     <div className="flex flex-col">
       <span className="text-[10px] ...">Repository</span>
       <span className="text-sm ...">{workspace || 'No workspace'}</span>
     </div>
     ```
     with:
     ```tsx
     <WorkspaceSwitcher />
     ```
   - Keep the stream display section unchanged for now (Plan 03 will handle StreamSwitcher)

3. **Ensure** the WorkspaceSwitcher's label+dropdown matches the visual rhythm of the existing stream label (text-[10px] label above, value below). The component itself handles this styling.
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles. Run `npm run build` to verify full build.</verify>
  <done>Header shows WorkspaceSwitcher dropdown instead of static text. Label says "Workspace" not "Repository".</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — compiles
2. `npm run build` — full build succeeds
3. Grep for "Repository" in MainLayout.tsx — should not exist
4. Grep for "WorkspaceSwitcher" in MainLayout.tsx — should be imported and used
</verification>

<success_criteria>
- WorkspaceSwitcher dropdown appears in header with "Workspace" label
- Selecting a workspace calls p4 info, updates connection store, invalidates queries, resets detail pane
- Toast shows on successful switch
- "Repository" label is gone from header
</success_criteria>

<output>
After completion, create `.planning/phases/13-workspace-stream-switching/13-02-SUMMARY.md`
</output>
