---
phase: 11-auto-refresh-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/settings.ts
  - src/lib/settings.ts
  - src/hooks/useWindowFocus.ts
  - src/components/ChangelistPanel/useChangelists.ts
autonomous: true

must_haves:
  truths:
    - "Workspace state auto-refreshes at configurable interval (default 5m)"
    - "Auto-refresh pauses during active operations (sync, submit, etc.)"
    - "Auto-refresh pauses when window is minimized or inactive"
    - "Auto-refresh disabled when interval is 0"
    - "Existing users get sensible defaults for new settings fields"
  artifacts:
    - path: "src/types/settings.ts"
      provides: "Extended P4Settings type with editorPath and autoRefreshInterval"
      contains: "editorPath"
    - path: "src/lib/settings.ts"
      provides: "Load/save for new settings fields with migration-safe defaults"
      contains: "autoRefreshInterval"
    - path: "src/hooks/useWindowFocus.ts"
      provides: "React hook tracking Tauri window focus/blur state"
      exports: ["useWindowFocus"]
    - path: "src/components/ChangelistPanel/useChangelists.ts"
      provides: "Auto-refresh wiring with conditional enabled + refetchInterval"
      contains: "refetchInterval"
  key_links:
    - from: "src/hooks/useWindowFocus.ts"
      to: "@tauri-apps/api/window"
      via: "getCurrentWindow().listen('tauri://focus')"
      pattern: "tauri://focus"
    - from: "src/components/ChangelistPanel/useChangelists.ts"
      to: "src/hooks/useWindowFocus.ts"
      via: "useWindowFocus() hook call"
      pattern: "useWindowFocus"
    - from: "src/components/ChangelistPanel/useChangelists.ts"
      to: "src/lib/settings.ts"
      via: "getAutoRefreshInterval() for polling interval"
      pattern: "getAutoRefreshInterval"
---

<objective>
Extend the settings schema with editorPath and autoRefreshInterval fields, create a window focus tracking hook, and wire conditional auto-refresh into the changelist query hooks.

Purpose: This is the functional core of Phase 11 — after this plan, workspace data will automatically refresh at a configurable interval, pausing during operations and when the window is inactive.
Output: Extended settings types/persistence, useWindowFocus hook, auto-refreshing query hooks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-auto-refresh-settings/11-RESEARCH.md
@src/types/settings.ts
@src/lib/settings.ts
@src/hooks/useWindowFocus.ts
@src/components/ChangelistPanel/useChangelists.ts
@src/store/operation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend settings schema and persistence layer</name>
  <files>src/types/settings.ts, src/lib/settings.ts</files>
  <action>
    In `src/types/settings.ts`:
    - Add `editorPath: z.string()` to settingsSchema
    - Add `autoRefreshInterval: z.number().min(0).max(600000)` to settingsSchema (0 = disabled, max 10 minutes)
    - Add defaults: `editorPath: ''`, `autoRefreshInterval: 300000` (5 minutes)

    In `src/lib/settings.ts`:
    - Add `editorPath` to loadSettings: `(await store.get<string>('editorPath')) || defaultSettings.editorPath`
    - Add `autoRefreshInterval` to loadSettings: `(await store.get<number>('autoRefreshInterval')) ?? defaultSettings.autoRefreshInterval` (use ?? not || because 0 is valid)
    - Add both fields to saveSettings
    - Add helper function `getAutoRefreshInterval()` that loads just the interval value without loading all settings:
      ```typescript
      export async function getAutoRefreshInterval(): Promise<number> {
        const store = await getStore();
        return (await store.get<number>('autoRefreshInterval')) ?? defaultSettings.autoRefreshInterval;
      }
      ```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>P4Settings type includes editorPath (string) and autoRefreshInterval (number 0-600000). loadSettings/saveSettings handle both new fields with migration-safe defaults. getAutoRefreshInterval helper exists.</done>
</task>

<task type="auto">
  <name>Task 2: Create useWindowFocus hook and wire auto-refresh into queries</name>
  <files>src/hooks/useWindowFocus.ts, src/components/ChangelistPanel/useChangelists.ts</files>
  <action>
    Create `src/hooks/useWindowFocus.ts`:
    - Import `useState`, `useEffect` from React
    - Import `getCurrentWindow` from `@tauri-apps/api/window`
    - Create and export `useWindowFocus()` hook that:
      - Starts with `isFocused = true` (optimistic)
      - In useEffect, calls `getCurrentWindow()` and sets up listeners for `'tauri://focus'` (set true) and `'tauri://blur'` (set false)
      - Properly cleans up listeners on unmount (the listen() calls return Promises that resolve to unlisten functions)
      - Returns the boolean `isFocused` state
    - See 11-RESEARCH.md "Window Focus Hook" section for exact implementation pattern

    Modify `src/components/ChangelistPanel/useChangelists.ts`:
    - Import `useWindowFocus` from `@/hooks/useWindowFocus`
    - Import `getAutoRefreshInterval` from `@/lib/settings`
    - Import `useState` (already has useEffect)
    - Add `const isWindowFocused = useWindowFocus();` at top of hook
    - Add state for auto-refresh interval:
      ```typescript
      const [autoRefreshInterval, setAutoRefreshInterval] = useState<number>(0);
      useEffect(() => {
        getAutoRefreshInterval().then(setAutoRefreshInterval);
      }, []);
      ```
    - Compute `isAutoRefreshActive`:
      ```typescript
      const { currentOperation } = useOperationStore();
      const isAutoRefreshActive = isConnected && !currentOperation && isWindowFocused && autoRefreshInterval > 0;
      ```
      Note: `useOperationStore` is already imported but only used via `.getState()` inside queryFn. Add a direct hook call at the top level of useChangelists for reactive updates.
    - Add `refetchInterval: isAutoRefreshActive ? autoRefreshInterval : false` to ALL three query configurations (changes query, opened query, and each shelved query in useQueries)
    - Keep existing `enabled: isConnected` — do NOT change enabled to use isAutoRefreshActive (queries should still work for manual refresh even when auto-refresh is paused)
    - Keep existing `staleTime: 30000` and `refetchOnWindowFocus: false`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. App starts without errors: `npm run tauri dev` and verify no console errors related to window focus or auto-refresh.</verify>
  <done>useWindowFocus hook exists and tracks Tauri window focus/blur events. All changelist queries have conditional refetchInterval that pauses during operations, when window is blurred, and when interval is 0. Manual refresh still works regardless of auto-refresh state.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. App launches and connects to P4 server normally
3. Default auto-refresh interval is 300000ms (5 minutes) for new/existing users
4. Changelist data refreshes automatically (observable in verbose logging mode)
5. Minimizing the window stops auto-refresh polling (no P4 commands in verbose log while minimized)
6. Starting a sync or submit operation pauses auto-refresh during the operation
</verification>

<success_criteria>
- Settings schema extended with editorPath and autoRefreshInterval
- useWindowFocus hook tracks window focus via Tauri events
- All changelist queries auto-refresh at configured interval
- Auto-refresh pauses during operations and when window is inactive
- Existing users get default 5-minute interval without manual configuration
</success_criteria>

<output>
After completion, create `.planning/phases/11-auto-refresh-settings/11-01-SUMMARY.md`
</output>
