---
phase: 05-history-diff-search
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/dialogs/FileHistoryDialog.tsx
  - src/hooks/useFileHistory.ts
  - src/hooks/useDiff.ts
  - src/components/FileTree/FileContextMenu.tsx
  - src/components/ChangelistPanel/ChangelistContextMenu.tsx
  - src/components/SettingsDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can open File History dialog from file context menu and see revision list with rev, action, changelist, date, user, description"
    - "User can click 'Diff vs Previous' on a revision to launch external diff tool"
    - "User can click 'Diff vs Workspace' on a revision to diff that revision against the local file"
    - "User can click 'Load More' to fetch additional revisions beyond the initial 50"
    - "User can configure diff tool path and arguments in the Settings dialog"
    - "User can launch 'Diff against have' from pending changes file context menu"
  artifacts:
    - path: "src/components/dialogs/FileHistoryDialog.tsx"
      provides: "Modal dialog showing file revision history with diff actions"
    - path: "src/hooks/useFileHistory.ts"
      provides: "TanStack Query hook for p4 filelog"
    - path: "src/hooks/useDiff.ts"
      provides: "Hook to launch external diff tool with temp file management"
    - path: "src/components/SettingsDialog.tsx"
      provides: "Diff tool path and args configuration fields"
  key_links:
    - from: "src/components/dialogs/FileHistoryDialog.tsx"
      to: "src/hooks/useFileHistory.ts"
      via: "useFileHistory hook"
      pattern: "useFileHistory"
    - from: "src/hooks/useDiff.ts"
      to: "src/lib/tauri.ts"
      via: "invokeP4PrintToFile + invokeLaunchDiffTool"
      pattern: "invokeP4PrintToFile|invokeLaunchDiffTool"
    - from: "src/components/FileTree/FileContextMenu.tsx"
      to: "src/components/dialogs/FileHistoryDialog.tsx"
      via: "State to open dialog"
      pattern: "FileHistoryDialog|onShowHistory"
---

<objective>
Build the File History dialog, diff launching hooks, context menu integration for "File History" and "Diff against have", and add diff tool configuration to the Settings dialog.

Purpose: Users can view any file's revision history, compare revisions via external diff tool, and configure their preferred diff tool.
Output: FileHistoryDialog component, useFileHistory/useDiff hooks, extended context menus, settings UI for diff tool.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-history-diff-search/05-RESEARCH.md
@.planning/phases/05-history-diff-search/05-01-SUMMARY.md

@src/components/SettingsDialog.tsx
@src/components/FileTree/FileContextMenu.tsx
@src/components/ChangelistPanel/ChangelistContextMenu.tsx
@src/components/dialogs/SyncConflictDialog.tsx
@src/hooks/useSettings.ts
@src/lib/tauri.ts
@src/types/settings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: File History dialog, hooks, and diff launching</name>
  <files>src/components/dialogs/FileHistoryDialog.tsx, src/hooks/useFileHistory.ts, src/hooks/useDiff.ts</files>
  <action>
1. Create `src/hooks/useFileHistory.ts`:
   - Export `useFileHistory(depotPath: string, enabled: boolean)` hook
   - Use TanStack Query: `queryKey: ['p4', 'filelog', depotPath, maxRevisions]`
   - Start with `maxRevisions = 50`, expose `loadMore()` function that increments by 50
   - Use connection store for server/user/client args (follow existing patterns like useChangelists)
   - Return `{ revisions, isLoading, loadMore, hasMore }` — `hasMore` is true if returned count equals maxRevisions

2. Create `src/hooks/useDiff.ts`:
   - Export `useDiff()` hook that returns `{ diffRevisions, diffAgainstWorkspace }` functions
   - `diffRevisions(depotPath, rev1, rev2)`: calls `invokeP4PrintToFile` for both revisions, then `invokeLaunchDiffTool` with both temp paths
   - `diffAgainstWorkspace(depotPath, localPath, revision?)`: if revision provided, prints that revision to temp file and diffs against localPath. If no revision, prints head revision (use p4_print_to_file with the file's head_revision or just the latest) and diffs against localPath
   - Read diff tool path/args from settings (use `useSettings` or connection store — wherever diff tool config lives)
   - Show toast error if diff tool path is not configured
   - Show toast error if diff tool fails to launch

3. Create `src/components/dialogs/FileHistoryDialog.tsx`:
   - Props: `open: boolean, onOpenChange: (open: boolean) => void, depotPath: string, localPath: string`
   - Use Radix Dialog (follow SettingsDialog.tsx pattern for Dialog, DialogContent, DialogHeader, DialogTitle)
   - Use `useFileHistory` hook
   - Use `useDiff` hook for diff actions
   - Display revisions in a table with columns: Rev (#N), Change, Action, Date (formatted from epoch), User, Description (truncated)
   - Each row has two icon buttons: "Diff vs Previous" (disabled for first revision / action=add) and "Diff vs Workspace"
   - "Load More" button at bottom, disabled when loading or no more results
   - Style: max-w-4xl, max-h-[80vh] with overflow-auto on table area, dark theme matching existing dialogs
   - Use lucide-react icons: `History` for dialog header, `GitCompare` or `Diff` for diff buttons
  </action>
  <verify>
TypeScript compiles. FileHistoryDialog renders when opened with a depot path. Revisions display in table format.
  </verify>
  <done>FileHistoryDialog shows revision history with diff action buttons. useFileHistory provides paginated data. useDiff launches external diff tool.</done>
</task>

<task type="auto">
  <name>Task 2: Context menu integration and Settings dialog diff tool config</name>
  <files>src/components/FileTree/FileContextMenu.tsx, src/components/ChangelistPanel/ChangelistContextMenu.tsx, src/components/SettingsDialog.tsx</files>
  <action>
1. Update `src/components/FileTree/FileContextMenu.tsx`:
   - Add "File History" menu item (History icon from lucide-react) — always available
   - Add "Diff against Have" menu item (GitCompare icon) — available when file is checked out (canRevert status)
   - Both items call callback props: `onShowHistory?(depotPath, localPath)` and `onDiffAgainstHave?(depotPath, localPath)`
   - Add these optional callback props to FileContextMenuProps

2. Update the parent component that renders FileContextMenu to handle the new callbacks:
   - Wire `onShowHistory` to open FileHistoryDialog with the selected file's depot path and local path
   - Wire `onDiffAgainstHave` to call `useDiff().diffAgainstWorkspace(depotPath, localPath)` — diffs workspace file against have revision
   - FileHistoryDialog state (open/depotPath) managed in the parent component

3. Check if `ChangelistContextMenu.tsx` has file-level context menu items. If it has per-file actions, add "File History" and "Diff against Have" there too using same callback pattern. If it only has changelist-level actions, skip.

4. Update `src/components/SettingsDialog.tsx`:
   - Add a "Diff Tool" section below existing connection settings
   - Add "Diff Tool Path" text input (e.g., `code`, `C:\Program Files\VS Code\Code.exe`, `p4merge`)
   - Add "Diff Tool Arguments" text input with placeholder `--diff {left} {right}` — explain that `{left}` and `{right}` are replaced with file paths, or leave empty to pass files as final arguments
   - These fields bind to `diffToolPath` and `diffToolArgs` in the settings form
   - Save/load with existing settings infrastructure
  </action>
  <verify>
Right-click a file in file tree — "File History" and "Diff against Have" appear. Settings dialog shows diff tool configuration fields. Settings persist across dialog close/reopen.
  </verify>
  <done>Context menus have "File History" and "Diff against Have" entries. Settings dialog has diff tool path/args configuration. All wired to backend commands.</done>
</task>

</tasks>

<verification>
1. Open file context menu — "File History" and "Diff against Have" items visible
2. Click "File History" — dialog opens with revision table
3. Click "Diff vs Previous" on a revision — external diff tool launches (if configured)
4. Click "Diff vs Workspace" on a revision — diffs revision against local file
5. Click "Diff against Have" from context menu — diffs local file against have revision
6. Settings dialog shows diff tool path/args fields that persist
7. "Load More" button fetches additional revisions
</verification>

<success_criteria>
- File history dialog displays revision data (rev, change, action, date, user, description)
- External diff tool launches for revision-vs-previous and revision-vs-workspace comparisons
- Diff tool path/args configurable in settings
- Context menus provide File History and Diff access points
</success_criteria>

<output>
After completion, create `.planning/phases/05-history-diff-search/05-02-SUMMARY.md`
</output>
