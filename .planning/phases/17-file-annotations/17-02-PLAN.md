---
phase: 17-file-annotations
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - package.json
  - package-lock.json
  - src/components/DetailPane/FileAnnotationViewer.tsx
  - src/components/DetailPane/AnnotationGutter.tsx
  - src/components/DetailPane/RevisionDetailView.tsx
autonomous: true

must_haves:
  truths:
    - "User can view per-line author, revision, and date for any file"
    - "Annotations show age heatmap coloring (recent = hot red, old = cold blue)"
    - "Large files (1000+ lines) render smoothly with virtualization"
  artifacts:
    - path: "src/components/DetailPane/FileAnnotationViewer.tsx"
      provides: "Main blame viewer container component"
      min_lines: 80
    - path: "src/components/DetailPane/AnnotationGutter.tsx"
      provides: "Virtualized annotation gutter with heatmap coloring"
      min_lines: 60
    - path: "package.json"
      contains: "@tanstack/react-virtual"
  key_links:
    - from: "src/components/DetailPane/RevisionDetailView.tsx"
      to: "src/components/DetailPane/FileAnnotationViewer.tsx"
      via: "component import and render"
      pattern: "FileAnnotationViewer"
    - from: "src/components/DetailPane/FileAnnotationViewer.tsx"
      to: "src/hooks/useFileAnnotations.ts"
      via: "hook usage"
      pattern: "useFileAnnotations"
    - from: "src/components/DetailPane/AnnotationGutter.tsx"
      to: "@tanstack/react-virtual"
      via: "useVirtualizer hook"
      pattern: "useVirtualizer"
---

<objective>
Create the file annotation viewer UI with virtualized rendering and heatmap coloring

Purpose: Enable users to see per-line blame information with visual age indicators, performant even for large files

Output: FileAnnotationViewer and AnnotationGutter components integrated into RevisionDetailView with "View Annotations" toggle
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 provides hooks and utilities
@.planning/phases/17-file-annotations/17-01-SUMMARY.md

# Research provides virtualization patterns
@.planning/phases/17-file-annotations/17-RESEARCH.md

# Phase 16 established patterns for file viewing in RevisionDetailView
@.planning/phases/16-file-content-viewer/16-02-SUMMARY.md

# Existing components to extend
@src/components/DetailPane/RevisionDetailView.tsx
@src/components/DetailPane/FileContentViewer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @tanstack/react-virtual and create AnnotationGutter</name>
  <files>package.json, src/components/DetailPane/AnnotationGutter.tsx</files>
  <action>
1. Install TanStack Virtual:
   ```bash
   npm install @tanstack/react-virtual
   ```

2. Create src/components/DetailPane/AnnotationGutter.tsx:

Import useVirtualizer from @tanstack/react-virtual.
Import P4AnnotationLine from lib/tauri.
Import calculateAgeColor from lib/annotationColors.

Props interface AnnotationGutterProps:
  - annotations: P4AnnotationLine[]
  - minTimestamp: number
  - maxTimestamp: number
  - onAnnotationClick?: (changelistId: number) => void
  - containerRef: React.RefObject<HTMLDivElement>
  - highlightedBlockIndex?: number (optional, for keyboard nav highlight)

Component implementation:
  - Use useVirtualizer with:
    - count: annotations.length
    - getScrollElement: () => containerRef.current
    - estimateSize: () => 20 (20px line height)
    - overscan: 10 (render 10 extra lines above/below)

  - Render virtualized list:
    - Outer div: position relative, height = virtualizer.getTotalSize()
    - Inner items: position absolute, transform translateY for positioning
    - Each row shows: CL#{changelistId} | {user} | {date}
    - Background color from calculateAgeColor based on line's date
    - onClick calls onAnnotationClick with changelistId
    - Add cursor-pointer and hover:bg-accent/50 for interactivity
    - If highlightedBlockIndex provided, add ring-2 ring-primary to highlighted lines

  - Format dates: Show date as-is (YYYY/MM/DD is already readable)
  - Gutter width: w-64 (256px) to fit CL#, user, and date
  - Text: text-xs font-mono for consistent monospace alignment
  </action>
  <verify>
  - npm list @tanstack/react-virtual shows installed version
  - npm run build passes without TypeScript errors
  </verify>
  <done>
  - @tanstack/react-virtual installed
  - AnnotationGutter renders virtualized list with heatmap colors
  - Click handler wired for changelist navigation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FileAnnotationViewer and integrate into RevisionDetailView</name>
  <files>src/components/DetailPane/FileAnnotationViewer.tsx, src/components/DetailPane/RevisionDetailView.tsx</files>
  <action>
Create src/components/DetailPane/FileAnnotationViewer.tsx:

Imports:
  - useRef from react
  - useFileAnnotations from hooks/useFileAnnotations
  - useFileInfo from hooks/useFileInfo (for size validation, reuse from Phase 16)
  - AnnotationGutter from ./AnnotationGutter
  - Highlight, themes from prism-react-renderer
  - getLanguageFromPath from lib/languageMap
  - Loader2, AlertTriangle from lucide-react
  - Button from components/ui/button

Props interface FileAnnotationViewerProps:
  - depotPath: string
  - revision: number
  - onChangelistClick?: (changelistId: number) => void

Component implementation:
1. Size validation (reuse pattern from FileContentViewer):
   - Use useFileInfo to check file size and type
   - Max size: 10MB (same as file content viewer)
   - Reject binary files with helpful message
   - Show "Large file warning" for files 1-10MB with "Load Anyway" button

2. Fetch annotations:
   - Use useFileAnnotations hook
   - Only enabled after size validation passes
   - Show loading spinner while fetching

3. Calculate timestamp range for heatmap:
   - Parse dates from annotations: new Date(date.replace(/\//g, '-')).getTime()
   - Find minTimestamp and maxTimestamp
   - Pass to AnnotationGutter for color calculation

4. Layout structure (side-by-side gutter + code):
   - containerRef for scroll sync
   - Outer div: h-[600px] overflow-auto (same max height as FileContentViewer)
   - Flex row: gutter (w-64 flex-shrink-0) | code (flex-1)
   - Single scroll container for synchronized scrolling

5. Code display:
   - Use prism-react-renderer Highlight component
   - Same theme (vsDark) and styling as SyntaxHighlightedContent
   - Show line numbers (like SyntaxHighlightedContent)
   - Each code line should align with corresponding gutter line (20px height)

6. Error handling:
   - Show error message with retry button if annotations fail to load
   - Handle empty annotations array gracefully

Update src/components/DetailPane/RevisionDetailView.tsx:

1. Add showAnnotations state (boolean, default false)
2. Add toggleAnnotations handler
3. Add "View Annotations" button next to existing "View File Content" button:
   - Button text: showAnnotations ? "Hide Annotations" : "View Annotations"
   - variant="outline", size="sm"
   - onClick={toggleAnnotations}

4. Add FileAnnotationViewer render below action buttons:
   - Only render when showAnnotations is true
   - Pass depotPath, revision.rev
   - Pass onChangelistClick that navigates to changelist detail:
     - Import useDetailPaneStore
     - Import useQuery for fetching changelist
     - For now, console.log the changelistId (full navigation in Plan 03)

5. When showAnnotations, hide showContent viewer (mutual exclusivity):
   - User sees either file content OR annotations, not both
   - Both buttons remain visible
  </action>
  <verify>
  - npm run build passes
  - RevisionDetailView renders both "View File Content" and "View Annotations" buttons
  </verify>
  <done>
  - FileAnnotationViewer displays annotations with heatmap-colored gutter
  - RevisionDetailView has toggle for annotations view
  - Virtualized rendering handles large files smoothly
  - Size validation prevents loading oversized files
  </done>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. npm list @tanstack/react-virtual shows version ^3.x
3. View a file revision, click "View Annotations" shows blame view
4. Annotation gutter shows CL#, user, date per line
5. Heatmap colors visible (blue for old, red for recent)
6. Scrolling is smooth for files with 500+ lines
</verification>

<success_criteria>
- User can toggle "View Annotations" to see per-line blame data
- Each line shows changelist, author, and date
- Heatmap coloring reflects code age
- Virtualization prevents performance issues on large files
- Size validation protects against memory exhaustion
</success_criteria>

<output>
After completion, create `.planning/phases/17-file-annotations/17-02-SUMMARY.md`
</output>
