---
phase: 18-table-stakes-ui-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/treeBuilder.ts
  - src/components/FileTree/FileNode.tsx
autonomous: true

must_haves:
  truths:
    - "File tree shows orange arrow overlay on out-of-date files"
    - "Folder shows out-of-date overlay if any descendant file is out-of-date"
    - "Out-of-date status visible without expanding folders"
  artifacts:
    - path: "src/utils/treeBuilder.ts"
      provides: "FileTreeNode with hasOutOfDateDescendants boolean and outOfDateCount number"
      contains: "hasOutOfDateDescendants"
    - path: "src/components/FileTree/FileNode.tsx"
      provides: "Out-of-date icon overlay on files and folders"
      contains: "ArrowDown"
  key_links:
    - from: "src/utils/treeBuilder.ts"
      to: "FileStatus.OutOfDate"
      via: "aggregateSyncStatus function"
      pattern: "FileStatus\\.OutOfDate"
    - from: "src/components/FileTree/FileNode.tsx"
      to: "hasOutOfDateDescendants"
      via: "icon overlay conditional"
      pattern: "hasOutOfDateDescendants"
---

<objective>
Add sync status overlays to file tree showing which files and folders are out-of-date.

Purpose: Satisfies SYNC-01, SYNC-02, SYNC-03 requirements. Users can instantly see which files need syncing without expanding folders.

Output: Visual orange arrow overlays on out-of-date files and folders containing out-of-date files.
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-table-stakes-ui-features/18-RESEARCH.md

# Existing patterns to follow
@src/utils/treeBuilder.ts — Tree building with FileTreeNode interface
@src/components/FileTree/FileNode.tsx — Icon overlay pattern (AlertTriangle for conflicts)
@src/components/FileTree/useFileTree.ts — mapP4FileInfo sets FileStatus.OutOfDate when revision < head_revision
@src/types/p4.ts — FileStatus enum
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend FileTreeNode and add sync status aggregation</name>
  <files>src/utils/treeBuilder.ts</files>
  <action>
Extend the FileTreeNode interface with sync status metadata:
```typescript
export interface FileTreeNode {
  id: string;
  name: string;
  isFolder: boolean;
  file?: P4File;
  children?: FileTreeNode[];
  // NEW: Sync status for folder aggregation
  hasOutOfDateDescendants?: boolean;  // True if any descendant file is out-of-date
  outOfDateCount?: number;            // Count of out-of-date files in subtree
}
```

Add import for FileStatus from '@/types/p4'.

Add aggregateSyncStatus function after buildFileTree that recursively computes folder status:
```typescript
/**
 * Recursively aggregate sync status from files up to folders
 * Folders are marked as having out-of-date descendants if any child file or folder has out-of-date files
 */
function aggregateSyncStatus(node: FileTreeNode): void {
  if (!node.isFolder || !node.children || node.children.length === 0) {
    return;
  }

  // Process children first (bottom-up traversal)
  node.children.forEach(aggregateSyncStatus);

  // Aggregate: folder has out-of-date descendants if any child does
  let outOfDateCount = 0;
  let hasOutOfDate = false;

  for (const child of node.children) {
    if (child.isFolder) {
      if (child.hasOutOfDateDescendants) {
        hasOutOfDate = true;
      }
      outOfDateCount += child.outOfDateCount || 0;
    } else if (child.file?.status === FileStatus.OutOfDate) {
      hasOutOfDate = true;
      outOfDateCount += 1;
    }
  }

  node.hasOutOfDateDescendants = hasOutOfDate;
  node.outOfDateCount = outOfDateCount;
}
```

Call aggregateSyncStatus on each root node at the end of buildFileTree, before the return statement:
```typescript
const result = rootNode.children || [];
result.forEach(aggregateSyncStatus);
return result;
```
  </action>
  <verify>TypeScript compiles without errors: `npm run build`</verify>
  <done>FileTreeNode interface extended with hasOutOfDateDescendants and outOfDateCount, aggregateSyncStatus function implemented and called during tree build</done>
</task>

<task type="auto">
  <name>Task 2: Add out-of-date icon overlay to FileNode</name>
  <files>src/components/FileTree/FileNode.tsx</files>
  <action>
Add ArrowDown to the lucide-react import (alongside existing FolderOpen, Folder, File, AlertTriangle).

Extend FileNodeData interface with sync status fields:
```typescript
export interface FileNodeData {
  id: string;
  name: string;
  isFolder: boolean;
  file?: P4File;
  children?: FileNodeData[];
  onContextMenu?: (event: React.MouseEvent, file: P4File) => void;
  dimmed?: boolean;
  highlightRanges?: [number, number][];
  // NEW: Sync status for folder overlay
  hasOutOfDateDescendants?: boolean;
  outOfDateCount?: number;
}
```

In the FileNode component, extract the new fields from node.data alongside existing fields:
```typescript
const { name, isFolder, file, onContextMenu, dimmed, highlightRanges, hasOutOfDateDescendants } = node.data;
```

Determine if out-of-date overlay should show:
```typescript
// Show out-of-date indicator for files that are out-of-date, or folders with out-of-date descendants
const showOutOfDate = isFolder
  ? hasOutOfDateDescendants
  : file?.status === FileStatus.OutOfDate;
```

Add import for FileStatus from '@/types/p4'.

Modify the folder icon rendering to include overlay (currently folders have no overlay). Wrap the folder icon in a relative div and add conditional ArrowDown overlay:
```tsx
{isFolder ? (
  <div className="relative flex-shrink-0">
    {isOpen ? (
      <FolderOpen className="w-4 h-4 text-muted-foreground" />
    ) : (
      <Folder className="w-4 h-4 text-muted-foreground" />
    )}
    {/* Out-of-date overlay for folders */}
    {showOutOfDate && (
      <ArrowDown className="w-3 h-3 text-orange-500 absolute -bottom-1 -right-1" />
    )}
  </div>
) : (
  <div className="relative flex-shrink-0">
    <File className="w-4 h-4 text-muted-foreground" />
    {/* Conflict overlay icon */}
    {isConflicted && (
      <AlertTriangle className="w-3 h-3 text-yellow-500 absolute -bottom-1 -right-1" />
    )}
    {/* Out-of-date overlay for files (only if not conflicted) */}
    {!isConflicted && showOutOfDate && (
      <ArrowDown className="w-3 h-3 text-orange-500 absolute -bottom-1 -right-1" />
    )}
  </div>
)}
```

Note: Conflict overlay takes precedence over out-of-date overlay for files. Folders only show out-of-date overlay (no conflict state for folders).
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles.
Manually verify in dev mode that:
1. Files with status OutOfDate show orange ArrowDown icon overlay
2. Folders containing out-of-date files show orange ArrowDown overlay
3. Expanding a folder does not change the overlay visibility
4. Conflict icon still takes precedence for conflicted files
  </verify>
  <done>FileNode displays orange ArrowDown overlay on out-of-date files and folders with out-of-date descendants</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. File tree shows orange arrow overlay on individual out-of-date files
3. Folders with out-of-date children show orange arrow overlay without expanding
4. Conflict overlay (yellow triangle) still takes precedence for conflicted files
5. Opening/closing folders does not change sync status display
</verification>

<success_criteria>
- SYNC-01: File tree shows icon overlay indicating out-of-date files (orange ArrowDown)
- SYNC-02: Sync status compares have-rev vs head-rev (existing logic in useFileTree)
- SYNC-03: Sync status visible in tree without expanding folders (aggregation bubbles up)
</success_criteria>

<output>
After completion, create `.planning/phases/18-table-stakes-ui-features/18-01-SUMMARY.md`
</output>
