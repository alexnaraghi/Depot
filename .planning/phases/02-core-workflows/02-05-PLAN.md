---
phase: 02-core-workflows
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-04"]
files_modified:
  - src/components/FileTree/FileTree.tsx
  - src/components/FileTree/useFileTree.ts
  - src/components/FileTree/FileContextMenu.tsx
autonomous: true

must_haves:
  truths:
    - "File tree displays workspace files in hierarchical view"
    - "User can expand/collapse folders"
    - "User can right-click file for context menu"
    - "Context menu offers checkout, revert, sync options"
  artifacts:
    - path: "src/components/FileTree/FileTree.tsx"
      provides: "File tree component"
      exports: ["FileTree"]
    - path: "src/components/FileTree/useFileTree.ts"
      provides: "File tree data loading hook"
      exports: ["useFileTree"]
    - path: "src/components/FileTree/FileContextMenu.tsx"
      provides: "Context menu component"
      exports: ["FileContextMenu"]
  key_links:
    - from: "src/components/FileTree/FileTree.tsx"
      to: "react-arborist"
      via: "Tree component"
      pattern: "import.*Tree.*from.*react-arborist"
    - from: "src/components/FileTree/FileTree.tsx"
      to: "src/components/FileTree/FileNode.tsx"
      via: "node renderer"
      pattern: "FileNode"
    - from: "src/components/FileTree/useFileTree.ts"
      to: "src/stores/fileTreeStore.ts"
      via: "store subscription"
      pattern: "useFileTreeStore"
---

<objective>
Create the workspace file tree component using react-arborist with context menu for file operations.

Purpose: The file tree is the primary workspace view, showing all files with their status. Users interact with files through the context menu (checkout, revert) and toolbar (sync).

Output: FileTree component with virtualized rendering, context menu, and file operation integration.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-workflows/02-CONTEXT.md
@.planning/phases/02-core-workflows/02-RESEARCH.md
@src/components/FileTree/FileNode.tsx
@src/components/FileTree/FileStatusIcon.tsx
@src/stores/fileTreeStore.ts
@src/utils/treeBuilder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFileTree hook for data loading</name>
  <files>src/components/FileTree/useFileTree.ts</files>
  <action>
Create hook that loads and manages file tree data:

```typescript
import { useEffect, useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { useFileTreeStore } from '@/stores/fileTreeStore';
import { invokeP4Fstat } from '@/lib/tauri';
import { buildFileTree, FileTreeNode } from '@/utils/treeBuilder';

export function useFileTree() {
  const { files, setFiles, rootPath, setRootPath } = useFileTreeStore();

  // Load files from p4 fstat
  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['p4', 'fstat', rootPath],
    queryFn: async () => {
      // If no rootPath, first get workspace root from p4 info or p4 client
      const result = await invokeP4Fstat([]);
      return result;
    },
    enabled: true,
    refetchOnWindowFocus: false,
    staleTime: 30000, // 30 seconds
  });

  // Update store when data changes
  useEffect(() => {
    if (data) {
      // Convert P4FileInfo to P4File and set in store
      const p4Files = data.map(info => ({
        depotPath: info.depot_path,
        localPath: info.local_path,
        status: mapStatus(info.status, info.action),
        action: info.action,
        revision: info.revision,
        headRevision: info.head_revision,
        changelist: info.changelist,
        fileType: info.file_type,
        isDirectory: false,
      }));
      setFiles(p4Files);
    }
  }, [data, setFiles]);

  // Build tree from store files
  const treeData = useMemo(() => {
    if (files.size === 0) return [];
    const fileArray = Array.from(files.values());
    return buildFileTree(fileArray, rootPath || '//');
  }, [files, rootPath]);

  return {
    treeData,
    isLoading,
    error,
    refetch,
  };
}

// Helper to map backend status string to FileStatus enum
function mapStatus(status: string, action?: string): FileStatus {
  if (action) {
    switch (action) {
      case 'edit': return 'checkedOut';
      case 'add': return 'added';
      case 'delete': return 'deleted';
      default: return 'checkedOut';
    }
  }
  switch (status) {
    case 'synced': return 'synced';
    case 'outOfDate': return 'outOfDate';
    case 'modified': return 'modified';
    default: return 'synced';
  }
}
```

Key points:
- Use TanStack Query for caching and refetch
- Build tree in useMemo to avoid recalculation
- Map backend types to frontend types
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/FileTree/useFileTree.ts`</verify>
  <done>useFileTree loads data, updates store, and returns tree structure</done>
</task>

<task type="auto">
  <name>Task 2: Create FileContextMenu component</name>
  <files>src/components/FileTree/FileContextMenu.tsx</files>
  <action>
Create context menu for file operations:

```typescript
import { useCallback, useEffect, useState } from 'react';
import { Edit3, RotateCcw, RefreshCw, FolderSync, Copy } from 'lucide-react';
import { useFileOperations } from '@/hooks/useFileOperations';
import { P4File } from '@/types/p4';
import { cn } from '@/lib/utils';

interface FileContextMenuProps {
  file: P4File | null;
  position: { x: number; y: number } | null;
  onClose: () => void;
}

export function FileContextMenu({ file, position, onClose }: FileContextMenuProps) {
  const { checkout, revert } = useFileOperations();

  // Close on click outside or Escape
  useEffect(() => {
    const handleClick = () => onClose();
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
    };

    document.addEventListener('click', handleClick);
    document.addEventListener('keydown', handleEscape);
    return () => {
      document.removeEventListener('click', handleClick);
      document.removeEventListener('keydown', handleEscape);
    };
  }, [onClose]);

  if (!file || !position) return null;

  const handleCheckout = async (e: React.MouseEvent) => {
    e.stopPropagation();
    await checkout([file.depotPath]);
    onClose();
  };

  const handleRevert = async (e: React.MouseEvent) => {
    e.stopPropagation();
    await revert([file.depotPath]);
    onClose();
  };

  const handleCopyPath = (e: React.MouseEvent) => {
    e.stopPropagation();
    navigator.clipboard.writeText(file.localPath);
    onClose();
  };

  const canCheckout = file.status === 'synced' || file.status === 'outOfDate';
  const canRevert = file.status === 'checkedOut' || file.status === 'added' || file.status === 'deleted';

  return (
    <div
      className="fixed z-50 min-w-[160px] bg-slate-800 border border-slate-700 rounded-md shadow-lg py-1"
      style={{ left: position.x, top: position.y }}
      onClick={(e) => e.stopPropagation()}
    >
      <MenuItem
        icon={<Edit3 className="w-4 h-4" />}
        label="Checkout for Edit"
        onClick={handleCheckout}
        disabled={!canCheckout}
      />
      <MenuItem
        icon={<RotateCcw className="w-4 h-4" />}
        label="Revert"
        onClick={handleRevert}
        disabled={!canRevert}
      />
      <div className="border-t border-slate-700 my-1" />
      <MenuItem
        icon={<Copy className="w-4 h-4" />}
        label="Copy Local Path"
        onClick={handleCopyPath}
      />
    </div>
  );
}

function MenuItem({
  icon,
  label,
  onClick,
  disabled = false,
}: {
  icon: React.ReactNode;
  label: string;
  onClick: (e: React.MouseEvent) => void;
  disabled?: boolean;
}) {
  return (
    <button
      className={cn(
        'w-full px-3 py-1.5 flex items-center gap-2 text-sm text-left',
        disabled
          ? 'text-slate-500 cursor-not-allowed'
          : 'text-slate-200 hover:bg-slate-700'
      )}
      onClick={onClick}
      disabled={disabled}
    >
      {icon}
      {label}
    </button>
  );
}
```

Context menu features:
- Checkout (enabled when synced/outOfDate)
- Revert (enabled when checked out/added/deleted)
- Copy local path to clipboard
- Keyboard support (Escape to close)
- Click outside to close
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/FileTree/FileContextMenu.tsx`</verify>
  <done>FileContextMenu provides checkout, revert, copy operations</done>
</task>

<task type="auto">
  <name>Task 3: Create FileTree component with react-arborist</name>
  <files>src/components/FileTree/FileTree.tsx</files>
  <action>
Create main file tree component:

```typescript
import { useCallback, useRef, useState } from 'react';
import { Tree, TreeApi } from 'react-arborist';
import { useFileTree } from './useFileTree';
import { FileNode } from './FileNode';
import { FileContextMenu } from './FileContextMenu';
import { FileTreeNode } from '@/utils/treeBuilder';
import { P4File } from '@/types/p4';

interface FileTreeProps {
  className?: string;
  height?: number;
}

export function FileTree({ className, height = 600 }: FileTreeProps) {
  const { treeData, isLoading, error, refetch } = useFileTree();
  const treeRef = useRef<TreeApi<FileTreeNode>>(null);

  // Context menu state
  const [contextMenu, setContextMenu] = useState<{
    file: P4File | null;
    position: { x: number; y: number } | null;
  }>({ file: null, position: null });

  const handleContextMenu = useCallback((
    e: React.MouseEvent,
    node: FileTreeNode
  ) => {
    e.preventDefault();
    if (!node.isFolder && node.file) {
      setContextMenu({
        file: node.file,
        position: { x: e.clientX, y: e.clientY },
      });
    }
  }, []);

  const closeContextMenu = useCallback(() => {
    setContextMenu({ file: null, position: null });
  }, []);

  // Loading state
  if (isLoading) {
    return (
      <div className={cn('flex items-center justify-center', className)} style={{ height }}>
        <div className="text-slate-400">Loading workspace...</div>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className={cn('flex flex-col items-center justify-center gap-2', className)} style={{ height }}>
        <div className="text-red-400">Failed to load workspace</div>
        <button
          onClick={() => refetch()}
          className="px-3 py-1 text-sm bg-slate-700 hover:bg-slate-600 rounded"
        >
          Retry
        </button>
      </div>
    );
  }

  // Empty state
  if (treeData.length === 0) {
    return (
      <div className={cn('flex items-center justify-center', className)} style={{ height }}>
        <div className="text-slate-400">No files in workspace</div>
      </div>
    );
  }

  return (
    <div className={className}>
      <Tree
        ref={treeRef}
        data={treeData}
        width="100%"
        height={height}
        indent={20}
        rowHeight={28}
        overscanCount={10}
        openByDefault={false}
        selectionFollowsFocus
      >
        {(props) => (
          <FileNode
            {...props}
            onContextMenu={(e) => handleContextMenu(e, props.node.data)}
          />
        )}
      </Tree>

      <FileContextMenu
        file={contextMenu.file}
        position={contextMenu.position}
        onClose={closeContextMenu}
      />
    </div>
  );
}
```

Features:
- Virtualized rendering (react-arborist handles this)
- Loading, error, and empty states
- Context menu on right-click (files only, not folders)
- Proper height management
- Selection follows focus for keyboard navigation

Update FileNode to accept onContextMenu prop:
```typescript
// In FileNode.tsx, add onContextMenu to props and wire to div
<div
  style={style}
  ref={dragHandle}
  className={...}
  onContextMenu={onContextMenu}
>
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/FileTree/FileTree.tsx`</verify>
  <done>FileTree renders workspace with virtualization, selection, and context menu</done>
</task>

</tasks>

<verification>
- FileTree renders without errors when data present
- Loading/error/empty states display correctly
- Context menu appears on right-click of file
- Folders expand/collapse correctly
- Tree is virtualized (only renders visible rows)
</verification>

<success_criteria>
- User can view workspace files in hierarchical tree
- User can expand/collapse folders
- User can right-click file for context menu with checkout/revert options
- Tree handles large file counts without performance issues
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-workflows/02-05-SUMMARY.md`
</output>
