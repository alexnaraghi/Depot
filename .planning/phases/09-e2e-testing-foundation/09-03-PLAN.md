---
phase: 09-e2e-testing-foundation
plan: 03
type: execute
wave: 1
depends_on: ["09-01"]
files_modified:
  - e2e/wdio.conf.ts
  - e2e/test/helpers/seed-settings.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests auto-connect to P4 server without manual login"
    - "P4 credentials are read from environment variables (P4E2E_PORT, P4E2E_USER, P4E2E_CLIENT)"
    - "Settings are pre-seeded into Tauri plugin-store settings.json before app launches"
  artifacts:
    - path: "e2e/test/helpers/seed-settings.ts"
      provides: "Writes P4 connection settings to Tauri store file before app launch"
    - path: "e2e/wdio.conf.ts"
      provides: "Updated onPrepare hook that seeds settings before spawning app"
---

<objective>
Pre-seed the Tauri plugin-store settings.json with P4 connection credentials so E2E tests auto-connect on app startup without manual login.

Purpose: Without this, all E2E tests fail because the app starts disconnected and has no automated way to configure the P4 connection.
Output: A settings seeding helper and updated wdio config that reads P4 credentials from environment variables and writes them to the Tauri store before launching the app.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/09-e2e-testing-foundation/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings seeding helper and update wdio config</name>
  <files>
    e2e/test/helpers/seed-settings.ts
    e2e/wdio.conf.ts
  </files>
  <action>
The app uses Tauri's plugin-store which persists to a JSON file at:
- Windows: `%APPDATA%\com.a.p4now\settings.json`

The store format (from @tauri-apps/plugin-store) is a simple JSON object with key-value pairs.

**e2e/test/helpers/seed-settings.ts:**

Create a helper that:
1. Reads env vars: `P4E2E_PORT`, `P4E2E_USER`, `P4E2E_CLIENT`
2. Validates all three are set (throw clear error if missing)
3. Writes a `settings.json` file to the Tauri store location with the P4 connection settings
4. The store file format is a plain JSON object with string keys and values

The Tauri plugin-store JSON format is:
```json
{
  "p4port": "ssl:perforce:1666",
  "p4user": "jdoe",
  "p4client": "jdoe-workspace",
  "diffToolPath": "",
  "diffToolArgs": "",
  "verboseLogging": false
}
```

Export an async function `seedSettings()` that does this.

**e2e/wdio.conf.ts:**

Update the `onPrepare` hook to:
1. Call `seedSettings()` BEFORE spawning tauri-driver
2. Import the helper at the top of the file

Also add env var documentation to the prerequisites comment block.
  </action>
  <verify>
    - `npx tsc --project e2e/tsconfig.json --noEmit` compiles without errors
    - File exists: `ls e2e/test/helpers/seed-settings.ts`
    - Setting env vars and running `npm run test:e2e` should auto-connect
  </verify>
  <done>
    E2E tests auto-connect to P4 server via pre-seeded settings. No manual login required.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --project e2e/tsconfig.json --noEmit` â€” compiles
2. With P4E2E_PORT, P4E2E_USER, P4E2E_CLIENT env vars set, `npm run test:e2e` auto-connects
3. Without env vars, clear error message is shown
</verification>

<success_criteria>
- Settings seeding helper writes valid Tauri store JSON
- wdio onPrepare seeds settings before app launch
- E2E tests connect automatically when env vars are set
- Clear error when env vars are missing
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-testing-foundation/09-03-SUMMARY.md`
</output>
