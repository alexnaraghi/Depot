---
phase: 02-core-workflows
plan: 07
type: execute
wave: 4
depends_on: ["02-03", "02-05"]
files_modified:
  - src/components/SyncToolbar.tsx
  - src/components/dialogs/SyncConflictDialog.tsx
  - src/hooks/useSync.ts
autonomous: true

must_haves:
  truths:
    - "User can click Sync button to sync entire workspace"
    - "User sees file-by-file progress during sync"
    - "On conflict, sync stops and shows dialog for user decision"
    - "User can cancel sync while in progress"
  artifacts:
    - path: "src/components/SyncToolbar.tsx"
      provides: "Sync button toolbar"
      exports: ["SyncToolbar"]
    - path: "src/components/dialogs/SyncConflictDialog.tsx"
      provides: "Conflict resolution dialog"
      exports: ["SyncConflictDialog"]
    - path: "src/hooks/useSync.ts"
      provides: "Sync operation hook"
      exports: ["useSync"]
  key_links:
    - from: "src/hooks/useSync.ts"
      to: "src/lib/tauri.ts"
      via: "invokeP4Sync"
      pattern: "invokeP4Sync"
    - from: "src/hooks/useSync.ts"
      to: "src/store/operation.ts"
      via: "operation tracking"
      pattern: "useOperationStore"
    - from: "src/components/SyncToolbar.tsx"
      to: "src/hooks/useSync.ts"
      via: "sync action"
      pattern: "useSync"
---

<objective>
Implement the sync workflow with progress streaming, conflict detection, and user decision dialog.

Purpose: Syncing is a core operation that must show progress without freezing the UI. When conflicts occur (local edits vs depot changes), the user needs to decide how to proceed.

Output: SyncToolbar with sync button, useSync hook with progress handling, SyncConflictDialog for conflict resolution.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-workflows/02-CONTEXT.md
@src/store/operation.ts
@src/hooks/useP4Command.ts
@src/lib/tauri.ts
@src/components/OutputPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSync hook with progress streaming</name>
  <files>src/hooks/useSync.ts</files>
  <action>
Create hook for sync operations with progress and conflict handling:

```typescript
import { useCallback, useState } from 'react';
import { useOperationStore } from '@/store/operation';
import { useFileTreeStore } from '@/stores/fileTreeStore';
import { invokeP4Sync, invokeKillProcess, SyncProgress } from '@/lib/tauri';
import toast from 'react-hot-toast';

interface SyncState {
  isRunning: boolean;
  processId: string | null;
  currentFile: string | null;
  filesUpdated: number;
  conflict: SyncConflict | null;
}

interface SyncConflict {
  depotPath: string;
  action: string;
  revision: number;
}

export function useSync() {
  const {
    startOperation,
    updateMessage,
    updateProgress,
    setCancelling,
    completeOperation,
    addOutputLine,
  } = useOperationStore();
  const { updateFile } = useFileTreeStore();

  const [syncState, setSyncState] = useState<SyncState>({
    isRunning: false,
    processId: null,
    currentFile: null,
    filesUpdated: 0,
    conflict: null,
  });

  const sync = useCallback(async (paths: string[] = []) => {
    const operationId = `sync-${Date.now()}`;
    const displayPath = paths.length > 0 ? paths.join(', ') : 'workspace';

    setSyncState({
      isRunning: true,
      processId: null,
      currentFile: null,
      filesUpdated: 0,
      conflict: null,
    });

    startOperation(operationId, `Syncing ${displayPath}`);

    try {
      let filesUpdated = 0;
      let conflict: SyncConflict | null = null;

      const processId = await invokeP4Sync(paths, (progress: SyncProgress) => {
        // Update operation message with current file
        const fileName = progress.depot_path.split('/').pop() || progress.depot_path;
        updateMessage(`Syncing: ${fileName} #${progress.revision}`);
        addOutputLine(
          `${progress.action} ${progress.depot_path}#${progress.revision}`,
          false
        );

        if (progress.is_conflict) {
          // Conflict detected - store for dialog
          conflict = {
            depotPath: progress.depot_path,
            action: progress.action,
            revision: progress.revision,
          };
          setSyncState((prev) => ({
            ...prev,
            conflict,
          }));
        } else {
          filesUpdated++;
          setSyncState((prev) => ({
            ...prev,
            currentFile: progress.depot_path,
            filesUpdated,
          }));

          // Update file status in store (now synced)
          updateFile(progress.depot_path, {
            status: 'synced',
            revision: progress.revision,
            headRevision: progress.revision,
          });
        }
      });

      setSyncState((prev) => ({ ...prev, processId }));

      // If no conflict, complete successfully
      if (!conflict) {
        completeOperation(true);
        toast.success(`Synced ${filesUpdated} file(s)`);
      }
      // If conflict, don't complete - let dialog handle it

      setSyncState((prev) => ({
        ...prev,
        isRunning: !conflict, // Keep running if conflict (waiting for resolution)
      }));

      return { filesUpdated, conflict };
    } catch (error) {
      completeOperation(false, String(error));
      toast.error(`Sync failed: ${error}`);
      setSyncState((prev) => ({ ...prev, isRunning: false }));
      throw error;
    }
  }, [startOperation, updateMessage, addOutputLine, completeOperation, updateFile]);

  const cancel = useCallback(async () => {
    if (!syncState.processId) return;

    setCancelling();
    try {
      await invokeKillProcess(syncState.processId);
      completeOperation(false, 'Sync cancelled');
      toast.success('Sync cancelled');
    } catch (error) {
      completeOperation(false, `Cancel failed: ${error}`);
    }
    setSyncState((prev) => ({ ...prev, isRunning: false, processId: null }));
  }, [syncState.processId, setCancelling, completeOperation]);

  const resolveConflict = useCallback((action: 'skip' | 'force') => {
    // Clear conflict and allow sync to continue or stop
    setSyncState((prev) => ({
      ...prev,
      conflict: null,
      isRunning: false,
    }));

    if (action === 'skip') {
      completeOperation(true, `Sync completed, skipped conflicting file`);
    } else {
      // Force would require p4 sync -f, which is a separate operation
      // For now, just mark as needing manual resolution
      toast.info('Force sync not implemented - resolve conflict manually');
      completeOperation(false, 'Conflict requires manual resolution');
    }
  }, [completeOperation]);

  return {
    sync,
    cancel,
    resolveConflict,
    isRunning: syncState.isRunning,
    canCancel: syncState.isRunning && !!syncState.processId,
    conflict: syncState.conflict,
    filesUpdated: syncState.filesUpdated,
    currentFile: syncState.currentFile,
  };
}
```

Key points:
- Streams progress to operation store and output panel
- Updates file tree store after each file syncs
- Detects conflicts from progress events
- Supports cancellation via process kill
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/hooks/useSync.ts`</verify>
  <done>useSync provides sync, cancel, and conflict resolution with progress tracking</done>
</task>

<task type="auto">
  <name>Task 2: Create SyncConflictDialog component</name>
  <files>src/components/dialogs/SyncConflictDialog.tsx</files>
  <action>
Create conflict resolution dialog:

```typescript
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { AlertTriangle } from 'lucide-react';

interface SyncConflictDialogProps {
  open: boolean;
  depotPath: string;
  action: string;
  revision: number;
  onResolve: (action: 'skip' | 'force') => void;
}

export function SyncConflictDialog({
  open,
  depotPath,
  action,
  revision,
  onResolve,
}: SyncConflictDialogProps) {
  const fileName = depotPath.split('/').pop() || depotPath;

  return (
    <AlertDialog open={open}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <div className="flex items-center gap-2">
            <AlertTriangle className="w-5 h-5 text-yellow-500" />
            <AlertDialogTitle>Sync Conflict Detected</AlertDialogTitle>
          </div>
          <AlertDialogDescription className="space-y-2">
            <p>
              The file <strong className="text-slate-200">{fileName}</strong> has
              local changes that would be overwritten by syncing.
            </p>
            <p className="text-sm text-slate-400">
              Depot path: {depotPath}
              <br />
              Server action: {action}
              <br />
              Server revision: #{revision}
            </p>
            <p>
              Choose how to proceed:
            </p>
          </AlertDialogDescription>
        </AlertDialogHeader>

        <AlertDialogFooter className="flex-col sm:flex-row gap-2">
          <AlertDialogCancel onClick={() => onResolve('skip')}>
            Skip This File
          </AlertDialogCancel>
          <AlertDialogAction
            onClick={() => onResolve('force')}
            className="bg-red-600 hover:bg-red-700"
          >
            Overwrite Local Changes
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

Dialog shows:
- Warning icon and title
- File name and path
- What the server wants to do
- Two options: Skip or Overwrite
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/dialogs/SyncConflictDialog.tsx`</verify>
  <done>SyncConflictDialog displays conflict info and resolution options</done>
</task>

<task type="auto">
  <name>Task 3: Create SyncToolbar component</name>
  <files>src/components/SyncToolbar.tsx</files>
  <action>
Create toolbar with sync button and cancel support:

```typescript
import { RefreshCw, X } from 'lucide-react';
import { useSync } from '@/hooks/useSync';
import { SyncConflictDialog } from '@/components/dialogs/SyncConflictDialog';
import { cn } from '@/lib/utils';

interface SyncToolbarProps {
  className?: string;
  selectedPaths?: string[]; // For folder-level sync
}

export function SyncToolbar({ className, selectedPaths }: SyncToolbarProps) {
  const {
    sync,
    cancel,
    resolveConflict,
    isRunning,
    canCancel,
    conflict,
    filesUpdated,
    currentFile,
  } = useSync();

  const handleSync = async () => {
    try {
      await sync(selectedPaths || []);
    } catch (error) {
      // Error already handled by hook
    }
  };

  return (
    <>
      <div className={cn('flex items-center gap-2', className)}>
        {/* Sync button */}
        <button
          onClick={handleSync}
          disabled={isRunning}
          className={cn(
            'flex items-center gap-2 px-4 py-2 rounded transition-colors',
            isRunning
              ? 'bg-slate-700 text-slate-400 cursor-not-allowed'
              : 'bg-blue-600 hover:bg-blue-700 text-white'
          )}
        >
          <RefreshCw className={cn('w-4 h-4', isRunning && 'animate-spin')} />
          {isRunning ? 'Syncing...' : 'Sync'}
        </button>

        {/* Cancel button (only when running) */}
        {canCancel && (
          <button
            onClick={cancel}
            className="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors"
          >
            <X className="w-4 h-4" />
            Cancel
          </button>
        )}

        {/* Progress indicator */}
        {isRunning && (
          <span className="text-sm text-slate-400">
            {filesUpdated} files updated
            {currentFile && (
              <span className="ml-2 text-slate-500 truncate max-w-[200px] inline-block align-bottom">
                {currentFile.split('/').pop()}
              </span>
            )}
          </span>
        )}
      </div>

      {/* Conflict dialog */}
      {conflict && (
        <SyncConflictDialog
          open={!!conflict}
          depotPath={conflict.depotPath}
          action={conflict.action}
          revision={conflict.revision}
          onResolve={resolveConflict}
        />
      )}
    </>
  );
}
```

Features:
- Sync button with loading state
- Spinning icon during sync
- Cancel button appears when syncing
- Progress counter (files updated)
- Current file name display
- Conflict dialog integration
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/SyncToolbar.tsx`</verify>
  <done>SyncToolbar provides sync/cancel buttons with progress display</done>
</task>

</tasks>

<verification>
- Sync button starts sync operation
- Progress updates show in toolbar and output panel
- Cancel button terminates sync
- Conflict dialog appears when conflict detected
- File tree updates after each synced file
</verification>

<success_criteria>
- User can sync entire workspace with one click
- User sees real-time progress during sync
- User can cancel sync at any time
- Conflicts are detected and shown in dialog for user decision
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-workflows/02-07-SUMMARY.md`
</output>
