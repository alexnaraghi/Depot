---
phase: 08-visual-polish
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/MainLayout.tsx
  - src/components/SyncToolbar.tsx
autonomous: false

must_haves:
  truths:
    - "Single unified header bar replaces the two existing header bars"
    - "Left section shows Repository and Stream with labels above values"
    - "Center section has GitKraken-style icon-above-text action buttons"
    - "Right section has search, connection status, and settings"
    - "Context-sensitive buttons (Checkout, Revert, Diff) grey out when no file selected"
    - "P4Now text is removed from header"
  artifacts:
    - path: "src/components/MainLayout.tsx"
      provides: "Unified single-bar header layout"
    - path: "src/components/SyncToolbar.tsx"
      provides: "Refactored toolbar content integrated into unified header"
  key_links:
    - from: "src/components/MainLayout.tsx"
      to: "SyncToolbar action buttons"
      via: "Inline toolbar buttons in center section"
      pattern: "flex-col items-center.*icon.*text"
---

<objective>
Consolidate the two existing header bars (info bar + SyncToolbar) into a single unified toolbar with left (context info), center (action buttons), and right (utilities) sections, following GitKraken-style layout.

Purpose: The unified toolbar is the most visible visual change — it transforms the app from looking like a prototype to a professional tool.
Output: Single header bar with GitKraken-style icon-above-text buttons and context info.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-visual-polish/08-CONTEXT.md
@.planning/phases/08-visual-polish/08-RESEARCH.md
@.planning/phases/08-visual-polish/08-01-SUMMARY.md

@src/components/MainLayout.tsx
@src/components/SyncToolbar.tsx
@src/components/ConnectionStatus.tsx
@src/components/SearchBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consolidate two header bars into single unified toolbar</name>
  <files>src/components/MainLayout.tsx, src/components/SyncToolbar.tsx</files>
  <action>
Replace the current two-bar header (lines 122-152 in MainLayout.tsx: the info bar with "P4Now" title + the `<SyncToolbar />` component) with a single unified header bar.

**New header structure in MainLayout.tsx:**

```
<header className="bg-slate-900 border-b border-slate-700">
  <div className="flex items-center justify-between px-3 py-1.5">

    {/* LEFT: Repository & Stream info */}
    <div className="flex items-center gap-6">
      <div className="flex flex-col">
        <span className="text-[10px] uppercase tracking-wider text-slate-500">Repository</span>
        <span className="text-sm font-medium text-slate-200">{workspace || 'No workspace'}</span>
      </div>
      {stream && (
        <div className="flex flex-col">
          <span className="text-[10px] uppercase tracking-wider text-slate-500">Stream</span>
          <span className="text-sm font-medium text-slate-200">{stream}</span>
        </div>
      )}
    </div>

    {/* CENTER: Action buttons - GitKraken style (icon above text, no borders) */}
    <div className="flex items-center gap-1">
      {/* Each button: flex-col, icon w-5 h-5, text-[10px], px-3 py-1.5, rounded, hover:bg-slate-800 */}
      {/* Buttons: Refresh, Sync, Reconcile, Add (New CL), Checkout, Revert, Diff */}
      {/* Checkout/Revert/Diff get disabled={!hasSelectedFile} with disabled:opacity-40 disabled:cursor-not-allowed */}
    </div>

    {/* RIGHT: Search, connection status, settings */}
    <div className="flex items-center gap-2">
      <SearchBar />
      <ConnectionStatus />
      <Button variant="ghost" size="icon" onClick={openSettings} title="Settings">
        <Settings className="h-5 w-5" />
      </Button>
    </div>

  </div>
</header>
```

**Action buttons in center section** (move from SyncToolbar into MainLayout directly):
1. **Refresh** — `RefreshCw` icon, calls `queryClient.invalidateQueries()`, title includes shortcut hint
2. **Sync** — `Download` icon (or keep `RefreshCw` with different styling), calls sync handler. Show spinning icon when syncing. Include cancel indicator.
3. **Reconcile** — `FolderSync` icon, opens reconcile dialog
4. **New CL** — `Plus` icon (or `FilePlus`), dispatches `p4now:new-changelist` event
5. **Checkout** — `FileEdit` icon, disabled when no file selected, dispatches checkout event
6. **Revert** — `Undo2` icon, disabled when no file selected, dispatches revert event
7. **Diff** — `GitCompare` (or `FileCode`) icon, disabled when no file selected, dispatches diff event

Each button follows this pattern:
```tsx
<button
  onClick={handler}
  disabled={isDisabled}
  className="flex flex-col items-center gap-0.5 px-3 py-1.5 rounded
             text-slate-400 hover:bg-slate-800 hover:text-slate-200
             disabled:opacity-40 disabled:cursor-not-allowed"
  title={`Action Name (Shortcut)`}
>
  <IconComponent className="w-5 h-5" />
  <span className="text-[10px]">Label</span>
</button>
```

**For context-sensitive disabling:** Track whether a file is selected. Use a simple approach: listen for a custom event `p4now:selection-changed` that the FileTree/ChangelistPanel dispatch when selection changes, or use a lightweight zustand store. The simplest approach: add a `window.__p4nowHasSelection` flag that file tree sets, and read it via a small hook. Or better: create a small `useFileSelection` hook backed by a zustand store that FileTree and ChangelistPanel update.

Actually, the simplest minimal approach: use state in MainLayout, listen for custom events from tree components. FileTree already tracks `selectedFile` — have it dispatch `p4now:selection-changed` with detail. MainLayout listens and updates `hasSelectedFile` state.

**SyncToolbar.tsx changes:**
- Keep the file but refactor it to export only the sync logic/state that MainLayout needs, OR inline the sync button behavior into MainLayout and simplify SyncToolbar to just handle the sync progress display (shown conditionally below the header when syncing).
- The progress display (file count during sync) should appear as a thin bar below the header OR in the status bar, not as a second toolbar row.
- Keep SyncConflictDialog and ReconcilePreviewDialog renders — they can stay in SyncToolbar or move to MainLayout.

**Remove:**
- "P4Now" title text from header
- The separate SyncToolbar bar (the second colored bar below the header)
- Any `transition-colors` or `transition-all` classes (per CONTEXT.md: no animations)

**Keep:**
- All existing keyboard shortcut handlers in MainLayout
- Settings dialog, Command palette renders
- Sidebar collapse/expand behavior unchanged
  </action>
  <verify>Run `npx tsc --noEmit`. Open app — single unified header bar with three sections. Verify all buttons work (refresh, sync, reconcile, new CL). Verify checkout/revert/diff are greyed out when no file is selected.</verify>
  <done>Two header bars consolidated into one. Left shows repo/stream with labels. Center has 7 GitKraken-style icon-text buttons. Right has search/connection/settings. Context-sensitive buttons grey out properly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Unified header toolbar with GitKraken-style layout: left context info, center action buttons (icon above text), right utilities. Context-sensitive greying for Checkout/Revert/Diff.</what-built>
  <how-to-verify>
    1. Open the app — confirm single header bar (not two rows)
    2. Left side: Repository label above workspace name, Stream label above stream name, no "P4Now" text
    3. Center: 7 buttons with icons above text labels (Refresh, Sync, Reconcile, New CL, Checkout, Revert, Diff)
    4. Right: Search bar, connection dot, settings gear
    5. Click a file in the tree — Checkout/Revert/Diff should become enabled
    6. Click away (deselect) — those buttons should grey out again
    7. Click Sync — button should show spinning state
    8. Click Refresh — tree should reload
    9. Click Reconcile — dialog should open
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Single header bar visible (no second toolbar row)
3. All 7 center buttons render with icon above text
4. Context-sensitive buttons disable/enable correctly
5. All button actions work (refresh, sync, reconcile, new CL, checkout, revert, diff)
6. Sync progress still visible somewhere (status bar or inline)
</verification>

<success_criteria>
- Two header bars replaced with single unified bar
- Left: Repository/Stream with labels, no "P4Now"
- Center: 7 GitKraken-style buttons (icon above text, no borders, hover highlight)
- Right: Search, connection, settings
- Checkout/Revert/Diff greyed when no file selected
- No animations or transitions
</success_criteria>

<output>
After completion, create `.planning/phases/08-visual-polish/08-02-SUMMARY.md`
</output>
