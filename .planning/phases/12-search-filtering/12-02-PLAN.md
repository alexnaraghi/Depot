---
phase: 12-search-filtering
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/components/FileTree/FileTree.tsx
  - src/components/FileTree/FileNode.tsx
  - src/components/ChangelistPanel/ChangelistPanel.tsx
  - src/components/ChangelistPanel/ChangelistNode.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Typing in search bar dims non-matching files in file tree while preserving tree structure"
    - "Typing in search bar dims non-matching changelist items in right column"
    - "Matching characters are highlighted within file names and CL descriptions"
    - "Match count badge updates in real-time as filter changes"
    - "Dimmed items are non-interactive (cannot click or tab to them)"
  artifacts:
    - path: "src/components/FileTree/FileNode.tsx"
      provides: "Filtered file node with dim/highlight rendering"
    - path: "src/components/FileTree/FileTree.tsx"
      provides: "File tree consuming filter store with match counting"
    - path: "src/components/ChangelistPanel/ChangelistPanel.tsx"
      provides: "Changelist panel consuming filter store with match counting"
  key_links:
    - from: "src/components/FileTree/FileTree.tsx"
      to: "src/stores/searchFilterStore.ts"
      via: "useSearchFilterStore subscription + useDeferredValue"
      pattern: "useSearchFilterStore|useDeferredValue"
    - from: "src/components/ChangelistPanel/ChangelistPanel.tsx"
      to: "src/stores/searchFilterStore.ts"
      via: "useSearchFilterStore subscription"
      pattern: "useSearchFilterStore"
---

<objective>
Wire fuzzy filtering from the search filter store into FileTree and ChangelistPanel. Non-matching items are dimmed (not hidden) to preserve tree structure. Matching characters are highlighted. Match counts are reported back to the store for the badge.

Purpose: Delivers the core in-place filtering experience â€” the primary feature of Phase 12.
Output: Both columns respond to filter term with dim/highlight behavior and match count reporting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-search-filtering/12-01-SUMMARY.md
@src/stores/searchFilterStore.ts
@src/components/FileTree/FileTree.tsx
@src/components/FileTree/FileNode.tsx
@src/components/FileTree/useFileTree.ts
@src/components/ChangelistPanel/ChangelistPanel.tsx
@src/components/ChangelistPanel/ChangelistNode.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire fuzzy filtering into FileTree with dimming and highlights</name>
  <files>src/components/FileTree/FileTree.tsx, src/components/FileTree/FileNode.tsx, package.json</files>
  <action>
    1. Install `react-highlight-words` for match highlighting:
       ```
       npm install react-highlight-words
       ```

    2. In `FileTree.tsx`:
       - Import `useSearchFilterStore` and `useDeferredValue` from React
       - Subscribe to `filterTerm` from the store
       - Wrap filterTerm with `useDeferredValue` for performance (avoids blocking renders during rapid typing)
       - Use `createFuzzySearch` from `@nozbe/microfuzz` to create a fuzzy searcher over the flat list of file names/paths
       - For each file node in the tree, determine if it matches the fuzzy filter:
         - If filterTerm is empty: all nodes are normal (no filtering)
         - If filterTerm is non-empty: run fuzzy match against file name (last segment of depot path). A folder matches if ANY of its descendant files match.
         - Pass a `dimmed` boolean prop to FileNodeData for non-matching nodes
         - Pass `highlightRanges` (from microfuzz result) to matching nodes
       - Count matching file nodes and call `setFileTreeMatchCount(count)` on the store via `useEffect`
       - Use `useEffect` with the deferred term as dependency to avoid calling setFileTreeMatchCount on every render

    3. In `FileNode.tsx`:
       - Add `dimmed?: boolean` and `highlightRanges?: [number, number][]` to `FileNodeData` interface
       - When `dimmed` is true:
         - Apply `opacity-30 pointer-events-none` classes to the node
         - Set `tabIndex={-1}` and `aria-hidden="true"` for accessibility
         - Disable click handler (return early)
       - When NOT dimmed and `highlightRanges` is provided:
         - Use `Highlighter` from `react-highlight-words` to highlight matching characters in the file name
         - Alternative: manually render highlighted spans using the range indices from microfuzz
       - When NOT dimmed and no filter active: render normally (unchanged from current)

    **Important:** Do NOT hide/remove non-matching nodes from the tree. They stay in place but dimmed. This preserves the tree structure so users maintain spatial context.
  </action>
  <verify>
    - `npm run build` succeeds
    - File tree shows all nodes when no filter active
    - With filter active, non-matching files appear dimmed (opacity reduced)
    - Matching files show highlighted characters in their names
    - Folder structure preserved (folders visible even if no children match, but dimmed)
    - Match count updates in search bar badge
  </verify>
  <done>File tree dims non-matching nodes, highlights matching characters, and reports match count to the search filter store.</done>
</task>

<task type="auto">
  <name>Task 2: Wire fuzzy filtering into ChangelistPanel with dimming and highlights</name>
  <files>src/components/ChangelistPanel/ChangelistPanel.tsx, src/components/ChangelistPanel/ChangelistNode.tsx</files>
  <action>
    1. In `ChangelistPanel.tsx`:
       - Import `useSearchFilterStore` and `useDeferredValue`
       - Subscribe to `filterTerm`
       - Use `useDeferredValue` on filterTerm
       - For each changelist tree node:
         - Match against changelist description (for changelist header nodes)
         - Match against file name/path (for file nodes within changelists)
         - A changelist header matches if its description matches OR any of its files match
         - Pass `dimmed` and `highlightRanges` through the tree node data
       - Count matching items (files that match + changelist headers with matches) and call `setChangelistMatchCount(count)`
       - Use `useEffect` to report count, not inline during render

    2. In `ChangelistNode.tsx`:
       - Add `dimmed?: boolean` and `highlightRanges?: [number, number][]` to the node data or props
       - When dimmed:
         - Apply `opacity-30 pointer-events-none` classes
         - Set `tabIndex={-1}` and `aria-hidden="true"`
         - Disable click, drag, and context menu handlers
       - When matching:
         - Use `Highlighter` or manual highlight spans for the matching text (description for CL headers, file name for file nodes)
       - Changelist headers that match (or have matching children): show normally
       - Changelist headers with NO matching children and no description match: dim the entire section

    **Fuzzy matching approach:** Use `createFuzzySearch` from microfuzz. Create the searcher once per deferred term change. For changelist descriptions, match against the full description text. For files, match against the file name (last path segment).
  </action>
  <verify>
    - `npm run build` succeeds
    - Changelist panel shows all items when no filter active
    - With filter active, non-matching CL descriptions and files appear dimmed
    - Matching text highlighted in CL descriptions and file names
    - Changelist headers with matching children remain fully visible
    - Match count updates in search bar badge (combined with file tree count)
  </verify>
  <done>Changelist panel dims non-matching items, highlights matches, and reports match count to the search filter store.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Both columns respond to filter term typed in search bar
- Non-matching items dimmed in both columns, matching items highlighted
- Tree structure preserved (no items removed/hidden)
- Match count badge in search bar shows total across both columns
- Dimmed items are non-interactive (pointer-events-none, aria-hidden)
- Clearing search restores all items to normal interactive state
- Performance is acceptable with large file lists (useDeferredValue prevents jank)
</verification>

<success_criteria>
- Typing in search bar filters both columns in-place with dimming
- Match characters highlighted in file names and CL descriptions
- Match count badge accurate and real-time
- Escape/clear restores unfiltered state
</success_criteria>

<output>
After completion, create `.planning/phases/12-search-filtering/12-02-SUMMARY.md`
</output>
