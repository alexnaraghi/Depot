# Milestone v5.0: Large Depot Scale

**Status:** âœ… SHIPPED 2026-02-05
**Phases:** 21-25
**Total Plans:** 15

## Overview

Make P4Now work smoothly with 10,000+ file depots by replacing blocking all-or-nothing data flows with streaming, incremental, and cancellable operations. The app should feel instant even on large workspaces.

## Phases

### Phase 21: Async Foundation

**Goal**: Backend process infrastructure supports non-blocking async execution for all subsequent streaming work
**Depends on**: Phase 20
**Requirements**: STREAM-04, TREE-02
**Plans**: 3 plans

Plans:

- [x] 21-01: Enable tokio process features, migrate ProcessManager and streaming commands to async
- [x] 21-02: Migrate all p4 handler commands to tokio::process::Command
- [x] 21-03: Create useDebounce hook and integrate into FileTree filter

**Details:**

Migrated from std::process to tokio::process with proper zombie prevention (.wait().await after .kill().await). Added useDebounce hook with 150ms default delay. All p4 commands now use tokio::process::Command with non-blocking .await pattern.

**Verified:** 2026-02-05T02:42:46Z - All 4 success criteria verified

---

### Phase 22: Streaming fstat + Progress

**Goal**: Users see workspace files appearing progressively instead of waiting for a single blocking load
**Depends on**: Phase 21
**Requirements**: STREAM-01, STREAM-02, STREAM-03, PROG-01, PROG-02, PROG-03
**Plans**: 3 plans

Plans:

- [x] 22-01: Backend streaming fstat command with Channel output
- [x] 22-02: Frontend streaming integration with batch accumulation
- [x] 22-03: Progress indicator enhancement and cancellation UX

**Details:**

Implemented p4_fstat_stream with Channel-based batching (100 files per batch). FstatStreamBatch protocol (Data + Complete variants). ProcessManager integration enables cancellable operations with partial result preservation. Progress tracking shows file count display in StatusBar with cancel button.

**Verified:** 2026-02-05T03:32:43Z - All 11 success criteria verified

---

### Phase 23: FileIndex and Search

**Goal**: User can instantly search across all workspace files with fuzzy matching powered by a persistent Rust-side index
**Depends on**: Phase 22
**Requirements**: SEARCH-01, SEARCH-02, SEARCH-03, TREE-01
**Plans**: 3 plans

Plans:

- [x] 23-01: Create FileIndex module with nucleo fuzzy matching and Tauri commands
- [x] 23-02: Frontend search integration with fuzzy/exact toggle and match count
- [x] 23-03: Integrate FileIndex with streaming fstat for automatic rebuild

**Details:**

Created FileIndex module with add_batch, clear, search methods. nucleo-matcher integration for fuzzy/exact search modes. Recency bias scoring (1.5x boost for files <7 days old). Four Tauri commands: search_workspace_files, add_files_to_index, clear_file_index, get_file_index_count. useFileSearch hook with 150ms debounce.

**Verified:** 2026-02-05T04:35:00Z - All 4 success criteria verified

---

### Phase 24: Tree Performance + Delta Refresh

**Goal**: File tree updates are incremental (no full rebuilds) and auto-refresh is cheap (queries only changed files)
**Depends on**: Phase 22
**Requirements**: TREE-03, TREE-04, TREE-05, DELTA-01, DELTA-02, DELTA-03
**Plans**: 4 plans

Plans:

- [x] 24-01: Install Immer, add settings for two-tier refresh, batch update action in store
- [x] 24-02: Incremental tree update with Immer structural sharing
- [x] 24-03: Backend p4_fstat_opened command for delta refresh
- [x] 24-04: Two-tier auto-refresh integration in useFileTree

**Details:**

Immer integration for structural sharing (produce() pattern). incrementalTreeUpdate with 10% threshold decision logic. batchUpdateFiles action for atomic store updates. p4_fstat_opened command for delta refresh (queries only opened files). Two-tier refresh: 30s delta (fast) + 5min full (comprehensive). mergeDeltaFiles for incremental merge without flicker.

**Verified:** 2026-02-05T08:30:00Z - All 6 success criteria verified

---

### Phase 25: Batch Optimization

**Goal**: Shelved file queries execute as a single efficient operation instead of N+1 individual calls
**Depends on**: Phase 21
**Requirements**: BATCH-01, BATCH-02, BATCH-03
**Plans**: 2 plans

Plans:

- [x] 25-01: Backend batch command with streaming progress and error isolation
- [x] 25-02: Frontend batch integration with progress indicator and toast notifications

**Details:**

p4_describe_shelved_batch command accepting Vec<i32> changelist IDs. ShelvedBatchProgress streaming protocol (Progress + Result variants). Per-CL error isolation (one failure doesn't hide other results). Progress updates every 5 CLs. Yellow toast notification for partial failures. Query key 'shelved-batch' replaces individual 'shelved' keys.

**Verified:** 2026-02-05T08:27:10Z - All 9 success criteria verified

---

## Milestone Summary

**Key Decisions:**

- ProcessManager tokio support + debounce hook with zero dependencies
- Streaming fstat with 100-file batches generalizes proven p4_sync Channel pattern
- nucleo-powered FileIndex on Rust side with recency-weighted search
- Incremental tree builder with Immer structural sharing for performance
- N+1 shelved query fix using single batch command with error isolation

**Issues Resolved:**

- Blocking workspace loads on large depots (10,000+ files)
- Thread pool exhaustion from std::thread::spawn
- Zombie p4.exe process accumulation
- N+1 shelved file query pattern
- Full tree rebuilds every 30 seconds during auto-refresh
- File tree filter performance degradation at scale

**Technical Debt Incurred:**

None identified - all anti-pattern checks passed, zero TODO/FIXME comments in phase code

**Decimal Phases:**

None - all phases sequential (21-25)

---

_For current project status, see .planning/ROADMAP.md_
