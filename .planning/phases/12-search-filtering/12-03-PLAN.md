---
phase: 12-search-filtering
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/components/CommandPalette.tsx
  - src/components/DetailPane/DetailPane.tsx
  - src/components/DetailPane/SearchResultsView.tsx
  - src/stores/detailPaneStore.ts
  - src/hooks/useSearch.ts
  - src-tauri/src/commands.rs
  - src/lib/tauri.ts
autonomous: true

must_haves:
  truths:
    - "Command palette has 'Search submitted changelists' command that opens search in detail pane"
    - "Command palette has 'Search depot paths' command that opens search in detail pane"
    - "Submitted CL search results display in detail pane with 50 initial results and Load More"
    - "Clicking a submitted CL result drills into full CL detail view"
    - "Right-clicking a search result in SearchResultsView shows a context menu with relevant operations"
    - "Clicking an author name in submitted CL search results filters results to that author's recent changes"
  artifacts:
    - path: "src/components/DetailPane/SearchResultsView.tsx"
      provides: "Detail pane view for deep search results"
      exports: ["SearchResultsView"]
    - path: "src/stores/detailPaneStore.ts"
      provides: "Extended selection type for search results"
  key_links:
    - from: "src/components/CommandPalette.tsx"
      to: "src/stores/detailPaneStore.ts"
      via: "navigate to search selection type"
      pattern: "type: 'search'"
    - from: "src/components/DetailPane/SearchResultsView.tsx"
      to: "src/stores/detailPaneStore.ts"
      via: "drillToFile on result click"
      pattern: "drillToFile|navigate"
---

<objective>
Add deep search commands to the command palette and display results in the detail pane. Two search types: submitted changelists (client-side filter of prefetched data) and depot paths (backend `p4 files` command).

Purpose: Provides deep search capabilities beyond in-place filtering, using the detail pane as the results view.
Output: Two new command palette entries, SearchResultsView component, extended detail pane selection type.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-search-filtering/12-01-SUMMARY.md
@src/components/CommandPalette.tsx
@src/components/DetailPane/DetailPane.tsx
@src/stores/detailPaneStore.ts
@src/lib/tauri.ts
@src-tauri/src/commands.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend detail pane for search results and add backend depot search</name>
  <files>src/stores/detailPaneStore.ts, src/components/DetailPane/SearchResultsView.tsx, src/components/DetailPane/DetailPane.tsx, src-tauri/src/commands.rs, src/lib/tauri.ts</files>
  <action>
    1. **Extend DetailSelection** in `detailPaneStore.ts`:
       - Add a new selection type to the discriminated union:
         ```typescript
         | { type: 'search'; searchType: 'submitted' | 'depot'; query: string }
         ```
       - Add a `navigateToSearch` action:
         ```typescript
         navigateToSearch: (searchType: 'submitted' | 'depot', query: string) => void;
         ```
       - Implementation: calls `navigate` with the search selection

    2. **Add backend command** for depot path search in `src-tauri/src/commands.rs`:
       - Add a new Tauri command `p4_files` that runs `p4 files <pattern>` (e.g., `p4 files //depot/.../*query*`)
       - Accept parameters: `pattern: String, max_results: u32, server, user, client`
       - Parse output lines: each line has format `//depot/path#rev - action change N (type)`
       - Return a Vec of structs with `depot_path`, `revision`, `action`, `change`, `file_type`
       - Limit results to `max_results` (default 50)

    3. **Add TypeScript wrapper** in `src/lib/tauri.ts`:
       - Add `invokeP4Files(pattern: string, maxResults: number, server?, user?, client?)`
       - Define `P4FileResult` type: `{ depot_path: string; revision: number; action: string; change: number; file_type: string }`

    4. **Create `SearchResultsView.tsx`** in `src/components/DetailPane/`:
       - Props: `searchType: 'submitted' | 'depot'`, `query: string`
       - **Submitted CL search:**
         - Use `useQuery` to fetch submitted CLs (reuse `['p4', 'changes', 'submitted']` cache from existing query)
         - Filter client-side by query (same logic as old useSearch but inline)
         - Show results as cards: CL#, date, user, first line of description
         - Initially show 50 results, "Load more" button adds 50 more (client-side pagination of filtered results)
         - Clicking a CL result: navigate to CL detail. Since submitted CLs aren't P4Changelist type, create a simple display with `navigate({ type: 'changelist', changelist: ... })`. Actually, the existing changelist detail view expects P4Changelist. Instead, show an inline submitted CL detail: CL#, full description, date, user, file count. Use a custom rendering within SearchResultsView or navigate to a simplified view.
         - **Simpler approach:** On click, just show the CL details inline (expand the card) with the full description. Add a "View files" button that's a TODO for Phase 14 (when p4 describe is available). This avoids needing to extend the detail pane type further.
       - **Depot path search:**
         - Show a search input within the view (pre-filled with query from command palette prompt)
         - On submit, call `invokeP4Files` with the pattern
         - Display results as a flat list: depot path, revision#, action, CL#
         - Clicking a depot file result: call `drillToFile(depotPath, '', fromCl)` — no local path available for depot files
         - Show loading state while fetching
         - Handle errors gracefully (show error message, not crash)

    5. **Wire into DetailPane.tsx:**
       - Add case for `selection.type === 'search'` that renders `<SearchResultsView searchType={selection.searchType} query={selection.query} />`

    6. **Context menu on search results (SRCH-01):**
       - In `SearchResultsView.tsx`, add right-click context menus to search result items:
         - **Submitted CL results:** On right-click, show a context menu with operations relevant to a changelist — e.g., "Copy CL Number", "View in Detail Pane" (navigate to CL detail). Use the same ContextMenu pattern (radix or custom) already used elsewhere in the app for FileNode/ChangelistNode context menus. Import and reuse the `ContextMenu` component if one exists, or create a minimal one matching existing patterns.
         - **Depot path results:** On right-click, show context menu with "Copy Depot Path", "View File Detail" (navigate to file detail via drillToFile).
         - Note: In-place filtered results (FileNode, ChangelistNode in the columns) already have their own context menus from existing components — no changes needed there.

    7. **Author click to filter by author (SRCH-03):**
       - In `SearchResultsView.tsx`, for submitted CL search results, render the author/user name as a clickable element (e.g., a styled `<button>` or `<span>` with `cursor-pointer` and hover underline).
       - On click, update the search query to filter by that author's name — set the search input value to the author name and re-filter the results. This effectively shows "recent changes by this author" within the submitted CL search results.
       - Visual cue: author names should have a subtle link-like style (text-blue-400 or underline on hover) to indicate clickability.
  </action>
  <verify>
    - `npm run build` succeeds (frontend)
    - `cd src-tauri && cargo check` succeeds (backend)
    - SearchResultsView renders for both search types
    - Detail pane shows search results when navigated to search selection
    - Right-click on search result items shows context menu
    - Clicking an author name in submitted CL results filters to that author
  </verify>
  <done>Detail pane supports search result views. Backend depot search command available. SearchResultsView renders both submitted CL and depot path search results. Context menus work on search results. Author names are clickable to filter by author.</done>
</task>

<task type="auto">
  <name>Task 2: Add deep search commands to command palette</name>
  <files>src/components/CommandPalette.tsx</files>
  <action>
    1. In `CommandPalette.tsx`, add a new **"Search"** command group after the Navigation group:
       ```tsx
       <CommandGroup heading="Search">
         <CommandItem
           onSelect={() => executeCommand(() => {
             // Prompt for search term then navigate to search results
             const query = window.prompt('Search submitted changelists:');
             if (query && query.trim()) {
               useDetailPaneStore.getState().navigateToSearch('submitted', query.trim());
             }
           })}
         >
           <Search className="w-4 h-4" />
           <span>Search Submitted Changelists</span>
         </CommandItem>
         <CommandItem
           onSelect={() => executeCommand(() => {
             const query = window.prompt('Search depot paths (e.g., //depot/.../*.cpp):');
             if (query && query.trim()) {
               useDetailPaneStore.getState().navigateToSearch('depot', query.trim());
             }
           })}
         >
           <FolderSearch className="w-4 h-4" />
           <span>Search Depot Paths</span>
         </CommandItem>
       </CommandGroup>
       ```

    2. Import `Search` and `FolderSearch` from lucide-react (Search is likely already imported in the file, FolderSearch may need adding).

    3. Import `useDetailPaneStore` from `@/stores/detailPaneStore`.

    **Note on window.prompt:** This is a quick approach. The command palette's own input field could theoretically be reused, but `window.prompt` is simpler and the CONTEXT.md doesn't specify a particular UX for the search query input. If `window.prompt` looks too basic, an alternative is to have the command just set the search type and then the SearchResultsView contains its own input field — this is the PREFERRED approach. Use the detail pane's own input instead of window.prompt:

    **Revised approach (preferred):**
    - Command palette items navigate directly to search view with empty query:
      ```typescript
      useDetailPaneStore.getState().navigateToSearch('submitted', '');
      useDetailPaneStore.getState().navigateToSearch('depot', '');
      ```
    - The SearchResultsView component has its own focused search input at the top
    - User types their deep search query there
    - This avoids the ugly window.prompt and keeps UX consistent
  </action>
  <verify>
    - `npm run build` succeeds
    - Opening command palette (Ctrl+K) shows "Search" group with two commands
    - Selecting "Search Submitted Changelists" navigates detail pane to search results view
    - Selecting "Search Depot Paths" navigates detail pane to depot search view
    - Both search views have their own input fields for entering queries
  </verify>
  <done>Command palette has "Search Submitted Changelists" and "Search Depot Paths" commands that open search views in the detail pane.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `cd src-tauri && cargo check` succeeds
- Command palette shows two new search commands
- Selecting a search command opens the appropriate search view in the detail pane
- Submitted CL search filters prefetched data client-side with results shown as expandable cards
- Depot path search calls backend and displays results
- Clicking a submitted CL result expands to show details
- Load More works for submitted CL results (client-side pagination)
- Back button in detail pane returns from search results to previous view
</verification>

<success_criteria>
- Command palette provides both deep search types
- Search results display in detail pane (center column)
- Submitted CL search shows 50 initial results with Load More
- Depot path search calls P4 backend and shows file results
- Navigation (back button) works from search results
</success_criteria>

<output>
After completion, create `.planning/phases/12-search-filtering/12-03-SUMMARY.md`
</output>
