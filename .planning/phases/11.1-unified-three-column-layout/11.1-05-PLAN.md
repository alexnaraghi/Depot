---
phase: 11.1-unified-three-column-layout
plan: 05
type: execute
wave: 4
depends_on: ["11.1-02", "11.1-03", "11.1-04"]
files_modified:
  - src/stores/detailPaneStore.ts
  - src/components/MainLayout.tsx
  - src/components/FileTree/FileTree.tsx
  - src/components/ChangelistPanel/ChangelistPanel.tsx
  - src/components/dialogs/FileHistoryDialog.tsx
autonomous: false

must_haves:
  truths:
    - "Column widths persist across app restarts"
    - "FileHistoryDialog is no longer opened from file tree or changelist panel"
    - "File history shortcut (Ctrl+H) navigates to file detail view instead of opening dialog"
    - "Three-column layout looks correct and all detail views render properly"
  artifacts:
    - path: "src/components/MainLayout.tsx"
      provides: "Persisted column widths via settings store"
  key_links:
    - from: "src/components/MainLayout.tsx"
      to: "src/lib/settings.ts"
      via: "Load/save column widths on mount/resize"
---

<objective>
Persist column widths across sessions and clean up legacy dialog usage. Final visual verification.

Purpose: Column width persistence is a success criterion. Removing FileHistoryDialog usage ensures users get the integrated inline experience. Visual checkpoint confirms the layout works end-to-end.
Output: Polished three-column layout with persistent widths and no legacy dialog usage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/design/unified-column-layout.md
@.planning/phases/11.1-unified-three-column-layout/11.1-01-SUMMARY.md
@.planning/phases/11.1-unified-three-column-layout/11.1-04-SUMMARY.md
@src/components/MainLayout.tsx
@src/components/FileTree/FileTree.tsx
@src/components/ChangelistPanel/ChangelistPanel.tsx
@src/lib/settings.ts
@src/hooks/useSettings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Persist column widths and remove FileHistoryDialog usage</name>
  <files>src/components/MainLayout.tsx, src/components/FileTree/FileTree.tsx, src/components/ChangelistPanel/ChangelistPanel.tsx, src/lib/settings.ts</files>
  <action>
**Column width persistence:**
In MainLayout.tsx:
- On component mount, load saved column widths from tauri-plugin-store (same pattern as existing settings). Check how settings.ts loads/saves settings using the Store plugin. Add two new settings keys: `layout.leftColumnWidth` and `layout.rightColumnWidth`.
- Add a helper in settings.ts (or inline): `getColumnWidths(): Promise<{ left: number; right: number }>` and `saveColumnWidths(left: number, right: number): Promise<void>`. Use store keys `layout.leftColumnWidth` (default 280) and `layout.rightColumnWidth` (default 320) via `store.get<number>('layout.leftColumnWidth')` / `store.set('layout.leftColumnWidth', value)`.
- On mount, load widths and set state (use defaults 280/320 if not saved).
- On resize end (mouseup), save the new widths. Debounce or just save on mouseup — not on every mousemove.
- Use the same tauri-plugin-store pattern as the existing `loadSettings`/`saveSettings` in settings.ts.

**Remove FileHistoryDialog from FileTree.tsx:**
- Remove the `historyDialog` state and `setHistoryDialog` calls
- Remove the `<FileHistoryDialog>` JSX
- Remove the import of FileHistoryDialog
- Update `handleShowHistory` to instead call `useDetailPaneStore.getState().selectFile(depotPath, localPath)` — this will show the file detail view which has inline history
- Update the `p4now:history-selected` event handler to do the same

**Remove FileHistoryDialog from ChangelistPanel.tsx:**
- Same cleanup: remove historyDialog state, FileHistoryDialog JSX and import
- Update `handleShowHistory` to call `useDetailPaneStore.getState().selectFile(depotPath, localPath)` instead
- The context menu "Show History" option should now navigate to file detail view

**Do NOT delete FileHistoryDialog.tsx file** — it may still be referenced elsewhere or useful for future use. Just remove its usage from these two files.

**Update keyboard shortcut behavior:**
In MainLayout.tsx, the `p4now:history-selected` event currently opens the dialog. With the dialog removed from FileTree, the event handler in FileTree already navigates to file detail. Verify this flow works: Ctrl+H with a file selected -> detail pane shows file with history.
  </action>
  <verify>`npx tsc --noEmit` passes. Run `npm run dev`, resize columns, close and reopen app — columns should restore to last saved widths. Verify no FileHistoryDialog appears when using history from context menu or Ctrl+H.</verify>
  <done>Column widths persist across restarts. FileHistoryDialog no longer opens from tree or CL panel — inline history in detail pane is used instead.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete three-column layout with selection-driven detail pane, breadcrumb navigation, inline file history, CL detail view, revision detail view, and persistent column widths.</what-built>
  <how-to-verify>
    1. Run `npm run dev` (or `npm run tauri dev`)
    2. Verify three-column layout: file tree (left), detail pane (center), changelists (right)
    3. On launch, center pane shows "Workspace Summary" with file count and CL count
    4. Click a file in the tree -> center shows file detail with history table
    5. Click a revision row in file history -> center shows revision detail
    6. Click back arrow or press Escape -> returns to file detail
    7. Click a CL header on the right -> center shows CL detail with file list
    8. Click a file in CL detail -> drills to file detail with breadcrumb "CL ### > filename"
    9. Resize left column -> file tree adjusts
    10. Resize right column -> CL panel adjusts
    11. Close and reopen app -> column widths are restored
    12. Right-click context menus still work on files and CLs
    13. Drag-and-drop files between CLs still works
    14. Ctrl+H on a selected file shows file detail with history (no dialog)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Column widths persist across app restarts
3. No FileHistoryDialog opens from any context
4. All five success criteria from the phase are met
</verification>

<success_criteria>
Phase 11.1 complete: Three-column layout with persistent widths, selection-driven detail views, breadcrumb navigation, and inline file history.
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-unified-three-column-layout/11.1-05-SUMMARY.md`
</output>
