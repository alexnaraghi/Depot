---
phase: 17-file-annotations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/commands/p4.rs
  - src-tauri/src/lib.rs
  - src/lib/tauri.ts
  - src/hooks/useFileAnnotations.ts
  - src/lib/annotationParser.ts
  - src/lib/annotationColors.ts
autonomous: true

must_haves:
  truths:
    - "Backend can execute p4 annotate -u -c and return structured annotation data"
    - "Frontend can fetch annotation data via TanStack Query hook"
    - "Annotation blocks can be grouped for keyboard navigation"
    - "Age colors can be calculated for any timestamp range"
  artifacts:
    - path: "src-tauri/src/commands/p4.rs"
      provides: "p4_annotate command with P4AnnotationLine struct"
      contains: "p4_annotate"
    - path: "src/hooks/useFileAnnotations.ts"
      provides: "TanStack Query hook for annotation data"
      exports: ["useFileAnnotations"]
    - path: "src/lib/annotationParser.ts"
      provides: "Parse p4 annotate output and group blocks"
      exports: ["parseAnnotations", "groupAnnotationBlocks"]
    - path: "src/lib/annotationColors.ts"
      provides: "Age-based heatmap color calculation"
      exports: ["calculateAgeColor", "getAgeDescription"]
  key_links:
    - from: "src/hooks/useFileAnnotations.ts"
      to: "src/lib/tauri.ts:invokeP4Annotate"
      via: "Tauri invoke"
      pattern: "invokeP4Annotate"
    - from: "src/lib/tauri.ts"
      to: "src-tauri/src/commands/p4.rs:p4_annotate"
      via: "Tauri command"
      pattern: "invoke.*p4_annotate"
---

<objective>
Add backend command and frontend infrastructure for file annotations (blame)

Purpose: Enable fetching per-line blame data from Perforce and provide utilities for parsing, grouping, and coloring annotations

Output: Working p4_annotate backend command, useFileAnnotations hook, annotation parsing utilities, age-based color calculation
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 16 established patterns for file content handling
@.planning/phases/16-file-content-viewer/16-01-SUMMARY.md

# Research provides implementation patterns
@.planning/phases/17-file-annotations/17-RESEARCH.md

# Existing tauri.ts patterns
@src/lib/tauri.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add p4_annotate backend command</name>
  <files>src-tauri/src/commands/p4.rs, src-tauri/src/lib.rs, src/lib/tauri.ts</files>
  <action>
Create p4_annotate Tauri command in src-tauri/src/commands/p4.rs:

1. Add P4AnnotationLine struct (derive Debug, Clone, Serialize):
   - line_number: i32 (1-indexed)
   - changelist_id: i32
   - user: String
   - date: String (YYYY/MM/DD format from p4)
   - line_content: String

2. Create async fn p4_annotate command:
   - Parameters: depot_path: String, revision: i32, server/user/client Options
   - Build command: p4 annotate -u -c {depot_path}#{revision}
   - Apply connection args using existing apply_connection_args pattern
   - Execute command and parse output
   - Return Result<Vec<P4AnnotationLine>, String>

3. Parse output using regex pattern: r"^(\d+):\s+(\S+)\s+(\d{4}/\d{2}/\d{2})\s+(.*)$"
   - Each line format: "CL#: USER DATE CONTENT"
   - Example: "320: mjones 2017/05/06 sr->w.digest.Clear();"
   - Handle empty lines gracefully
   - Track line_number starting at 1

4. Register command in src-tauri/src/lib.rs .invoke_handler()

5. Add invokeP4Annotate function to src/lib/tauri.ts:
   - Export P4AnnotationLine interface matching Rust struct (camelCase: lineNumber, changelistId, user, date, lineContent)
   - Function signature: invokeP4Annotate(depotPath: string, revision: number): Promise<P4AnnotationLine[]>
   - Use getConnectionArgs() pattern like existing commands
  </action>
  <verify>
  - cargo check passes in src-tauri directory
  - npm run build completes without TypeScript errors
  - invokeP4Annotate exported from tauri.ts
  </verify>
  <done>
  - p4_annotate command registered and callable
  - P4AnnotationLine struct exists with all fields
  - Frontend invoke function ready to use
  </done>
</task>

<task type="auto">
  <name>Task 2: Create annotation parsing and color utilities</name>
  <files>src/lib/annotationParser.ts, src/lib/annotationColors.ts</files>
  <action>
Create src/lib/annotationParser.ts:

1. Export ParsedAnnotation interface:
   - changelistId: number
   - user: string
   - date: string (YYYY/MM/DD format)
   - lineContent: string
   - lineNumber: number (1-indexed)

2. Export AnnotationBlock interface:
   - changelistId: number
   - user: string
   - date: string
   - startLine: number
   - endLine: number

3. Export groupAnnotationBlocks function:
   - Input: ParsedAnnotation[]
   - Output: AnnotationBlock[]
   - Groups consecutive lines with same changelistId into blocks
   - Each block tracks startLine and endLine for keyboard navigation
   - Handle empty array edge case

Create src/lib/annotationColors.ts:

1. Export calculateAgeColor function:
   - Parameters: timestamp: number, minTimestamp: number, maxTimestamp: number
   - Returns: string (HSL color with low opacity)
   - Formula: hue = 240 - (age * 240) where age = (timestamp - min) / (max - min)
   - Result: hsla(${hue}, 60%, 70%, 0.15)
   - Handle edge case where minTimestamp === maxTimestamp (return neutral gray)
   - Blue (240deg) = old, Red (0deg) = recent

2. Export getAgeDescription function:
   - Input: date: string (YYYY/MM/DD format)
   - Output: string (human-readable age like "Today", "2 days ago", "3 months ago")
   - Calculate difference in days from current date
   - Return appropriate label: Today, Yesterday, N days ago, N weeks ago, N months ago, N years ago
  </action>
  <verify>
  - npm run build passes without TypeScript errors
  - Functions exported and importable
  </verify>
  <done>
  - groupAnnotationBlocks correctly groups consecutive lines
  - calculateAgeColor returns valid HSL strings
  - getAgeDescription returns readable relative times
  </done>
</task>

<task type="auto">
  <name>Task 3: Create useFileAnnotations hook</name>
  <files>src/hooks/useFileAnnotations.ts</files>
  <action>
Create src/hooks/useFileAnnotations.ts:

1. Import useQuery from @tanstack/react-query
2. Import invokeP4Annotate and P4AnnotationLine from lib/tauri
3. Import groupAnnotationBlocks from lib/annotationParser

4. Export useFileAnnotations hook:
   - Parameters: depotPath: string, revision: number, options?: { enabled?: boolean }
   - Query key: ['file-annotations', depotPath, revision]
   - Query function: calls invokeP4Annotate(depotPath, revision)
   - staleTime: 60 * 60 * 1000 (1 hour - annotations at specific revision are immutable)
   - enabled: options?.enabled ?? true (allows controlled fetching like useFileContent)
   - Return type includes: data (P4AnnotationLine[]), isLoading, error

5. Export useAnnotationBlocks hook (convenience wrapper):
   - Parameters: annotations: P4AnnotationLine[] | undefined
   - Uses useMemo to compute blocks via groupAnnotationBlocks
   - Returns AnnotationBlock[] (empty array if annotations undefined)
   - Memoized to prevent recalculation on every render
  </action>
  <verify>
  - npm run build passes
  - Hook exports correctly typed
  </verify>
  <done>
  - useFileAnnotations fetches and caches annotation data
  - useAnnotationBlocks groups annotations into navigable blocks
  - Hooks follow existing project patterns (staleTime, enabled option)
  </done>
</task>

</tasks>

<verification>
1. cargo check in src-tauri passes
2. npm run build completes without errors
3. All new exports importable:
   - invokeP4Annotate from lib/tauri
   - groupAnnotationBlocks, AnnotationBlock from lib/annotationParser
   - calculateAgeColor, getAgeDescription from lib/annotationColors
   - useFileAnnotations, useAnnotationBlocks from hooks/useFileAnnotations
</verification>

<success_criteria>
- Backend p4_annotate command parses p4 annotate -u -c output correctly
- Frontend hook provides annotation data with proper caching
- Utility functions ready for UI components in next plan
- All code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-file-annotations/17-01-SUMMARY.md`
</output>
