---
phase: 20-bug-fixes-and-ui-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/MainLayout.tsx
  - src/hooks/useSettings.ts
autonomous: true

must_haves:
  truths:
    - "Top toolbar order is Stream, Workspace, Client Spec (left to right)"
    - "Accordion headers remain visible regardless of content size"
    - "Connection dialog only shows when no saved connection exists or connection attempt fails"
  artifacts:
    - path: "src/components/MainLayout.tsx"
      provides: "Toolbar order fix, accordion header fix, connection dialog fix"
    - path: "src/hooks/useSettings.ts"
      provides: "Connection attempt tracking flag"
  key_links:
    - from: "src/hooks/useSettings.ts"
      to: "src/components/MainLayout.tsx"
      via: "isLoading flag tracks connection attempt completion"
      pattern: "isLoading.*false"
---

<objective>
Fix three MainLayout bugs: toolbar component order, accordion header visibility, and connection dialog auto-open logic.

Purpose: These three bugs all center on MainLayout.tsx and represent the highest-visibility UX issues (startup dialog annoyance, toolbar layout, header disappearing).
Output: Corrected MainLayout with proper toolbar order, sticky accordion headers, and connection dialog that only opens when appropriate.
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/MainLayout.tsx
@src/hooks/useSettings.ts
@src/stores/connectionStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix toolbar order and accordion headers</name>
  <files>src/components/MainLayout.tsx</files>
  <action>
Two fixes in MainLayout.tsx:

**Fix 1 - Toolbar order (Bug 7):**
In the LEFT section of the header (around line 251-254), swap the order of WorkspaceSwitcher and StreamSwitcher so StreamSwitcher comes first:

```tsx
<div className="flex items-center gap-6">
  <StreamSwitcher />
  <WorkspaceSwitcher />
</div>
```

The desired order is: Stream, Workspace, Client Spec (Client Spec button is already inside WorkspaceSwitcher).

**Fix 2 - Accordion headers (Bug 11):**
On the two CollapsibleTrigger elements (around lines 382 and 393), add `flex-shrink-0` to prevent flex layout from shrinking headers out of view:

For the Workspace Files trigger:
```tsx
<CollapsibleTrigger className="flex-shrink-0 flex items-center justify-between w-full px-4 py-2 bg-secondary/50 cursor-pointer select-none">
```

For the Depot trigger:
```tsx
<CollapsibleTrigger className="flex-shrink-0 flex items-center justify-between w-full px-4 py-2 bg-secondary/30 border-t border-border cursor-pointer select-none">
```

This ensures headers always remain visible regardless of how much content is in the expanded sections.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Visually inspect that:
1. StreamSwitcher appears before WorkspaceSwitcher in the toolbar
2. Both accordion headers remain visible when both sections are expanded with lots of content
  </verify>
  <done>Toolbar order is Stream -> Workspace -> Client Spec. Accordion headers never get pushed out of view by content.</done>
</task>

<task type="auto">
  <name>Task 2: Fix connection dialog auto-open logic</name>
  <files>src/components/MainLayout.tsx, src/hooks/useSettings.ts</files>
  <action>
Fix the connection dialog so it only opens when there are no saved settings (first launch) or when a connection attempt fails, not on every mount.

**In useSettings.ts:**
The hook already has `isLoading` state that starts `true` and sets to `false` in the `finally` block after connection attempt. This is sufficient - when `isLoading` becomes `false`, the connection attempt is complete and `connectionStatus` reflects the true state.

No changes needed to useSettings.ts - `isLoading` already tracks this.

**In MainLayout.tsx:**
1. Import and use `isLoading` from `useSettings`:
   - The `useSettings` hook is already called somewhere in the component tree (likely in App.tsx or similar). Find where `useSettings()` is called. If it's not called in MainLayout, we need to check if it's called in a parent component. Since `connectionStatus` is read from the store, we can use the `useSettings` hook's `isLoading` return value.

   Actually, `useSettings` is a hook that runs on mount and sets connection store state. It's likely called at the app root level, not in MainLayout. So MainLayout can't easily get `isLoading` from it.

   **Better approach**: Instead of checking `connectionStatus === 'disconnected'` on mount (which is always true initially), check if connection settings are empty. The connection dialog should open when:
   - Settings have been loaded AND
   - p4port/p4user/p4client are all null/empty in the connection store (meaning no saved connection exists)
   - OR connectionStatus is 'error' (connection was attempted but failed)

2. Replace the existing useEffect (lines 187-192):

```tsx
// Auto-open connection dialog when no connection configured or connection fails
useEffect(() => {
  // Skip during initial load - wait for useSettings to finish attempting connection
  if (connectionStatus === 'connecting') return;
  // Don't re-open if already connected
  if (connectionStatus === 'connected') return;
  // Open dialog if disconnected (no saved settings) or error (connection failed)
  if (connectionStatus === 'disconnected' || connectionStatus === 'error') {
    setConnectionDialogOpen(true);
  }
}, [connectionStatus]);
```

This works because:
- On mount: status is 'disconnected', but useSettings immediately sets it to 'connecting' before the effect runs (React batches). Actually, useSettings sets 'connecting' inside an async function, so the initial render sees 'disconnected'.
- The key fix is adding `connectionStatus` to the dependency array so the effect re-runs when status changes. On initial mount with 'disconnected', the dialog opens, but useSettings then sets 'connecting' (dialog stays open, fine). If connection succeeds, status becomes 'connected' and next render won't re-open it.
- Wait, this still opens on first mount. The real issue is distinguishing "haven't tried yet" from "tried and no settings exist."

**Correct approach**: Check if p4port is set in the connection store. If useSettings loads empty settings, it calls `setDisconnected()` (useSettings.ts line 17). If settings exist, it calls `setConnecting()` then either `setConnected()` or `setError()`.

So the fix is:
```tsx
// Auto-open connection dialog only after connection attempt completes
// (not on initial 'disconnected' state before useSettings runs)
useEffect(() => {
  // 'error' means connection was attempted and failed - show dialog
  if (connectionStatus === 'error') {
    setConnectionDialogOpen(true);
  }
}, [connectionStatus]);
```

And also add a separate check: after settings load, if no connection settings exist (first launch), open dialog. We need access to whether settings were loaded. The simplest approach:

Read the `p4port` from connection store. If after connection attempt (status is not 'connecting'), and p4port is null, and status is 'disconnected', that means no saved settings.

```tsx
const p4port = useConnectionStore(s => s.p4port);

useEffect(() => {
  // Don't show during connection attempt
  if (connectionStatus === 'connecting') return;

  // Show if connection failed
  if (connectionStatus === 'error') {
    setConnectionDialogOpen(true);
    return;
  }

  // Show if disconnected with no configured connection (first launch / empty settings)
  // After useSettings runs with empty settings, status stays 'disconnected' and p4port remains null
  if (connectionStatus === 'disconnected' && !p4port) {
    setConnectionDialogOpen(true);
  }
}, [connectionStatus, p4port]);
```

Wait, the problem is that on INITIAL mount, status is 'disconnected' and p4port is null (store defaults). So the dialog will still flash open before useSettings has a chance to run.

**Simplest correct fix**: Remove the auto-open on mount entirely. Instead, detect when useSettings finishes (status transitions FROM 'connecting' to 'error' or stays 'disconnected'). The key insight: `connectionStatus` goes through this flow:
1. Initial: 'disconnected' (store default)
2. useSettings loads settings, if settings have p4port: sets 'connecting'
3. If p4 info succeeds: 'connected'
4. If p4 info fails: 'error'
5. If settings are empty (no p4port): stays 'disconnected' (setDisconnected called)

The problem: steps 1 and 5 both result in 'disconnected'. We need to distinguish them.

**Final approach**: Track a `hasAttemptedConnection` ref in MainLayout that becomes true once status leaves 'disconnected' or 'connecting' for the first time, OR after a timeout.

Actually, the simplest fix that works:

```tsx
const [initialCheckDone, setInitialCheckDone] = useState(false);

// Wait for initial connection check to complete
useEffect(() => {
  if (connectionStatus === 'connecting') {
    // Connection attempt started - will resolve to connected/error/disconnected
    setInitialCheckDone(true);
  }
  // If status never goes to 'connecting' (empty settings),
  // we still need to open dialog after a brief delay
  const timer = setTimeout(() => setInitialCheckDone(true), 500);
  return () => clearTimeout(timer);
}, [connectionStatus]);

// Open dialog after initial check if not connected
useEffect(() => {
  if (!initialCheckDone) return;
  if (connectionStatus !== 'connected') {
    setConnectionDialogOpen(true);
  }
}, [initialCheckDone, connectionStatus]);
```

This avoids flashing the dialog on startup when saved settings exist: useSettings will set 'connecting' almost immediately (within the first render cycle), and the dialog won't open until the connection attempt completes.
  </action>
  <verify>
Run `npx tsc --noEmit`. Test scenarios:
1. With saved valid connection: App starts, no dialog flash, connects silently
2. With saved invalid connection: App starts, attempts connection, shows dialog after failure
3. First launch (no settings): App shows dialog after brief delay
  </verify>
  <done>Connection dialog does not flash on startup when valid saved connection exists. Dialog appears only when connection attempt fails or no settings are saved.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Toolbar shows Stream -> Workspace -> Client Spec order
3. Accordion headers stay visible when both sections are open
4. Connection dialog only shows when appropriate (not on every startup)
</verification>

<success_criteria>
- Toolbar order matches spec: Stream, Workspace, Client Spec
- Accordion section headers never get pushed out of view
- Connection dialog only appears when no saved connection or connection fails
</success_criteria>

<output>
After completion, create `.planning/phases/20-bug-fixes-and-ui-polish/20-01-SUMMARY.md`
</output>
