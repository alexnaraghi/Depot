---
phase: 13-workspace-stream-switching
plan: 05
type: execute
wave: 3
depends_on: ["13-02", "13-03", "13-04"]
files_modified:
  - src/components/MainLayout.tsx
  - src/components/Header/WorkspaceSwitcher.tsx
  - src/components/Header/StreamSwitcher.tsx
autonomous: false

must_haves:
  truths:
    - "Workspace switcher dropdown is visually integrated with header"
    - "Stream switcher dropdown is visually integrated with header"
    - "Switching workspace refreshes file tree and changelist panel"
    - "Switching stream with open files shows shelve confirmation"
    - "Client spec dialog is accessible and shows workspace details"
  artifacts:
    - path: "src/components/MainLayout.tsx"
      provides: "Fully integrated header with both switchers"
  key_links:
    - from: "src/components/Header/WorkspaceSwitcher.tsx"
      to: "src/stores/connectionStore.ts"
      via: "setConnected atomic update + queryClient.invalidateQueries()"
      pattern: "setConnected|invalidateQueries"
    - from: "src/components/Header/StreamSwitcher.tsx"
      to: "src/lib/tauri.ts"
      via: "invokeP4Shelve + invokeP4UpdateClientStream sequence"
      pattern: "invokeP4Shelve|invokeP4UpdateClientStream"
---

<objective>
Polish integration, fix visual issues, and verify complete workspace/stream switching workflow.

Purpose: Ensure all Phase 13 components work together correctly with consistent styling.
Output: Polished, verified workspace and stream switching experience.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/13-workspace-stream-switching/13-CONTEXT.md
@.planning/phases/13-workspace-stream-switching/13-02-SUMMARY.md
@.planning/phases/13-workspace-stream-switching/13-03-SUMMARY.md
@.planning/phases/13-workspace-stream-switching/13-04-SUMMARY.md
@src/components/MainLayout.tsx
@src/components/Header/WorkspaceSwitcher.tsx
@src/components/Header/StreamSwitcher.tsx
@src/components/Header/ClientSpecDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Polish header layout and fix integration issues</name>
  <files>src/components/MainLayout.tsx, src/components/Header/WorkspaceSwitcher.tsx, src/components/Header/StreamSwitcher.tsx</files>
  <action>
Review and fix integration between the three header components:

1. **Header layout**: Ensure WorkspaceSwitcher and StreamSwitcher sit side-by-side in the left section with consistent gap spacing (gap-6 to match existing). Both should have the same label style (text-[10px] uppercase tracking-wider text-muted-foreground above).

2. **Dropdown styling consistency**: Both Select triggers should have matching width strategy (min-w, max-w), same font sizes, same padding. Match the visual weight of the existing header action buttons.

3. **Select component styling**: Ensure SelectTrigger has no heavy borders — should be subtle, matching the dark theme. Add appropriate focus and hover states. The dropdown should use bg-popover with proper z-index.

4. **Disconnected state**: When status !== 'connected', show static text "No workspace" instead of dropdown (graceful degradation).

5. **Ensure no "Repository" text remains**: Grep MainLayout.tsx for "repository" (case-insensitive) — should be zero matches.

6. **Verify query invalidation timing**: Both switchers must call queryClient.invalidateQueries() AFTER connectionStore.setConnected() to ensure queries use new connection args.
  </action>
  <verify>Run `npm run build` to verify full build. Grep for "Repository" in src/ — should be zero matches.</verify>
  <done>Both switchers visually consistent, properly integrated in header, no "Repository" label remains</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete workspace and stream switching with header dropdowns, shelve confirmation, and client spec viewer</what-built>
  <how-to-verify>
    1. Run `npm run tauri dev` to launch the app
    2. Verify header shows "Workspace" label (not "Repository") with dropdown
    3. Click workspace dropdown — should list available workspaces
    4. If you have multiple workspaces: switch to another one. Verify:
       - Toast "Switched to workspace X" appears
       - File tree and changelist panel refresh
       - Detail pane resets to workspace summary
    5. If workspace has a stream: verify "Stream" dropdown shows current stream
    6. Click info icon near workspace — should open Client Spec dialog showing root, stream, view mappings
    7. If you have open files and multiple streams: try switching stream
       - Should show confirmation dialog listing files to shelve
       - Cancel should abort the switch
       - Confirm should shelve files, then switch stream
    8. Verify app remains responsive during switch operations (non-blocking)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` — full build succeeds
2. No "Repository" text in source
3. Visual verification of complete switching workflow
</verification>

<success_criteria>
- Both switchers render correctly in header
- Full workspace switch workflow works end-to-end
- Full stream switch workflow works with shelve confirmation
- Client spec dialog accessible and shows workspace details
- App remains responsive during all switch operations
</success_criteria>

<output>
After completion, create `.planning/phases/13-workspace-stream-switching/13-05-SUMMARY.md`
</output>
