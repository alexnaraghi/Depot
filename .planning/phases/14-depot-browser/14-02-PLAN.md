---
phase: 14-depot-browser
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/DepotBrowser/useDepotTree.ts
  - src/components/DepotBrowser/DepotNode.tsx
  - src/components/DepotBrowser/DepotBrowser.tsx
  - src/components/MainLayout.tsx
autonomous: true

must_haves:
  truths:
    - "User can see depot roots listed in a tree in the left column"
    - "User can expand a depot folder and see its subdirectories load"
    - "Depot tree is in a collapsible 'Depot' section below 'Workspace Files'"
    - "Both sections are independently collapsible with persisted state"
  artifacts:
    - path: "src/components/DepotBrowser/useDepotTree.ts"
      provides: "Hook for depot tree data with lazy loading via TanStack Query"
      exports: ["useDepotTree"]
    - path: "src/components/DepotBrowser/DepotNode.tsx"
      provides: "Tree node renderer for depot items"
      exports: ["DepotNode"]
    - path: "src/components/DepotBrowser/DepotBrowser.tsx"
      provides: "Main depot browser component with react-arborist tree"
      exports: ["DepotBrowser"]
    - path: "src/components/MainLayout.tsx"
      provides: "Updated left column with accordion sections"
  key_links:
    - from: "src/components/DepotBrowser/useDepotTree.ts"
      to: "src/lib/tauri.ts"
      via: "invokeP4Depots and invokeP4Dirs calls"
      pattern: "invokeP4Depots|invokeP4Dirs"
    - from: "src/components/MainLayout.tsx"
      to: "src/components/DepotBrowser/DepotBrowser.tsx"
      via: "import and render in left column Collapsible"
      pattern: "DepotBrowser"
---

<objective>
Build the depot browser UI: tree component with lazy-loaded subdirectories, accordion left column layout wrapping workspace files and depot sections.

Purpose: This is the core depot browsing experience — users see depot roots, expand folders on demand, and the depot tree coexists with workspace files in the left column.
Output: Working depot tree with lazy loading in accordion left column.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/14-depot-browser/14-CONTEXT.md
@.planning/phases/14-depot-browser/14-RESEARCH.md
@.planning/phases/14-depot-browser/14-01-SUMMARY.md

@src/components/FileTree/FileTree.tsx (pattern: react-arborist tree usage)
@src/components/FileTree/FileNode.tsx (pattern: node renderer)
@src/components/FileTree/useFileTree.ts (pattern: tree data hook)
@src/components/MainLayout.tsx (left column to restructure)
@src/components/ui/collapsible.tsx (Radix Collapsible component)
@src/lib/tauri.ts (invokeP4Dirs, invokeP4Depots from Plan 01)
@src/stores/connectionStore.ts (p4port, p4user, p4client)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDepotTree hook and DepotNode renderer</name>
  <files>src/components/DepotBrowser/useDepotTree.ts, src/components/DepotBrowser/DepotNode.tsx</files>
  <action>
**useDepotTree.ts:**
Create a hook that manages depot tree data with lazy loading.

Data model:
```typescript
export interface DepotNodeData {
  id: string;           // Depot path (e.g., "//depot/projects")
  name: string;         // Display name (last path segment)
  isFolder: boolean;    // Always true for dirs; files not loaded by default
  children: DepotNodeData[] | null;  // null = not yet loaded, [] = loaded but empty
}
```

Implementation:
- Use `useQuery` with key `['depot', 'roots']` to fetch depot roots via `invokeP4Depots()` on mount
- Transform depot roots into `DepotNodeData[]` (each root: `id: "//${name}", name, isFolder: true, children: null`)
- Expose `loadChildren(depotPath: string)` async function that:
  1. Calls `invokeP4Dirs(depotPath + "/*")` via the connection store values
  2. Maps results to `DepotNodeData` items (extract last path segment for `name`, set `children: null`)
  3. Also calls `invokeP4Dirs` to check for files at that level — actually skip files for now, only show directories (files would need `p4 files` which is expensive). Just show folders.
  4. Updates the tree data in state (use `useState` or `useReducer` for tree data)
- Use TanStack Query for caching: `useQuery({ queryKey: ['depot', 'dirs', depotPath], queryFn: ... })` with `staleTime: 5 * 60 * 1000`
- Track loading state per node path in a `Set<string>` (loadingPaths)
- Return: `{ treeData, isLoading, error, loadChildren, loadingPaths }`

**DepotNode.tsx:**
Create the tree node renderer for react-arborist (follow FileNode.tsx pattern).

- Accept `NodeRendererProps<DepotNodeData>` from react-arborist
- Display: indent (via node.style) + expand chevron (if folder) + folder/file icon + name
- Use `Folder` / `FolderOpen` from lucide-react for folders
- Show a small spinner (or `Loader2` icon with animate-spin) when `loadingPaths.has(node.data.id)`
- On click: if folder, trigger expand/collapse (call `node.toggle()`)
- Style: match FileNode.tsx appearance (same padding, font size, hover states)
- Selected state: subtle highlight background (use a selectedDepotPath from parent or store)
  </action>
  <verify>Run `npx tsc --noEmit` — should compile without errors.</verify>
  <done>useDepotTree hook fetches depot roots and supports lazy loading children. DepotNode renders folder icons with expand/collapse.</done>
</task>

<task type="auto">
  <name>Task 2: Create DepotBrowser and restructure left column with accordion</name>
  <files>src/components/DepotBrowser/DepotBrowser.tsx, src/components/MainLayout.tsx</files>
  <action>
**DepotBrowser.tsx:**
Create the main depot browser component.

- Use react-arborist `<Tree>` component (same as FileTree.tsx)
- Pass `useDepotTree()` data as tree data
- Use `DepotNode` as the node renderer
- Virtualized: measure container height (same pattern as FileTree — useRef + ResizeObserver)
- `rowHeight={28}` (match FileTree)
- Handle `onToggle`: when user expands a folder node whose `children === null`, call `loadChildren(node.data.id)` then toggle
- Show loading state while depot roots are fetching (spinner or "Loading depots...")
- Show error state if depot roots fail ("Could not load depots" with retry button)
- Do NOT apply search filter (per CONTEXT.md — search only affects workspace files)

**MainLayout.tsx restructure:**
Wrap the left column content in accordion sections using Radix Collapsible.

1. Import `Collapsible, CollapsibleTrigger, CollapsibleContent` from `@/components/ui/collapsible`
2. Import `DepotBrowser` from `@/components/DepotBrowser/DepotBrowser`
3. Import `ChevronDown` from lucide-react (if not already imported)

Replace the left column content (currently just `<FileTree />`):
```tsx
<div style={{ width: `${leftWidth}px`, minWidth: '200px', flexShrink: 0 }} className="flex flex-col overflow-hidden">
  {/* Workspace Files Section */}
  <Collapsible open={workspaceOpen} onOpenChange={setWorkspaceOpen}>
    <CollapsibleTrigger className="flex items-center justify-between w-full px-3 py-1.5 text-xs font-semibold uppercase tracking-wider text-muted-foreground hover:bg-accent/50 cursor-pointer select-none">
      Workspace Files
      <ChevronDown className={cn("w-3.5 h-3.5 transition-transform", workspaceOpen && "rotate-180")} />
    </CollapsibleTrigger>
    <CollapsibleContent className="flex-1 min-h-0 overflow-hidden">
      <FileTree />
    </CollapsibleContent>
  </Collapsible>

  {/* Depot Section */}
  <Collapsible open={depotOpen} onOpenChange={setDepotOpen}>
    <CollapsibleTrigger className="flex items-center justify-between w-full px-3 py-1.5 text-xs font-semibold uppercase tracking-wider text-muted-foreground hover:bg-accent/50 cursor-pointer border-t border-border select-none">
      Depot
      <ChevronDown className={cn("w-3.5 h-3.5 transition-transform", depotOpen && "rotate-180")} />
    </CollapsibleTrigger>
    <CollapsibleContent className="flex-1 min-h-0 overflow-hidden">
      <DepotBrowser />
    </CollapsibleContent>
  </Collapsible>
</div>
```

4. Add state for accordion (use localStorage persistence):
```typescript
const [workspaceOpen, setWorkspaceOpen] = useState(() => {
  const saved = localStorage.getItem('accordion-workspace');
  return saved !== null ? saved === 'true' : true;
});
const [depotOpen, setDepotOpen] = useState(() => {
  const saved = localStorage.getItem('accordion-depot');
  return saved !== null ? saved === 'true' : true;
});

// Persist on change
useEffect(() => { localStorage.setItem('accordion-workspace', String(workspaceOpen)); }, [workspaceOpen]);
useEffect(() => { localStorage.setItem('accordion-depot', String(depotOpen)); }, [depotOpen]);
```

5. Import `cn` from `@/lib/utils` if not already imported.

**Important layout detail:** Both sections need to share the available height. When both are open, use flex layout so each gets roughly equal space. When one is collapsed, the other expands to fill. The flex-1 + min-h-0 + overflow-hidden pattern handles this.
  </action>
  <verify>
1. `npx tsc --noEmit` — compiles
2. `npm run tauri dev` — app loads, left column shows "Workspace Files" and "Depot" section headers
3. Clicking section headers collapses/expands each independently
4. Depot section shows depot roots (or loading/error state if no P4 server)
  </verify>
  <done>Left column has two collapsible sections. Depot browser shows roots and supports lazy-loading subdirectories on expand. Accordion state persists in localStorage.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Left column shows "Workspace Files" and "Depot" headers
3. Both sections independently collapse/expand
4. Depot roots load when Depot section is open
5. Expanding a depot folder loads its subdirectories
6. Accordion state persists across page refresh
7. Search filter does NOT affect depot tree
</verification>

<success_criteria>
- Depot tree renders with react-arborist virtualization
- Lazy loading works: expand folder -> children load via p4_dirs
- TanStack Query caches results (re-expand is instant)
- Accordion sections work independently with persist
- FileTree continues working unchanged in its section
</success_criteria>

<output>
After completion, create `.planning/phases/14-depot-browser/14-02-SUMMARY.md`
</output>
