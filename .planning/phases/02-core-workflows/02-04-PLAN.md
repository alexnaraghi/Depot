---
phase: 02-core-workflows
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/lib/tauri.ts
  - src/hooks/useFileOperations.ts
  - src/utils/treeBuilder.ts
autonomous: true

must_haves:
  truths:
    - "Frontend can invoke all new P4 backend commands"
    - "Tree data can be built from flat file list"
    - "File operations hook provides checkout/revert/submit actions"
  artifacts:
    - path: "src/lib/tauri.ts"
      provides: "P4 command invokers"
      exports: ["invokeP4Fstat", "invokeP4Edit", "invokeP4Revert", "invokeP4Submit", "invokeP4Sync", "invokeP4Opened", "invokeP4Changes"]
    - path: "src/hooks/useFileOperations.ts"
      provides: "File operation hook"
      exports: ["useFileOperations"]
    - path: "src/utils/treeBuilder.ts"
      provides: "Tree building utilities"
      exports: ["buildFileTree", "buildChangelistTree"]
  key_links:
    - from: "src/hooks/useFileOperations.ts"
      to: "src/lib/tauri.ts"
      via: "invoke functions"
      pattern: "invokeP4Edit"
    - from: "src/hooks/useFileOperations.ts"
      to: "src/stores/fileTreeStore.ts"
      via: "store updates"
      pattern: "useFileTreeStore"
---

<objective>
Create frontend TypeScript functions to invoke new backend commands, utilities to build tree data structures, and a hook for file operations.

Purpose: Bridge the gap between backend commands and UI components. The tree builder converts flat file lists into hierarchical structures for react-arborist. The operations hook provides a clean API for UI components.

Output: Extended tauri.ts with new invokers, tree building utilities, and useFileOperations hook.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-workflows/02-CONTEXT.md
@src/lib/tauri.ts
@src/hooks/useP4Command.ts
@src/types/p4.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add P4 command invokers to tauri.ts</name>
  <files>src/lib/tauri.ts</files>
  <action>
Extend tauri.ts with typed invoke functions for new backend commands:

**Types to add:**
```typescript
export interface P4FileInfo {
  depot_path: string;
  local_path: string;
  status: string;
  action?: string;
  revision: number;
  head_revision: number;
  changelist?: number;
  file_type: string;
}

export interface P4ChangelistInfo {
  id: number;
  description: string;
  user: string;
  client: string;
  status: string;
  file_count: number;
}

export interface SyncProgress {
  depot_path: string;
  action: string;
  revision: number;
  is_conflict: boolean;
}
```

**Functions to add:**

```typescript
// Get file status for paths (or all workspace files if empty)
export async function invokeP4Fstat(paths: string[] = []): Promise<P4FileInfo[]> {
  return invoke<P4FileInfo[]>('p4_fstat', { paths });
}

// Get all opened files
export async function invokeP4Opened(): Promise<P4FileInfo[]> {
  return invoke<P4FileInfo[]>('p4_opened');
}

// Get changelists
export async function invokeP4Changes(status?: string): Promise<P4ChangelistInfo[]> {
  return invoke<P4ChangelistInfo[]>('p4_changes', { status });
}

// Edit (checkout) files
export async function invokeP4Edit(paths: string[], changelist?: number): Promise<P4FileInfo[]> {
  return invoke<P4FileInfo[]>('p4_edit', { paths, changelist });
}

// Revert files
export async function invokeP4Revert(paths: string[]): Promise<string[]> {
  return invoke<string[]>('p4_revert', { paths });
}

// Submit changelist
export async function invokeP4Submit(changelist: number, description?: string): Promise<number> {
  return invoke<number>('p4_submit', { changelist, description });
}

// Sync with streaming progress
export async function invokeP4Sync(
  paths: string[],
  onProgress: (progress: SyncProgress) => void
): Promise<string> {
  const channel = new Channel<SyncProgress>();
  channel.onmessage = onProgress;
  return invoke<string>('p4_sync', { paths, onProgress: channel });
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/tauri.ts`</verify>
  <done>All P4 invoke functions exported with proper typing</done>
</task>

<task type="auto">
  <name>Task 2: Create tree building utilities</name>
  <files>src/utils/treeBuilder.ts</files>
  <action>
Create utilities to convert flat file lists into hierarchical tree structures:

**buildFileTree function:**
```typescript
import { P4File } from '@/types/p4';

export interface FileTreeNode {
  id: string;
  name: string;
  isFolder: boolean;
  file?: P4File;
  children?: FileTreeNode[];
}

export function buildFileTree(files: P4File[], rootPath: string): FileTreeNode[] {
  // 1. Create a map of path -> node
  // 2. For each file, split path into segments
  // 3. Create folder nodes for each segment that doesn't exist
  // 4. Add file as leaf node
  // 5. Return top-level children (relative to rootPath)
}
```

**Algorithm:**
1. Sort files by depot path
2. For each file:
   - Get relative path from rootPath
   - Split into segments: ['src', 'components', 'App.tsx']
   - For each segment except last, ensure folder node exists
   - Add file node as child of last folder
3. Return root children array

**buildChangelistTree function:**
```typescript
import { P4Changelist, P4File } from '@/types/p4';

export interface ChangelistTreeNode {
  id: string;
  name: string;
  type: 'changelist' | 'file';
  data: P4Changelist | P4File;
  children?: ChangelistTreeNode[];
}

export function buildChangelistTree(changelists: P4Changelist[]): ChangelistTreeNode[] {
  // Convert changelists to tree nodes
  // Each changelist is a parent node
  // Each file in changelist is a child node
}
```

**Helper functions:**
```typescript
// Get file name from depot path
export function getFileName(depotPath: string): string {
  return depotPath.split('/').pop() || depotPath;
}

// Get folder path from depot path
export function getFolderPath(depotPath: string): string {
  const parts = depotPath.split('/');
  parts.pop();
  return parts.join('/');
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/utils/treeBuilder.ts`</verify>
  <done>buildFileTree and buildChangelistTree convert flat data to tree structure</done>
</task>

<task type="auto">
  <name>Task 3: Create useFileOperations hook</name>
  <files>src/hooks/useFileOperations.ts</files>
  <action>
Create hook that wraps P4 file operations with state management:

```typescript
import { useCallback } from 'react';
import { useOperationStore } from '@/store/operation';
import { useFileTreeStore } from '@/stores/fileTreeStore';
import { invokeP4Edit, invokeP4Revert, invokeP4Submit } from '@/lib/tauri';
import toast from 'react-hot-toast';

export function useFileOperations() {
  const { startOperation, completeOperation, updateMessage } = useOperationStore();
  const { updateFile } = useFileTreeStore();

  const checkout = useCallback(async (paths: string[], changelist?: number) => {
    const operationId = `edit-${Date.now()}`;
    startOperation(operationId, `Checking out ${paths.length} file(s)`);

    try {
      const result = await invokeP4Edit(paths, changelist);

      // Update store with new file status (after server confirmation)
      for (const file of result) {
        updateFile(file.depot_path, {
          status: 'checkedOut',
          action: file.action,
          changelist: file.changelist,
        });
      }

      completeOperation(true);
      toast.success(`Checked out ${result.length} file(s)`);
      return result;
    } catch (error) {
      completeOperation(false, String(error));
      toast.error(`Checkout failed: ${error}`);
      throw error;
    }
  }, [startOperation, completeOperation, updateFile]);

  const revert = useCallback(async (paths: string[]) => {
    const operationId = `revert-${Date.now()}`;
    startOperation(operationId, `Reverting ${paths.length} file(s)`);

    try {
      const reverted = await invokeP4Revert(paths);

      // Update store: reverted files are now synced
      for (const depotPath of reverted) {
        updateFile(depotPath, {
          status: 'synced',
          action: undefined,
          changelist: undefined,
        });
      }

      completeOperation(true);
      toast.success(`Reverted ${reverted.length} file(s)`);
      return reverted;
    } catch (error) {
      completeOperation(false, String(error));
      toast.error(`Revert failed: ${error}`);
      throw error;
    }
  }, [startOperation, completeOperation, updateFile]);

  const submit = useCallback(async (changelist: number, description?: string) => {
    const operationId = `submit-${Date.now()}`;
    startOperation(operationId, `Submitting changelist ${changelist}`);

    try {
      const submittedCl = await invokeP4Submit(changelist, description);
      completeOperation(true);
      toast.success(`Submitted as changelist ${submittedCl}`);
      return submittedCl;
    } catch (error) {
      completeOperation(false, String(error));
      toast.error(`Submit failed: ${error}`);
      throw error;
    }
  }, [startOperation, completeOperation]);

  return {
    checkout,
    revert,
    submit,
  };
}
```

Key points:
- Use operation store for status bar feedback
- Update file tree store AFTER server confirms (no optimistic updates per CONTEXT.md)
- Show toast notifications for success/failure
- Return result for caller to use if needed
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/hooks/useFileOperations.ts`</verify>
  <done>useFileOperations provides checkout, revert, submit with proper state management</done>
</task>

</tasks>

<verification>
- tauri.ts has all new invoke functions
- treeBuilder.ts converts flat lists to trees correctly
- useFileOperations integrates with operation store and file tree store
- No optimistic updates (store updates after server confirmation)
</verification>

<success_criteria>
- Frontend can call all P4 backend commands with typed results
- Tree data structures are properly built from flat file lists
- File operations update UI state after server confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-workflows/02-04-SUMMARY.md`
</output>
