---
phase: 25-batch-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/commands/p4/types.rs
  - src-tauri/src/commands/p4/p4handlers.rs
  - src-tauri/src/commands/p4/parsing.rs
  - src-tauri/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "p4_describe_shelved_batch command accepts multiple changelist IDs"
    - "Command sends progress updates via Channel during processing"
    - "When one CL fails to load, other CLs' shelved files are still returned (partial success supported)"
    - "Command is registered with ProcessManager for cancellation"
  artifacts:
    - path: "src-tauri/src/commands/p4/types.rs"
      provides: "ShelvedBatchProgress enum, ShelvedBatchResult struct"
      contains: "ShelvedBatchProgress"
    - path: "src-tauri/src/commands/p4/p4handlers.rs"
      provides: "p4_describe_shelved_batch Tauri command"
      contains: "p4_describe_shelved_batch"
    - path: "src-tauri/src/commands/p4/parsing.rs"
      provides: "parse_describe_shelved_batch function"
      contains: "parse_describe_shelved_batch"
    - path: "src-tauri/src/lib.rs"
      provides: "Command registration"
      contains: "p4_describe_shelved_batch"
  key_links:
    - from: "p4handlers.rs:p4_describe_shelved_batch"
      to: "parsing.rs:parse_describe_shelved_batch"
      via: "function call"
      pattern: "parse_describe_shelved_batch"
    - from: "p4handlers.rs:p4_describe_shelved_batch"
      to: "ProcessManager::register"
      via: "state.register(child)"
      pattern: "state\\.register"
---

<objective>
Create backend batch command for shelved file queries

Purpose: Replace N individual p4 describe calls with single batched command that processes multiple changelists, provides progress feedback, and isolates errors per changelist.

Output: New Tauri command `p4_describe_shelved_batch` with streaming Channel output, registered in lib.rs
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-batch-optimization/25-RESEARCH.md
@src-tauri/src/commands/p4/p4handlers.rs (lines 82-218 for p4_fstat_stream pattern)
@src-tauri/src/commands/p4/types.rs
@src-tauri/src/commands/p4/parsing.rs (parse_ztag_describe_shelved for single CL)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch types to types.rs</name>
  <files>src-tauri/src/commands/p4/types.rs</files>
  <action>
Add two new types after existing P4ShelvedFile struct:

1. ShelvedBatchResult - result for a single CL in batch:
   - changelist_id: i32
   - files: Option<Vec<P4ShelvedFile>> (None on error)
   - error: Option<String> (Some if this CL failed)

2. ShelvedBatchProgress - enum for Channel streaming (follow FstatStreamBatch pattern):
   - Progress { loaded: u32, total: u32, message: String }
   - Result { result: ShelvedBatchResult }
   - Complete { success_count: u32, error_count: u32, cancelled: bool }

Use #[serde(tag = "type", rename_all = "camelCase")] for enum.
Use #[serde(rename_all = "camelCase")] for struct.
Both need #[derive(Clone, Serialize)].
  </action>
  <verify>cargo check --package p4now passes</verify>
  <done>Types ShelvedBatchResult and ShelvedBatchProgress exist in types.rs with correct serde attributes</done>
</task>

<task type="auto">
  <name>Task 2: Add batch parsing function to parsing.rs</name>
  <files>src-tauri/src/commands/p4/parsing.rs</files>
  <action>
Add new function parse_describe_shelved_batch that handles multi-CL output.

Key implementation details (from RESEARCH.md):
1. Use existing parse_ztag_records() to get record blocks
2. Track current CL context via "change" field
3. When new "change" field appears, flush previous CL's files
4. Extract shelved files using depotFile{N}, action{N}, type{N}, rev{N} indexed fields
5. Return HashMap<i32, Vec<P4ShelvedFile>>

The function signature:
```rust
pub fn parse_describe_shelved_batch(output: &str) -> HashMap<i32, Vec<P4ShelvedFile>>
```

IMPORTANT: Field indices (depotFile0, depotFile1) reset per changelist. Track CL boundaries using the "change" field in each record.

Reference existing parse_ztag_describe_shelved for single-CL parsing logic - extend it to handle multiple CL contexts.
  </action>
  <verify>cargo check --package p4now passes</verify>
  <done>parse_describe_shelved_batch function exists and handles multi-CL -ztag output correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add p4_describe_shelved_batch command to p4handlers.rs</name>
  <files>src-tauri/src/commands/p4/p4handlers.rs, src-tauri/src/lib.rs</files>
  <action>
Add new Tauri command p4_describe_shelved_batch following p4_fstat_stream pattern:

1. Command signature:
```rust
#[tauri::command]
pub async fn p4_describe_shelved_batch(
    changelist_ids: Vec<i32>,
    server: Option<String>,
    user: Option<String>,
    client: Option<String>,
    on_progress: Channel<ShelvedBatchProgress>,
    state: State<'_, ProcessManager>,
) -> Result<String, String>
```

2. Build command: p4 -ztag describe -s -S [cl1] [cl2] ...
   - -ztag for structured output
   - -s suppresses diffs
   - -S shows shelved files

3. Spawn process with stdout/stderr piped

4. Register with ProcessManager for cancellation: state.register(child).await

5. Spawn tokio task for stdout parsing:
   - Read entire stdout (small payload for CLs)
   - Call parse_describe_shelved_batch
   - Send Progress updates every 5 CLs processed
   - Send Result for each CL
   - Send Complete with counts

6. Handle stderr - CRITICAL error isolation:
   - Check stderr for known empty-result messages: "no shelved files", "not shelved", "no shelf"
   - For these messages: create ShelvedBatchResult with files: Some(vec![]), error: None
   - Only set error field for actual errors (network failures, auth errors, invalid CL format)
   - Actual errors logged but don't fail batch - continue processing other CLs

7. Return process_id immediately (fire-and-forget pattern)

Add to lib.rs .invoke_handler() macro alongside other p4 commands.

Progress update frequency: Every 5 CLs or on completion. Use try_send() for Progress (non-blocking), send() for Result (must deliver).
  </action>
  <verify>
1. cargo check --package p4now passes
2. grep "p4_describe_shelved_batch" src-tauri/src/lib.rs shows command registered
  </verify>
  <done>
1. p4_describe_shelved_batch command exists in p4handlers.rs
2. Command registered in lib.rs invoke_handler
3. Command uses Channel for streaming, ProcessManager for cancellation
4. Errors isolated per changelist
  </done>
</task>

</tasks>

<verification>
1. cargo build --package p4now succeeds
2. New types visible in types.rs
3. parse_describe_shelved_batch handles multi-CL output
4. p4_describe_shelved_batch command registered and callable
</verification>

<success_criteria>
- Backend batch command compiles and is registered
- Command accepts Vec<i32> changelist IDs
- Command sends ShelvedBatchProgress via Channel
- Errors isolated per CL (batch continues on individual failures)
- Process registered for cancellation
</success_criteria>

<output>
After completion, create `.planning/phases/25-batch-optimization/25-01-SUMMARY.md`
</output>
