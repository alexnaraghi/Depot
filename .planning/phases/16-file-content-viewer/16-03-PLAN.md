---
phase: 16-file-content-viewer
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/components/DetailPane/FileSizeWarningDialog.tsx
  - src/hooks/useFileInfo.ts
  - src/components/DetailPane/FileContentViewer.tsx
autonomous: true

must_haves:
  truths:
    - "User sees size warning before loading large files with option to proceed"
    - "Binary files show error message with Open in External Editor option"
    - "Files over 10MB show error and cannot be loaded in-app"
  artifacts:
    - path: "src/components/DetailPane/FileSizeWarningDialog.tsx"
      provides: "Warning dialog for large file loading confirmation"
      exports: ["FileSizeWarningDialog"]
    - path: "src/hooks/useFileInfo.ts"
      provides: "Hook to get file metadata (size, type) from p4 fstat"
      exports: ["useFileInfo"]
  key_links:
    - from: "src/components/DetailPane/FileContentViewer.tsx"
      to: "src/hooks/useFileInfo.ts"
      via: "useFileInfo call for pre-load validation"
      pattern: "useFileInfo"
    - from: "src/components/DetailPane/FileContentViewer.tsx"
      to: "src/components/DetailPane/FileSizeWarningDialog.tsx"
      via: "Dialog rendered for large file confirmation"
      pattern: "FileSizeWarningDialog"
---

<objective>
Add file size validation and warning dialog for large files.

Purpose: Prevent memory exhaustion and UI freezing from loading large or binary files.
Output: Size validation with warning dialog, binary file detection, graceful error handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-file-content-viewer/16-RESEARCH.md
@.planning/phases/16-file-content-viewer/16-01-SUMMARY.md
@src/components/DetailPane/FileContentViewer.tsx
@src/lib/tauri.ts (invokeP4Fstat)
@src/components/ui/alert-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFileInfo hook and FileSizeWarningDialog</name>
  <files>src/hooks/useFileInfo.ts, src/components/DetailPane/FileSizeWarningDialog.tsx</files>
  <action>
1. Create src/hooks/useFileInfo.ts:
   - Use TanStack Query with queryKey ['file-info', depotPath, revision]
   - Call invokeP4Fstat with revision specifier: `${depotPath}#${revision}`
   - Return structured object: { fileSize: number, fileType: string, isBinary: boolean }
   - Parse file_size from fstat result (it's a string, convert to number)
   - Detect binary: fileType includes 'binary' or 'ubinary' or 'apple' or 'resource'
   - Handle missing file gracefully (throw error with "File not found")
   - Set staleTime to 5 * 60 * 1000 (5 min) - file info rarely changes

2. Create src/components/DetailPane/FileSizeWarningDialog.tsx:
   - Use AlertDialog from @radix-ui/react-alert-dialog (existing component)
   - Props: open (boolean), fileSize (number), onConfirm (callback), onCancel (callback)
   - Display file size in human-readable format (e.g., "2.5 MB")
   - Warning message: "This file is {size}. Loading large files may be slow."
   - Two buttons: "Cancel" (secondary) and "Load Anyway" (primary)
   - Style consistent with existing dialogs in codebase

Helper function for human-readable size:
```typescript
function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
}
```
  </action>
  <verify>
- TypeScript compiles without errors
- useFileInfo returns correct structure when called
- FileSizeWarningDialog renders with proper styling
  </verify>
  <done>Hook returns file metadata, dialog displays file size warning with confirmation options</done>
</task>

<task type="auto">
  <name>Task 2: Integrate size validation into FileContentViewer</name>
  <files>src/components/DetailPane/FileContentViewer.tsx</files>
  <action>
Update FileContentViewer.tsx to implement two-stage loading with validation:

1. Add constants at top of file:
   ```typescript
   const MAX_AUTO_LOAD_SIZE = 1 * 1024 * 1024; // 1MB auto-load threshold
   const MAX_VIEWABLE_SIZE = 10 * 1024 * 1024; // 10MB absolute limit
   ```

2. Add state: const [userConfirmedLargeFile, setUserConfirmedLargeFile] = useState(false)

3. Use useFileInfo hook to get file metadata first (always enabled)

4. Implement conditional rendering logic:
   a. If loading file info: show loading spinner
   b. If fileInfo.isBinary: show binary file error with "Open in External Editor" button
      - Use AlertTriangle icon from lucide-react
      - Message: "Cannot view binary files ({fileType}). Use external editor."
      - Button: "Open in External Editor" (uses openPath from @tauri-apps/plugin-opener)
   c. If fileSize > MAX_VIEWABLE_SIZE: show size error
      - Message: "File too large to view ({size}). Maximum is 10MB."
      - Button: "Open in External Editor"
   d. If fileSize > MAX_AUTO_LOAD_SIZE && !userConfirmedLargeFile: show FileSizeWarningDialog
      - onConfirm: setUserConfirmedLargeFile(true)
      - onCancel: do nothing (user can click Hide Content to close)
   e. Otherwise: proceed with useFileContent (enabled when validation passes)

5. Update useFileContent enabled condition:
   ```typescript
   const shouldLoadContent = fileInfo &&
     !fileInfo.isBinary &&
     fileInfo.fileSize <= MAX_VIEWABLE_SIZE &&
     (fileInfo.fileSize <= MAX_AUTO_LOAD_SIZE || userConfirmedLargeFile);
   ```

6. Reset userConfirmedLargeFile when depotPath or revision changes (useEffect)

Reference Pattern 2 from 16-RESEARCH.md for the flow.
  </action>
  <verify>
- Test with small text file (<1MB): loads automatically
- Test with medium file (1-10MB): shows warning dialog, loads on confirm
- Test with large file (>10MB): shows error with external editor option
- Test with binary file: shows binary error with external editor option
  </verify>
  <done>FileContentViewer validates file size and type before loading, shows appropriate warnings</done>
</task>

</tasks>

<verification>
1. Find or create test files of various sizes:
   - Small text file (<100KB)
   - Medium text file (1-5MB)
   - Large text file (>10MB) if available
   - Binary file (image, compiled binary)
2. Navigate to revision detail for each file type
3. Verify:
   - Small file: loads automatically with syntax highlighting
   - Medium file: shows warning dialog, clicking "Load Anyway" loads content
   - Large file: shows error "File too large", "Open in External Editor" button works
   - Binary file: shows error "Cannot view binary files", "Open in External Editor" button works
4. Verify state resets when navigating to different revision
</verification>

<success_criteria>
- Files <1MB load automatically without warning
- Files 1-10MB show warning dialog before loading
- Files >10MB show error and cannot be loaded in-app
- Binary files detected and show appropriate error
- "Open in External Editor" button works for all error cases
- User confirmation state resets on navigation
</success_criteria>

<output>
After completion, create `.planning/phases/16-file-content-viewer/16-03-SUMMARY.md`
</output>
