---
phase: 20-bug-fixes-and-ui-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useShelvedFiles.ts
  - src/components/ChangelistPanel/EditDescriptionDialog.tsx
autonomous: true

must_haves:
  truths:
    - "Shelve operation updates the shelved files list and pending files list in the UI"
    - "Unshelve operation updates the shelved files list and opened files list in the UI"
    - "Delete shelf operation updates the shelved files list in the UI"
    - "Default CL description edit creates new CL and moves files, UI updates immediately"
  artifacts:
    - path: "src/hooks/useShelvedFiles.ts"
      provides: "Properly awaited query invalidations in shelve/delete mutations"
    - path: "src/components/ChangelistPanel/EditDescriptionDialog.tsx"
      provides: "Properly awaited query invalidations after CL creation"
  key_links:
    - from: "src/hooks/useShelvedFiles.ts"
      to: "TanStack Query cache"
      via: "await queryClient.invalidateQueries()"
      pattern: "await.*invalidateQueries"
---

<objective>
Fix query invalidation patterns in shelve/unshelve mutations and EditDescriptionDialog so the UI reliably updates after operations complete.

Purpose: Operations succeed but UI doesn't reflect changes, breaking user trust. The root cause is fire-and-forget `Promise.all` calls without `await`.
Output: All mutation success handlers properly await query invalidations.
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/hooks/useShelvedFiles.ts
@src/components/ChangelistPanel/EditDescriptionDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix shelve and delete shelf query invalidations</name>
  <files>src/hooks/useShelvedFiles.ts</files>
  <action>
Fix two mutation hooks in useShelvedFiles.ts where query invalidations are not awaited:

**Fix 1 - useShelve (around line 58-66):**
Change `onSuccess` to be async and await the invalidations:

```tsx
onSuccess: async (data, variables) => {
  addOutputLine(String(data), false);
  toast.success(`Shelved ${variables.filePaths.length} file(s)`);
  await Promise.all([
    queryClient.invalidateQueries({ queryKey: ['p4', 'shelved'] }),
    queryClient.invalidateQueries({ queryKey: ['p4', 'opened'] }),
    queryClient.invalidateQueries({ queryKey: ['p4', 'changes'] }),
  ]);
},
```

The key change: add `async` to onSuccess and `await` before `Promise.all`.

**Fix 2 - useDeleteShelf (around line 178-182):**
Change `onSuccess` to be async and await the invalidation:

```tsx
onSuccess: async (data) => {
  addOutputLine(String(data), false);
  toast.success('Deleted shelf successfully');
  await queryClient.invalidateQueries({ queryKey: ['p4', 'shelved'] });
},
```

Note: `useUnshelve` (line 128) already correctly uses `async` and `await Promise.all` â€” no change needed there.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Grep the file for any remaining non-awaited `invalidateQueries` calls:
```bash
grep -n "invalidateQueries" src/hooks/useShelvedFiles.ts
```
Every `invalidateQueries` call should be preceded by `await`.
  </verify>
  <done>All query invalidations in useShelvedFiles.ts are properly awaited. Shelve and delete shelf operations cause immediate UI updates.</done>
</task>

<task type="auto">
  <name>Task 2: Fix EditDescriptionDialog query invalidations</name>
  <files>src/components/ChangelistPanel/EditDescriptionDialog.tsx</files>
  <action>
Fix two fire-and-forget invalidation patterns in EditDescriptionDialog.tsx:

**Fix 1 - Default CL creation (around lines 78-82):**
Add `await` before the `Promise.all` for invalidations after creating a new CL from default:

```tsx
// Invalidate both changes and opened queries
await Promise.all([
  queryClient.invalidateQueries({ queryKey: ['p4', 'changes'] }),
  queryClient.invalidateQueries({ queryKey: ['p4', 'opened'] }),
]);
```

**Fix 2 - Named CL description edit (around line 91):**
Add `await` before the invalidation:

```tsx
await queryClient.invalidateQueries({ queryKey: ['p4', 'changes'] });
```

The `handleSubmit` function is already `async`, so adding `await` is safe and requires no other changes.
  </action>
  <verify>
Run `npx tsc --noEmit`. Grep for non-awaited invalidations:
```bash
grep -n "invalidateQueries" src/components/ChangelistPanel/EditDescriptionDialog.tsx
```
All calls should have `await` prefix.
  </verify>
  <done>All query invalidations in EditDescriptionDialog are properly awaited. Creating a numbered CL from default, and editing CL descriptions, cause immediate UI updates.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. All `invalidateQueries` calls in both files are awaited
3. Shelve/unshelve/delete shelf operations should immediately update UI
4. Editing default CL description creates numbered CL and UI reflects immediately
</verification>

<success_criteria>
- Shelve/unshelve operations update shelved files list and pending files list without manual refresh
- Delete shelf removes shelved files from UI immediately
- Default CL description edit creates new CL and moves files with immediate UI update
</success_criteria>

<output>
After completion, create `.planning/phases/20-bug-fixes-and-ui-polish/20-02-SUMMARY.md`
</output>
