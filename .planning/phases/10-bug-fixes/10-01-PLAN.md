---
phase: 10-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ChangelistPanel/ChangelistPanel.tsx
  - src/components/ChangelistPanel/EditDescriptionDialog.tsx
  - src/components/MainLayout.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag files between changelists without files disappearing or snapping back"
    - "User can edit default CL description and files automatically move to the new numbered CL"
    - "User can click Refresh button and all workspace data updates immediately"
  artifacts:
    - path: "src/components/ChangelistPanel/ChangelistPanel.tsx"
      provides: "Optimistic drag-drop with rollback on error"
      contains: "cancelQueries"
    - path: "src/components/ChangelistPanel/EditDescriptionDialog.tsx"
      provides: "File movement from default CL to new numbered CL"
      contains: "invokeP4Reopen"
    - path: "src/components/MainLayout.tsx"
      provides: "Manual refresh with full query invalidation"
      contains: "refetchType"
  key_links:
    - from: "EditDescriptionDialog.tsx"
      to: "invokeP4Reopen"
      via: "move default CL files after creating numbered CL"
      pattern: "invokeP4Reopen"
    - from: "MainLayout.tsx"
      to: "queryClient.invalidateQueries"
      via: "refetchType: 'all' for immediate refetch"
      pattern: "refetchType.*all"
---

<objective>
Fix three frontend bugs: drag-and-drop reliability (BUGF-01), default CL edit file movement (BUGF-02), and manual refresh (RFSH-02).

Purpose: Stabilize the three most common user-facing operations that currently have race conditions or missing behavior.
Output: Reliable drag-drop with optimistic UI, default CL edit that moves files, and working refresh button.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-bug-fixes/10-RESEARCH.md

@src/components/ChangelistPanel/ChangelistPanel.tsx
@src/components/ChangelistPanel/EditDescriptionDialog.tsx
@src/components/MainLayout.tsx
@src/lib/tauri.ts
@src/hooks/useShelvedFiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix drag-and-drop with optimistic UI and rollback</name>
  <files>src/components/ChangelistPanel/ChangelistPanel.tsx</files>
  <action>
Rewrite the `handleMove` callback in ChangelistPanel.tsx to use TanStack Query's optimistic update pattern:

1. Before the backend call, cancel outgoing refetches with `queryClient.cancelQueries({ queryKey: ['p4', 'opened'] })` and `queryClient.cancelQueries({ queryKey: ['p4', 'changes'] })`.
2. Snapshot current query data for both `['p4', 'opened']` and `['p4', 'changes']` using `queryClient.getQueryData()`.
3. Execute the `invokeP4Reopen` call (keep existing logic for extracting depot paths from dragIds).
4. On success, invalidate both queries to refetch fresh data.
5. On error, rollback by calling `queryClient.setQueryData()` with the snapshots, show error toast.
6. Remove the duplicate invalidation from the catch block (currently invalidates on both success and error, which defeats the rollback).

The key change is adding `cancelQueries` before the operation and `setQueryData` rollback on error. The existing depot path extraction logic from dragIds is correct and should be preserved.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify the handleMove function contains `cancelQueries`, `getQueryData` (snapshot), and `setQueryData` (rollback in catch block).
  </verify>
  <done>handleMove cancels outgoing queries before reopen, snapshots data for rollback, and restores on error instead of re-invalidating.</done>
</task>

<task type="auto">
  <name>Task 2: Fix default CL edit to move files + fix refresh button</name>
  <files>src/components/ChangelistPanel/EditDescriptionDialog.tsx, src/components/MainLayout.tsx</files>
  <action>
**EditDescriptionDialog.tsx (BUGF-02):**

In the `handleSubmit` function, after the `invokeP4CreateChange` call for the default CL case (changelist.id === 0):

1. Add import for `invokeP4Opened` and `invokeP4Reopen` from `@/lib/tauri`.
2. After creating the new numbered CL, query opened files with `invokeP4Opened(p4port, p4user, p4client)`.
3. Filter for files in the default CL: `openedFiles.filter(f => f.changelist === 0)` (the `changelist` field on P4OpenedFile is the CL number, 0 = default).
4. If any default CL files exist, call `invokeP4Reopen(defaultClFiles.map(f => f.depot_path), newClId, ...)` to move them.
5. Also invalidate `['p4', 'opened']` in addition to the existing `['p4', 'changes']` invalidation (currently only invalidates changes).
6. Update the success toast to show file count: `Created changelist #${newClId} with ${count} files`.

**MainLayout.tsx (RFSH-02):**

In the `handleRefresh` function (line ~57-64):

1. Replace `await queryClient.invalidateQueries()` (blanket invalidation) with targeted invalidation using `refetchType: 'all'`:
   ```typescript
   await Promise.all([
     queryClient.invalidateQueries({ queryKey: ['p4', 'opened'], refetchType: 'all' }),
     queryClient.invalidateQueries({ queryKey: ['p4', 'changes'], refetchType: 'all' }),
     queryClient.invalidateQueries({ queryKey: ['p4', 'shelved'], refetchType: 'all' }),
   ]);
   ```
2. Add a success toast after refresh: `toast.success('Workspace refreshed')`.
3. Add import for `toast` from `react-hot-toast` if not already imported.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify EditDescriptionDialog imports invokeP4Opened and invokeP4Reopen. Verify MainLayout handleRefresh uses refetchType: 'all'.
  </verify>
  <done>Default CL edit moves files to new numbered CL via p4 reopen. Refresh button uses targeted invalidation with refetchType: 'all' and shows success toast.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. `npm run lint` passes (if configured)
3. ChangelistPanel.tsx handleMove contains: cancelQueries, getQueryData (2 snapshots), setQueryData (2 rollbacks in catch)
4. EditDescriptionDialog.tsx default CL branch contains: invokeP4Opened, invokeP4Reopen, filter for changelist === 0
5. MainLayout.tsx handleRefresh contains: refetchType: 'all', toast.success
</verification>

<success_criteria>
- Drag-and-drop uses optimistic update pattern with rollback (cancelQueries + snapshot + setQueryData on error)
- Default CL edit moves files from default to new numbered CL after creation
- Refresh button forces immediate refetch of all workspace queries
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-bug-fixes/10-01-SUMMARY.md`
</output>
