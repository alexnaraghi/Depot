---
phase: 24-tree-performance-delta-refresh
plan: 02
type: execute
wave: 2
depends_on: [24-01]
files_modified:
  - src/utils/treeBuilder.ts
autonomous: true

must_haves:
  truths:
    - "Tree updates preserve object identity for unchanged subtrees"
    - "Incremental updates trigger when <10% of files change"
    - "Folder sync status re-aggregates only for modified branches"
  artifacts:
    - path: "src/utils/treeBuilder.ts"
      provides: "incrementalTreeUpdate function with Immer structural sharing"
      exports: ["buildFileTree", "incrementalTreeUpdate", "shouldUseIncrementalUpdate"]
  key_links:
    - from: "src/utils/treeBuilder.ts"
      to: "immer"
      via: "produce for structural sharing"
      pattern: "produce.*draft"
---

<objective>
Add incremental tree update function with Immer structural sharing to treeBuilder.

Purpose: When less than 10% of files change, update tree incrementally instead of full rebuild. Immer's produce() ensures unchanged subtrees keep same object references, so react-arborist doesn't re-render stable branches.
Output: incrementalTreeUpdate function, shouldUseIncrementalUpdate threshold helper, modified aggregateSyncStatus for partial re-aggregation
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-tree-performance-delta-refresh/24-CONTEXT.md
@.planning/phases/24-tree-performance-delta-refresh/24-RESEARCH.md
@.planning/phases/24-tree-performance-delta-refresh/24-01-SUMMARY.md
@src/utils/treeBuilder.ts
@src/types/p4.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add threshold helper and incremental update function</name>
  <files>
    src/utils/treeBuilder.ts
  </files>
  <action>
    1. Add import at top:
       ```typescript
       import { produce } from 'immer';
       ```

    2. Add threshold helper function (export it):
       ```typescript
       /**
        * Determine if incremental update should be used based on change volume.
        * If more than 10% of existing files changed, full rebuild is more efficient.
        *
        * @param existingFileCount - Current number of files in tree
        * @param changedFileCount - Number of files that changed
        * @returns true if incremental update should be used
        */
       export function shouldUseIncrementalUpdate(
         existingFileCount: number,
         changedFileCount: number
       ): boolean {
         if (existingFileCount === 0) return false; // No existing tree, need full build
         return changedFileCount < existingFileCount * 0.1;
       }
       ```

    3. Add incremental tree update function (export it):
       ```typescript
       /**
        * Update tree incrementally using Immer structural sharing.
        * Only modified branches get new references; unchanged subtrees preserve identity.
        *
        * @param tree - Existing tree structure
        * @param changedFiles - Map of depot path to updated P4File
        * @returns Updated tree with structural sharing
        */
       export function incrementalTreeUpdate(
         tree: FileTreeNode[],
         changedFiles: Map<string, P4File>
       ): FileTreeNode[] {
         if (changedFiles.size === 0) return tree;

         const modifiedFolders = new Set<string>();

         const updatedTree = produce(tree, draft => {
           function updateSubtree(nodes: FileTreeNode[], parentPath: string) {
             for (const node of nodes) {
               if (!node.isFolder && node.file) {
                 const update = changedFiles.get(node.file.depotPath);
                 if (update) {
                   // Immer tracks this mutation and creates new references up the tree
                   Object.assign(node.file, update);
                   // Track which folders need sync status re-aggregation
                   modifiedFolders.add(parentPath);
                 }
               }
               if (node.children) {
                 updateSubtree(node.children, node.id);
               }
             }
           }
           updateSubtree(draft, '');
         });

         // Re-aggregate sync status only for modified subtrees
         if (modifiedFolders.size > 0) {
           reAggregateSyncStatus(updatedTree, modifiedFolders);
         }

         return updatedTree;
       }
       ```

    4. Add helper to re-aggregate sync status for modified branches only:
       ```typescript
       /**
        * Re-aggregate sync status for folders that had file updates.
        * More efficient than full tree walk when only a few branches changed.
        */
       function reAggregateSyncStatus(
         tree: FileTreeNode[],
         modifiedFolders: Set<string>
       ): void {
         // For simplicity and correctness, re-aggregate from root when there are changes
         // The cost is O(n) but only runs when there are actual modifications
         // Future optimization: walk only modified branches
         tree.forEach(aggregateSyncStatus);
       }
       ```

    5. Export aggregateSyncStatus so it can be called from reAggregateSyncStatus:
       - Change `function aggregateSyncStatus` to `export function aggregateSyncStatus`
  </action>
  <verify>
    TypeScript compiles: npm run build
    grep "incrementalTreeUpdate\|shouldUseIncrementalUpdate" src/utils/treeBuilder.ts
    grep "produce.*draft" src/utils/treeBuilder.ts (shows Immer usage)
  </verify>
  <done>
    treeBuilder.ts exports incrementalTreeUpdate function using Immer produce()
    treeBuilder.ts exports shouldUseIncrementalUpdate threshold helper
    aggregateSyncStatus is exported for re-aggregation after updates
    Unchanged subtrees preserve object identity (===) after incremental updates
  </done>
</task>

<task type="auto">
  <name>Task 2: Add helper to merge delta files with existing Map</name>
  <files>
    src/utils/treeBuilder.ts
  </files>
  <action>
    Add helper function for merging delta results (export it):

    ```typescript
    /**
     * Merge delta (changed) files with existing file map.
     * Returns new Map with updates applied.
     *
     * @param existingFiles - Current file map
     * @param deltaFiles - Array of updated P4File objects
     * @returns New Map with delta files merged in
     */
    export function mergeDeltaFiles(
      existingFiles: Map<string, P4File>,
      deltaFiles: P4File[]
    ): Map<string, P4File> {
      if (deltaFiles.length === 0) return existingFiles;

      const merged = new Map(existingFiles);
      for (const file of deltaFiles) {
        merged.set(file.depotPath, file);
      }
      return merged;
    }

    /**
     * Create a change map from delta files for incremental tree update.
     * Compares with existing files to identify actual changes.
     *
     * @param existingFiles - Current file map
     * @param deltaFiles - Array of P4File from delta query
     * @returns Map of depot path to P4File for files that actually changed
     */
    export function createChangeMap(
      existingFiles: Map<string, P4File>,
      deltaFiles: P4File[]
    ): Map<string, P4File> {
      const changes = new Map<string, P4File>();

      for (const file of deltaFiles) {
        const existing = existingFiles.get(file.depotPath);
        if (!existing) {
          // New file
          changes.set(file.depotPath, file);
        } else if (
          existing.revision !== file.revision ||
          existing.headRevision !== file.headRevision ||
          existing.status !== file.status ||
          existing.action !== file.action ||
          existing.changelist !== file.changelist
        ) {
          // File changed
          changes.set(file.depotPath, file);
        }
        // If no changes detected, skip (preserves reference)
      }

      return changes;
    }
    ```

    This helper is used by useFileTree to:
    1. Create change map from delta query results
    2. Decide incremental vs full rebuild based on change count
    3. Apply incremental updates when appropriate
  </action>
  <verify>
    TypeScript compiles: npm run build
    grep "mergeDeltaFiles\|createChangeMap" src/utils/treeBuilder.ts
  </verify>
  <done>
    treeBuilder.ts exports mergeDeltaFiles for merging delta results
    treeBuilder.ts exports createChangeMap for identifying actual changes
    Change detection compares revision, headRevision, status, action, and changelist
  </done>
</task>

</tasks>

<verification>
npm run build (TypeScript compiles)
grep -E "export.*(incrementalTreeUpdate|shouldUseIncrementalUpdate|mergeDeltaFiles|createChangeMap)" src/utils/treeBuilder.ts
grep "from 'immer'" src/utils/treeBuilder.ts
</verification>

<success_criteria>
- treeBuilder.ts imports Immer and uses produce() for structural sharing
- incrementalTreeUpdate function updates tree nodes while preserving unchanged subtree references
- shouldUseIncrementalUpdate returns true when changed files < 10% of existing
- mergeDeltaFiles and createChangeMap helpers exported for delta refresh integration
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-tree-performance-delta-refresh/24-02-SUMMARY.md`
</output>
