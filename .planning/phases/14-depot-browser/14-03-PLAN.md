---
phase: 14-depot-browser
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - src/components/DepotBrowser/DepotContextMenu.tsx
  - src/components/DepotBrowser/DepotBrowser.tsx
  - src/components/DepotBrowser/DepotNode.tsx
  - src/stores/detailPaneStore.ts
autonomous: false

must_haves:
  truths:
    - "User can right-click depot folder/file to see context menu with sync, checkout, history options"
    - "User can sync a depot file/folder from context menu"
    - "Clicking a depot item shows file info in the center detail pane"
    - "User can right-click depot items to access checkout, history, diff operations"
  artifacts:
    - path: "src/components/DepotBrowser/DepotContextMenu.tsx"
      provides: "Context menu for depot file operations"
      exports: ["DepotContextMenu"]
  key_links:
    - from: "src/components/DepotBrowser/DepotContextMenu.tsx"
      to: "src/lib/tauri.ts"
      via: "invokeP4Sync, invokeP4Edit for depot operations"
      pattern: "invokeP4Sync|invokeP4Edit"
    - from: "src/components/DepotBrowser/DepotNode.tsx"
      to: "src/stores/detailPaneStore.ts"
      via: "selectFile on click to show depot file in detail pane"
      pattern: "selectFile|drillToFile"
---

<objective>
Add context menu operations and detail pane integration to the depot browser.

Purpose: Without context menu and detail pane, the depot tree is view-only. This plan makes it actionable — users can sync, checkout, view history, and inspect depot files.
Output: Fully interactive depot browser with context menu and detail pane integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/14-depot-browser/14-CONTEXT.md
@.planning/phases/14-depot-browser/14-02-SUMMARY.md

@src/components/FileTree/FileContextMenu.tsx (pattern: context menu structure)
@src/components/shared/FileContextMenuItems.tsx (shared menu items if exists)
@src/components/DepotBrowser/DepotBrowser.tsx (from Plan 02)
@src/components/DepotBrowser/DepotNode.tsx (from Plan 02)
@src/stores/detailPaneStore.ts (selectFile, DetailSelection)
@src/stores/connectionStore.ts (p4port, p4user, p4client)
@src/lib/tauri.ts (invokeP4Sync, invokeP4Edit, invokeP4Dirs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DepotContextMenu with file operations</name>
  <files>src/components/DepotBrowser/DepotContextMenu.tsx, src/components/DepotBrowser/DepotBrowser.tsx, src/components/DepotBrowser/DepotNode.tsx</files>
  <action>
**DepotContextMenu.tsx:**
Create a context menu for depot items (follow FileContextMenu.tsx pattern closely).

Props:
```typescript
interface DepotContextMenuProps {
  depotPath: string;
  isFolder: boolean;
  x: number;
  y: number;
  onClose: () => void;
}
```

Menu items (conditional on isFolder):
- **Sync to Workspace** (folders and files): Call `invokeP4Sync([depotPath], undefined, p4port, p4user, p4client, () => {})`. Show toast "Syncing..." then "Synced". Invalidate `['p4', 'opened']` and `['fileTree']` queries after success.
- **Checkout for Edit** (files only, not folders): Call `invokeP4Edit([depotPath], undefined, p4port, p4user, p4client)`. Toast "Checked out". Invalidate `['p4', 'opened']` queries.
- **File History** (files only): Navigate detail pane to file view: `useDetailPaneStore.getState().selectFile(depotPath, '')` (empty localPath since depot-only). The detail pane's FileDetailView will show history based on depotPath.
- **Copy Depot Path** (always): Copy depotPath to clipboard via `navigator.clipboard.writeText(depotPath)`. Toast "Copied".

Close behavior: close on click outside, Escape key, or after action (same pattern as FileContextMenu).

Style: Match FileContextMenu appearance — dark dropdown with hover highlights.

**DepotBrowser.tsx updates:**
- Add `contextMenu` state: `{ depotPath: string; isFolder: boolean; x: number; y: number } | null`
- Pass context menu handler down to DepotNode (or handle via onContextMenu on tree container)
- Render `<DepotContextMenu>` when contextMenu state is set

**DepotNode.tsx updates:**
- Add `onContextMenu` handler on the node row div:
  - `e.preventDefault()` + `e.stopPropagation()`
  - Call parent's `onContextMenu({ depotPath: node.data.id, isFolder: node.data.isFolder, x: e.clientX, y: e.clientY })`
- Add `onClick` handler for single click:
  - If file (not folder): call `useDetailPaneStore.getState().selectFile(node.data.id, '')` to show in detail pane
  - If folder: toggle expand/collapse (existing behavior)
  </action>
  <verify>
1. `npx tsc --noEmit` compiles
2. Right-click on depot item shows context menu
3. "Copy Depot Path" copies to clipboard
  </verify>
  <done>Context menu appears on right-click with Sync, Checkout (files), History (files), and Copy Path options. Each action calls the appropriate P4 command.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete depot browser with lazy-loaded tree, accordion layout, context menu, and detail pane integration</what-built>
  <how-to-verify>
1. Run `npm run tauri dev`
2. Verify left column shows "Workspace Files" and "Depot" as collapsible section headers
3. Click "Depot" header to collapse/expand — verify it toggles independently from "Workspace Files"
4. In Depot section, verify depot roots appear (e.g., "//depot")
5. Click a depot root to expand — verify subdirectories load (may take a moment)
6. Expand a subfolder — verify its children load lazily
7. Collapse and re-expand a folder — verify it loads instantly (cached)
8. Right-click a depot folder — verify context menu shows "Sync to Workspace" and "Copy Depot Path"
9. Right-click a depot folder — verify "Checkout" and "History" are NOT shown (folder-only)
10. Try "Copy Depot Path" — verify clipboard has the depot path
11. Refresh the page — verify accordion open/closed state is preserved
12. Verify workspace file tree search filtering does NOT affect the depot tree
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles
2. Context menu renders on right-click with correct items
3. Sync operation works from depot context menu
4. Detail pane shows file info when clicking depot items
5. Accordion state persists across refresh
6. Search filter does not affect depot tree
</verification>

<success_criteria>
- Right-click depot items shows context menu with sync, checkout, history, copy path
- Clicking depot file shows info in center detail pane
- All P4 operations from context menu work (sync, checkout invoke correct commands)
- Visual verification confirms full depot browsing workflow
</success_criteria>

<output>
After completion, create `.planning/phases/14-depot-browser/14-03-SUMMARY.md`
</output>
