---
phase: 01-non-blocking-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/components/StatusBar.tsx
  - src/components/OutputPanel.tsx
  - src/components/Toaster.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Status bar shows current operation message and progress"
    - "Cancel button appears only during cancellable operations"
    - "Output panel shows raw p4 command output"
    - "Output panel is collapsible (VS Code terminal style)"
    - "Toast notifications appear for errors without blocking UI"
  artifacts:
    - path: "src/components/StatusBar.tsx"
      provides: "Status bar component with progress and cancel"
      contains: "useOperationStore"
    - path: "src/components/OutputPanel.tsx"
      provides: "Collapsible output panel"
      contains: "Collapsible"
    - path: "src/components/Toaster.tsx"
      provides: "Toast notification container"
      contains: "Toaster"
    - path: "src/App.tsx"
      provides: "Main app layout with StatusBar and OutputPanel"
      contains: "StatusBar"
  key_links:
    - from: "src/components/StatusBar.tsx"
      to: "src/store/operation.ts"
      via: "useOperationStore hook"
      pattern: "useOperationStore"
    - from: "src/components/OutputPanel.tsx"
      to: "src/store/operation.ts"
      via: "useOperationStore.outputLines"
      pattern: "outputLines"
    - from: "src/App.tsx"
      to: "src/components/StatusBar.tsx"
      via: "Component import"
      pattern: "import.*StatusBar"
---

<objective>
Build UI components for operation feedback: status bar, collapsible output panel, and toast notifications

Purpose: Provide visual feedback for async operations per CONTEXT.md decisions (VS Code-style status bar, collapsible output, non-modal toasts)
Output: StatusBar, OutputPanel, and Toaster components integrated into App layout
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-non-blocking-foundation/01-CONTEXT.md
@.planning/phases/01-non-blocking-foundation/01-RESEARCH.md
@.planning/phases/01-non-blocking-foundation/01-02-SUMMARY.md
@.planning/phases/01-non-blocking-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatusBar component with progress and cancel</name>
  <files>
    src/components/StatusBar.tsx
  </files>
  <action>
    Create src/components/ directory if not exists.

    Create src/components/StatusBar.tsx:

    ```typescript
    import { useOperationStore } from '@/store/operation';
    import { useP4Command } from '@/hooks/useP4Command';
    import { Progress } from '@/components/ui/progress';
    import { Loader2, X } from 'lucide-react';

    /**
     * VS Code-style status bar showing current operation.
     * Per CONTEXT.md:
     * - Progress bar when p4 provides progress info, indeterminate spinner otherwise
     * - Cancel button appears only during active cancellable operations
     * - Unobtrusive but informative
     */
    export function StatusBar() {
      const { currentOperation } = useOperationStore();
      const { cancel, canCancel, isCancelling } = useP4Command();

      // Don't render if no operation
      if (!currentOperation) {
        return (
          <div className="fixed bottom-0 left-0 right-0 h-6 bg-slate-800 border-t border-slate-700 px-4 flex items-center">
            <span className="text-xs text-slate-400">Ready</span>
          </div>
        );
      }

      const { status, message, progress } = currentOperation;
      const isActive = status === 'running' || status === 'cancelling';
      const isError = status === 'error';
      const isSuccess = status === 'success';

      return (
        <div
          className={`fixed bottom-0 left-0 right-0 h-6 border-t px-4 flex items-center justify-between text-xs transition-colors ${
            isError
              ? 'bg-red-900 border-red-800 text-red-100'
              : isSuccess
              ? 'bg-green-900 border-green-800 text-green-100'
              : 'bg-blue-900 border-blue-800 text-blue-100'
          }`}
        >
          {/* Left: Operation status */}
          <div className="flex items-center gap-2 min-w-0 flex-1">
            {/* Spinner or progress */}
            {isActive && (
              progress === undefined ? (
                <Loader2 className="h-3 w-3 animate-spin flex-shrink-0" />
              ) : (
                <Progress value={progress} className="w-24 h-1.5 flex-shrink-0" />
              )
            )}

            {/* Message - truncate if too long */}
            <span className="truncate">{message}</span>
          </div>

          {/* Right: Actions */}
          <div className="flex items-center gap-2 flex-shrink-0 ml-4">
            {canCancel && (
              <button
                onClick={cancel}
                disabled={isCancelling}
                className="flex items-center gap-1 px-2 py-0.5 rounded hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed"
                title="Cancel operation"
              >
                <X className="h-3 w-3" />
                <span>Cancel</span>
              </button>
            )}
          </div>
        </div>
      );
    }
    ```

    Install lucide-react for icons:

    ```bash
    npm install lucide-react
    ```

    Key design per CONTEXT.md:
    - Shows "Ready" when idle
    - Blue background when running (VS Code-style)
    - Red background on error
    - Green background briefly on success (auto-clears via store)
    - Cancel button only when operation is cancellable
    - Progress bar when percentage known, spinner when indeterminate
  </action>
  <verify>
    grep "useOperationStore" src/components/StatusBar.tsx && grep "canCancel" src/components/StatusBar.tsx
  </verify>
  <done>StatusBar component with operation feedback and cancel button</done>
</task>

<task type="auto">
  <name>Task 2: Create collapsible OutputPanel component</name>
  <files>
    src/components/OutputPanel.tsx
  </files>
  <action>
    Create src/components/OutputPanel.tsx:

    ```typescript
    import { useRef, useEffect, useState } from 'react';
    import { useDeferredValue } from 'react';
    import { useOperationStore } from '@/store/operation';
    import {
      Collapsible,
      CollapsibleContent,
      CollapsibleTrigger,
    } from '@/components/ui/collapsible';
    import { ChevronDown, Terminal, Trash2 } from 'lucide-react';

    /**
     * Collapsible output panel showing raw p4 command output.
     * Per CONTEXT.md:
     * - Like VS Code's terminal panel — collapsible, shows raw output for debugging
     * - Power users can see exactly what p4 commands returned
     *
     * Uses useDeferredValue per RESEARCH.md Pattern 4 to maintain
     * UI responsiveness during high-frequency output.
     */
    export function OutputPanel() {
      const [isOpen, setIsOpen] = useState(false);
      const { outputLines, clearOutput } = useOperationStore();
      const bottomRef = useRef<HTMLDivElement>(null);

      // Defer rendering of lines to prevent blocking during fast output
      const deferredLines = useDeferredValue(outputLines);

      // Auto-scroll to bottom when new lines arrive
      useEffect(() => {
        if (isOpen && bottomRef.current) {
          bottomRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      }, [deferredLines.length, isOpen]);

      const lineCount = outputLines.length;
      const isPending = outputLines.length !== deferredLines.length;

      return (
        <Collapsible open={isOpen} onOpenChange={setIsOpen} className="border-t border-slate-700">
          <CollapsibleTrigger className="flex items-center justify-between w-full px-4 py-2 bg-slate-800 hover:bg-slate-700 transition-colors">
            <div className="flex items-center gap-2 text-sm text-slate-300">
              <Terminal className="h-4 w-4" />
              <span>Output</span>
              {lineCount > 0 && (
                <span className="text-xs text-slate-500">({lineCount} lines)</span>
              )}
              {isPending && (
                <span className="text-xs text-yellow-500">(updating...)</span>
              )}
            </div>
            <div className="flex items-center gap-2">
              {lineCount > 0 && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    clearOutput();
                  }}
                  className="p-1 rounded hover:bg-slate-600 text-slate-400 hover:text-slate-200"
                  title="Clear output"
                >
                  <Trash2 className="h-3 w-3" />
                </button>
              )}
              <ChevronDown
                className={`h-4 w-4 text-slate-400 transition-transform ${
                  isOpen ? 'rotate-180' : ''
                }`}
              />
            </div>
          </CollapsibleTrigger>

          <CollapsibleContent>
            <div
              className={`max-h-64 overflow-y-auto bg-slate-900 font-mono text-xs ${
                isPending ? 'opacity-80' : ''
              }`}
            >
              {deferredLines.length === 0 ? (
                <div className="px-4 py-8 text-center text-slate-500">
                  No output yet. Run a p4 command to see output here.
                </div>
              ) : (
                <div className="p-2">
                  {deferredLines.map((line, index) => (
                    <div
                      key={`${line.timestamp}-${index}`}
                      className={`py-0.5 px-2 ${
                        line.isStderr ? 'text-red-400' : 'text-slate-300'
                      }`}
                    >
                      {line.line}
                    </div>
                  ))}
                  <div ref={bottomRef} />
                </div>
              )}
            </div>
          </CollapsibleContent>
        </Collapsible>
      );
    }
    ```

    Key design per CONTEXT.md and RESEARCH.md:
    - Collapsible (hidden by default, user can expand)
    - Shows stderr in red, stdout in normal color
    - Clear button to remove output
    - useDeferredValue for responsiveness during fast output
    - Auto-scrolls to bottom when new lines arrive
    - Shows "(updating...)" when deferred render is behind
  </action>
  <verify>
    grep "useDeferredValue" src/components/OutputPanel.tsx && grep "Collapsible" src/components/OutputPanel.tsx && grep "outputLines" src/components/OutputPanel.tsx
  </verify>
  <done>Collapsible OutputPanel with deferred rendering for performance</done>
</task>

<task type="auto">
  <name>Task 3: Create Toaster and integrate all components into App</name>
  <files>
    src/components/Toaster.tsx
    src/App.tsx
  </files>
  <action>
    Create src/components/Toaster.tsx:

    ```typescript
    import { Toaster as HotToaster } from 'react-hot-toast';

    /**
     * Toast notification container.
     * Per CONTEXT.md:
     * - Non-blocking error notifications
     * - Auto-dismiss after 5-10 seconds
     * - Positioned bottom-right (above status bar)
     */
    export function Toaster() {
      return (
        <HotToaster
          position="bottom-right"
          toastOptions={{
            // Default duration: 5 seconds
            duration: 5000,

            // Styling to match app theme
            style: {
              background: '#1e293b', // slate-800
              color: '#f1f5f9', // slate-100
              border: '1px solid #334155', // slate-700
            },

            // Error toasts stay longer
            error: {
              duration: 8000,
              style: {
                background: '#7f1d1d', // red-900
                color: '#fef2f2', // red-50
                border: '1px solid #991b1b', // red-800
              },
            },

            // Success toasts are brief
            success: {
              duration: 3000,
              style: {
                background: '#14532d', // green-900
                color: '#f0fdf4', // green-50
                border: '1px solid #166534', // green-800
              },
            },
          }}
          // Position above status bar (24px = h-6)
          containerStyle={{
            bottom: 32,
          }}
        />
      );
    }
    ```

    Update src/App.tsx to include all components:

    ```typescript
    import { useState } from 'react';
    import { StatusBar } from '@/components/StatusBar';
    import { OutputPanel } from '@/components/OutputPanel';
    import { Toaster } from '@/components/Toaster';
    import { useP4Command, useP4Query } from '@/hooks/useP4Command';
    import toast from 'react-hot-toast';

    function App() {
      const { execute, isRunning } = useP4Command();
      const [result, setResult] = useState<string | null>(null);

      // Demo: Test p4 info command
      const handleTestInfo = async () => {
        try {
          const output = await execute('info');
          if (output) {
            setResult(output);
            toast.success('p4 info completed');
          }
        } catch (error) {
          toast.error(`Command failed: ${error}`);
        }
      };

      // Demo: Test streaming command (would need p4 connected)
      const handleTestSync = async () => {
        try {
          await execute('sync', ['-n'], { streaming: true });
          toast.success('Sync preview completed');
        } catch (error) {
          toast.error(`Sync failed: ${error}`);
        }
      };

      return (
        <div className="min-h-screen bg-slate-900 text-slate-100 flex flex-col">
          {/* Main content area */}
          <main className="flex-1 p-4 pb-32">
            <h1 className="text-2xl font-bold mb-4">P4Now</h1>
            <p className="text-slate-400 mb-6">
              Non-blocking Perforce GUI — Phase 1 Foundation Test
            </p>

            {/* Test buttons */}
            <div className="flex gap-4 mb-6">
              <button
                onClick={handleTestInfo}
                disabled={isRunning}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:cursor-not-allowed rounded transition-colors"
              >
                Test p4 info
              </button>
              <button
                onClick={handleTestSync}
                disabled={isRunning}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:cursor-not-allowed rounded transition-colors"
              >
                Test p4 sync -n
              </button>
            </div>

            {/* Result display */}
            {result && (
              <div className="bg-slate-800 rounded p-4 font-mono text-sm whitespace-pre-wrap">
                {result}
              </div>
            )}
          </main>

          {/* Output panel (above status bar) */}
          <div className="fixed bottom-6 left-0 right-0">
            <OutputPanel />
          </div>

          {/* Status bar (fixed at bottom) */}
          <StatusBar />

          {/* Toast notifications */}
          <Toaster />
        </div>
      );
    }

    export default App;
    ```

    Key layout:
    - Main content with test buttons
    - OutputPanel positioned above StatusBar
    - StatusBar fixed at bottom (h-6 = 24px)
    - Toaster positioned above StatusBar (bottom: 32px)
    - Test buttons disabled when operation running

    NOTE: Test buttons require p4.exe installed and configured.
    If p4 not available, buttons will show error toast (non-blocking).
  </action>
  <verify>
    grep "Toaster" src/App.tsx && grep "StatusBar" src/App.tsx && grep "OutputPanel" src/App.tsx
  </verify>
  <done>App layout with StatusBar, OutputPanel, Toaster, and test buttons</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build check:
   ```bash
   npm run build
   ```
   Should complete without errors.

2. Visual verification:
   - Launch with `npm run tauri dev`
   - Verify status bar visible at bottom showing "Ready"
   - Click "Output" to expand/collapse panel
   - Click test buttons to trigger operations
   - Verify cancel button appears during running operations
   - Verify toast appears on error/success (non-blocking)

3. Responsiveness check:
   - During operation, UI should remain interactive
   - Can expand/collapse output panel during running operation
   - Can click Cancel button while operation runs
</verification>

<success_criteria>
- StatusBar shows operation status with progress indicator
- Cancel button only appears when operation is cancellable
- OutputPanel is collapsible and shows raw command output
- stderr lines display in red, stdout in normal color
- Toast notifications are non-blocking and auto-dismiss
- Test buttons demonstrate async operation execution
- UI remains responsive during operations
</success_criteria>

<output>
After completion, create `.planning/phases/01-non-blocking-foundation/01-04-SUMMARY.md`
</output>
