---
phase: 20-bug-fixes-and-ui-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/DepotBrowser/useDepotTree.ts
autonomous: true

must_haves:
  truths:
    - "Depot browser preserves tree data after accordion collapse and re-expand"
    - "Depot directory loading shows progress in status bar"
    - "Single click on depot folder loads children without requiring double-click"
  artifacts:
    - path: "src/components/DepotBrowser/useDepotTree.ts"
      provides: "Data persistence via useEffect on query data, operation store integration for loading"
  key_links:
    - from: "src/components/DepotBrowser/useDepotTree.ts"
      to: "src/store/operation.ts"
      via: "useOperationStore.getState().startOperation/completeOperation"
      pattern: "startOperation|completeOperation"
    - from: "src/components/DepotBrowser/useDepotTree.ts"
      to: "TanStack Query cache"
      via: "useEffect syncs query data to component state"
      pattern: "useEffect.*data"
---

<objective>
Fix depot browser data persistence across accordion toggles and add operation tracking for depot directory loading.

Purpose: The depot tree disappears when the accordion is collapsed and re-expanded because `setTreeData` is called inside `queryFn` which doesn't re-run with cached data. Additionally, depot loading doesn't show progress in the status bar.
Output: Depot tree persists across accordion toggles and shows loading progress in status bar.
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/DepotBrowser/useDepotTree.ts
@src/store/operation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix depot data persistence across accordion toggles</name>
  <files>src/components/DepotBrowser/useDepotTree.ts</files>
  <action>
The root cause: `setTreeData(roots)` is called inside `queryFn` (line 44). When the component remounts (accordion re-expand), TanStack Query serves cached data and does NOT re-run `queryFn`, so `setTreeData` never executes and `treeData` stays empty.

**Fix**: Move `setTreeData` out of `queryFn` and into a `useEffect` that watches the query `data`. Also extract `data` from the query return value.

1. Change the query to return data WITHOUT side effects in `queryFn`:

```tsx
const { data: depotRoots, isLoading, error } = useQuery({
  queryKey: ['depot', 'roots', p4port, p4user],
  queryFn: async () => {
    const depots = await invokeP4Depots();
    const roots: DepotNodeData[] = depots.map(depot => ({
      id: `//${depot.name}`,
      name: depot.name,
      isFolder: true,
      isDepotRoot: true,
      children: [],
    }));
    return roots;
  },
  enabled: isConnected,
  staleTime: 5 * 60 * 1000,
  refetchOnWindowFocus: false,
});
```

2. Add a `useEffect` to sync query data to component state:

```tsx
// Sync depot roots from query cache to local state
// This runs both on initial fetch AND when component remounts with cached data
useEffect(() => {
  if (depotRoots) {
    loadedPaths.current.clear();
    setTreeData(depotRoots);
  }
}, [depotRoots]);
```

This ensures `setTreeData` is called whenever `depotRoots` data is available, whether from a fresh fetch or from the TanStack Query cache.
  </action>
  <verify>
Run `npx tsc --noEmit`. Test by:
1. Expand depot browser and load some directories
2. Collapse the depot accordion
3. Re-expand the depot accordion
4. Verify tree data is still visible (roots should appear immediately from cache)
  </verify>
  <done>Depot tree data persists across accordion collapse/expand cycles. Roots load from cache on remount without re-fetching.</done>
</task>

<task type="auto">
  <name>Task 2: Add operation tracking for depot directory loading</name>
  <files>src/components/DepotBrowser/useDepotTree.ts</files>
  <action>
Add operation store integration to the `loadChildren` function so depot directory loading shows progress in the status bar.

1. Import `useOperationStore` at the top:
```tsx
import { useOperationStore } from '@/store/operation';
```

2. Inside `loadChildren` callback, add operation tracking. Update the function to show loading status in the status bar:

```tsx
const loadChildren = useCallback(async (depotPath: string) => {
  if (loadedPaths.current.has(depotPath)) return;
  loadedPaths.current.add(depotPath);

  setLoadingPaths(prev => new Set(prev).add(depotPath));

  // Show loading in status bar
  const { startOperation, completeOperation } = useOperationStore.getState();
  const opId = `depot-load-${depotPath}`;
  startOperation(opId, `dirs "${depotPath}/*"`);

  try {
    const showDeleted = await getShowDeletedDepotFiles();
    // ... existing fetch logic stays the same ...

    completeOperation(true);
  } catch (err) {
    console.error(`Failed to load children for ${depotPath}:`, err);
    completeOperation(false, String(err));
  } finally {
    setLoadingPaths(prev => {
      const next = new Set(prev);
      next.delete(depotPath);
      return next;
    });
  }
}, []);
```

Place the `startOperation` call AFTER `setLoadingPaths` and BEFORE the try block's async calls. Place `completeOperation(true)` after the successful `setTreeData` call inside the try block, and `completeOperation(false, ...)` in the catch block.

IMPORTANT: The `startOperation`/`completeOperation` calls go around the existing async logic. Do NOT restructure the existing try/catch/finally - just add the operation store calls at the appropriate points.
  </action>
  <verify>
Run `npx tsc --noEmit`. Test by:
1. Click on a depot folder to expand it
2. Verify the status bar shows a loading message like "Running: p4 dirs //depot/..."
3. After loading completes, status bar returns to "Ready"
  </verify>
  <done>Depot directory loading shows progress in the status bar via the operation store. Status bar shows which path is being loaded.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Depot tree survives accordion collapse/expand without data loss
3. Status bar shows loading progress when expanding depot folders
4. Single click on a folder triggers loading (no double-click needed)
</verification>

<success_criteria>
- Depot browser data persists across accordion collapse and re-expand
- Depot directory loading shows in status bar
- Loading indicator appears on first click (not requiring double-click)
</success_criteria>

<output>
After completion, create `.planning/phases/20-bug-fixes-and-ui-polish/20-03-SUMMARY.md`
</output>
