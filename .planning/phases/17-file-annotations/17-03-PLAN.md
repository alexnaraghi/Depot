---
phase: 17-file-annotations
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - src/components/DetailPane/AnnotationTooltip.tsx
  - src/hooks/useAnnotationNavigation.ts
  - src/hooks/useChangelistDescription.ts
  - src/components/DetailPane/FileAnnotationViewer.tsx
  - src/components/DetailPane/AnnotationGutter.tsx
  - src/components/DetailPane/RevisionDetailView.tsx
autonomous: true

must_haves:
  truths:
    - "User can hover annotation to see full commit message tooltip"
    - "User can click annotation to navigate to that revision's changelist detail"
    - "User can navigate annotations with keyboard (Alt+Up/Down between change blocks)"
    - "User can 'blame prior revision' to peel back history layers"
  artifacts:
    - path: "src/components/DetailPane/AnnotationTooltip.tsx"
      provides: "Tooltip wrapper showing changelist description on hover"
      min_lines: 40
    - path: "src/hooks/useAnnotationNavigation.ts"
      provides: "Keyboard navigation between annotation blocks"
      exports: ["useAnnotationNavigation"]
    - path: "src/hooks/useChangelistDescription.ts"
      provides: "TanStack Query hook for fetching changelist descriptions"
      exports: ["useChangelistDescription"]
  key_links:
    - from: "src/components/DetailPane/AnnotationGutter.tsx"
      to: "src/components/DetailPane/AnnotationTooltip.tsx"
      via: "wraps each annotation line"
      pattern: "AnnotationTooltip"
    - from: "src/components/DetailPane/FileAnnotationViewer.tsx"
      to: "src/hooks/useAnnotationNavigation.ts"
      via: "keyboard navigation hook"
      pattern: "useAnnotationNavigation"
    - from: "src/components/DetailPane/RevisionDetailView.tsx"
      to: "useDetailPaneStore"
      via: "drillToChangelist for CL click navigation"
      pattern: "selectChangelist"
---

<objective>
Add interactive features: tooltips, keyboard navigation, click-to-CL navigation, and blame prior revision

Purpose: Enable rich interaction with blame data - hover for details, keyboard for efficiency, click for navigation, history peeling for investigation

Output: Complete file annotations experience with all 6 BLAME requirements satisfied
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 02 provides base viewer components
@.planning/phases/17-file-annotations/17-02-SUMMARY.md

# Research provides interaction patterns
@.planning/phases/17-file-annotations/17-RESEARCH.md

# Detail pane store for navigation
@src/stores/detailPaneStore.ts

# Existing changelist types and queries
@src/lib/tauri.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tooltip and description fetching</name>
  <files>src/hooks/useChangelistDescription.ts, src/components/DetailPane/AnnotationTooltip.tsx</files>
  <action>
Create src/hooks/useChangelistDescription.ts:

1. Import useQuery from @tanstack/react-query
2. Import invokeP4Command from lib/tauri

3. Export parseChangelistDescription function:
   - Input: p4 describe -s output (string)
   - Parse description block between "Description:" and "Affected files:"
   - Remove leading tab from each line
   - Return trimmed description or "No description available"

4. Export useChangelistDescription hook:
   - Parameters: changelistId: number, options?: { enabled?: boolean }
   - Query key: ['changelist-description', changelistId]
   - Query function:
     - Call invokeP4Command(['describe', '-s', String(changelistId)])
     - Parse with parseChangelistDescription
   - staleTime: 60 * 60 * 1000 (1 hour - descriptions are immutable)
   - enabled: options?.enabled ?? false (fetch on demand, not eager)
   - Return { data, isLoading, error, refetch }

Create src/components/DetailPane/AnnotationTooltip.tsx:

1. Import Tooltip, TooltipContent, TooltipTrigger from components/ui/tooltip
2. Import useChangelistDescription hook
3. Import useState for hover state tracking

Props interface AnnotationTooltipProps:
  - changelistId: number
  - user: string
  - date: string
  - children: React.ReactNode

Component implementation:
  - Track isOpen state for tooltip visibility
  - Use useChangelistDescription with enabled: isOpen
  - Tooltip with delayDuration={500} to prevent accidental triggers
  - TooltipContent shows:
    - Header: "Changelist {changelistId}" (font-semibold)
    - Author: "{user} on {date}" (text-xs text-muted-foreground)
    - Separator: <hr className="my-2" />
    - Description: whitespace-pre-wrap, max-w-md
    - Loading state: "Loading..." with Loader2 spinner
  - Side: "right" to not obscure gutter
  - onOpenChange handler sets isOpen (triggers fetch when opened)
  </action>
  <verify>
  - npm run build passes
  - useChangelistDescription exports correctly
  - AnnotationTooltip renders without errors
  </verify>
  <done>
  - Description fetched on tooltip open (lazy loading)
  - Tooltip shows CL number, author, date, and full description
  - 500ms delay prevents accidental hover triggers
  </done>
</task>

<task type="auto">
  <name>Task 2: Create keyboard navigation and integrate tooltip</name>
  <files>src/hooks/useAnnotationNavigation.ts, src/components/DetailPane/AnnotationGutter.tsx, src/components/DetailPane/FileAnnotationViewer.tsx</files>
  <action>
Create src/hooks/useAnnotationNavigation.ts:

1. Import useState, useEffect, useCallback from react
2. Import AnnotationBlock from lib/annotationParser

3. Export useAnnotationNavigation hook:
   - Parameters: blocks: AnnotationBlock[], scrollToLine: (lineNumber: number) => void
   - State: currentBlockIndex (default 0)

   - useEffect for keyboard handler:
     - Listen on window for keydown
     - Only handle if not in input/textarea (check e.target)
     - Alt+ArrowDown: increment index, scroll to block startLine
     - Alt+ArrowUp: decrement index, scroll to block startLine
     - Clamp index to valid range
     - e.preventDefault() to prevent page scroll

   - Return:
     - currentBlockIndex: number
     - currentBlock: AnnotationBlock | null
     - totalBlocks: number
     - goToNextBlock: () => void (programmatic navigation)
     - goToPreviousBlock: () => void

Update src/components/DetailPane/AnnotationGutter.tsx:

1. Wrap each annotation line with AnnotationTooltip:
   - Pass changelistId, user, date
   - Children: the existing gutter content

2. Add optional highlightedLines prop: Set<number>
   - If line number is in highlightedLines, add ring-2 ring-primary/50 styling
   - Used to highlight current navigation block

Update src/components/DetailPane/FileAnnotationViewer.tsx:

1. Import useAnnotationBlocks from hooks/useFileAnnotations
2. Import useAnnotationNavigation
3. Create scrollToLine callback:
   - Uses containerRef to scroll to specific line
   - Calculate position: lineNumber * 20 (20px per line)
   - containerRef.current.scrollTop = position - 100 (offset for visibility)

4. Initialize useAnnotationNavigation with blocks and scrollToLine

5. Calculate highlightedLines from currentBlock:
   - Create Set<number> from currentBlock.startLine to currentBlock.endLine
   - Pass to AnnotationGutter

6. Add navigation indicator in header:
   - Show "Block {currentBlockIndex + 1} of {totalBlocks}" when blocks > 1
   - Small text-xs text-muted-foreground indicator
   - Hint: "Alt+\u2191/\u2193 to navigate"
  </action>
  <verify>
  - npm run build passes
  - Hover over annotation shows tooltip with description
  - Alt+Down/Up keys navigate between blocks (test in browser)
  </verify>
  <done>
  - Tooltips show commit message on hover
  - Keyboard navigation (Alt+Arrow) jumps between change blocks
  - Current block visually highlighted
  - Navigation indicator shows position
  </done>
</task>

<task type="auto">
  <name>Task 3: Add click-to-CL navigation and blame prior revision</name>
  <files>src/components/DetailPane/FileAnnotationViewer.tsx, src/components/DetailPane/RevisionDetailView.tsx</files>
  <action>
Update src/components/DetailPane/FileAnnotationViewer.tsx:

1. Add state for blame revision navigation:
   - blameRevision: number (initialized from props.revision)
   - revisionHistory: number[] (stack for back navigation, initialized with [props.revision])

2. Update useFileAnnotations to use blameRevision instead of props.revision

3. Add "Blame Prior Revision" functionality:
   - handleBlamePriorRevision: decrements blameRevision, pushes to history
   - handleBlameHistoryBack: pops from history, sets blameRevision
   - Disable "Prior" button if blameRevision <= 1
   - Disable "Back" button if history.length <= 1

4. Add header controls (above gutter/code layout):
   - Flex row with gap-2
   - Button: "Back" (ArrowLeft icon) - onClick handleBlameHistoryBack
   - Button: "Blame Prior Revision" (History icon) - onClick handleBlamePriorRevision
   - Span: "Viewing blame at #{blameRevision}" (text-sm text-muted-foreground ml-auto)
   - Use variant="outline" size="sm" for buttons

5. Reset state when props.depotPath or props.revision changes:
   - useEffect to reset blameRevision and revisionHistory

Update src/components/DetailPane/RevisionDetailView.tsx:

1. Import useDetailPaneStore
2. Import invokeP4Changes from lib/tauri
3. Import useQuery for changelist lookup

4. Create handleChangelistClick callback:
   - Parameter: changelistId: number
   - Look up changelist via TanStack Query:
     - Use useQuery with ['changelist-lookup', changelistId]
     - Query function: invokeP4Changes('submitted') then find matching CL
     - Or simpler: just call invokeP4Changes('submitted') in callback
   - When found: call selectChangelist from detailPaneStore
   - If not found: show toast or console warning

5. Pass onChangelistClick to FileAnnotationViewer:
   - FileAnnotationViewer passes this to AnnotationGutter
   - AnnotationGutter calls it on annotation click

6. Ensure click works:
   - Gutter onClick still calls onAnnotationClick
   - Tooltip wraps content but doesn't interfere with click
  </action>
  <verify>
  - npm run build passes
  - Click annotation gutter navigates to changelist detail
  - "Blame Prior Revision" button decrements revision and refreshes
  - "Back" button returns to previous blame revision
  </verify>
  <done>
  - Click annotation navigates to changelist detail view
  - "Blame Prior Revision" peels back history layer
  - Back button enables multi-level blame navigation
  - All 6 BLAME requirements satisfied
  </done>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. All 6 BLAME requirements verified:
   - BLAME-01: Per-line author, revision, date visible in gutter
   - BLAME-02: Click annotation navigates to changelist detail
   - BLAME-03: Alt+Up/Down navigates between change blocks
   - BLAME-04: Heatmap coloring (blue=old, red=recent) on gutter
   - BLAME-05: Hover shows tooltip with full commit message
   - BLAME-06: "Blame Prior Revision" button peels back history
</verification>

<success_criteria>
- User can hover any annotation to see full commit message
- User can click annotation to navigate to changelist detail
- User can press Alt+Down/Up to navigate between change blocks
- Current block is visually highlighted during navigation
- User can blame prior revision and navigate back through blame history
- All interactions work smoothly without performance issues
</success_criteria>

<output>
After completion, create `.planning/phases/17-file-annotations/17-03-SUMMARY.md`
</output>
