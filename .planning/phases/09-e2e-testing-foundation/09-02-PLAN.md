---
phase: 09-e2e-testing-foundation
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - e2e/test/specs/sync.test.ts
  - e2e/test/specs/file-operations.test.ts
  - e2e/test/specs/changelist.test.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests validate sync operation (initiate, verify completion UI)"
    - "E2E tests validate checkout operation (select file, checkout, verify status change)"
    - "E2E tests validate submit operation (create CL description, submit, verify success)"
    - "E2E tests validate revert operation (revert file, verify status restored)"
  artifacts:
    - path: "e2e/test/specs/sync.test.ts"
      provides: "Sync workflow E2E tests"
    - path: "e2e/test/specs/file-operations.test.ts"
      provides: "Checkout and revert E2E tests"
    - path: "e2e/test/specs/changelist.test.ts"
      provides: "Submit workflow E2E tests"
  key_links:
    - from: "e2e/test/specs/*.test.ts"
      to: "src/components/*"
      via: "data-testid selectors from Plan 01"
    - from: "e2e/test/specs/*.test.ts"
      to: "e2e/wdio.conf.ts"
      via: "WebdriverIO test runner configuration"
---

<objective>
Write E2E test specs that validate all four core Perforce workflows: sync, checkout, submit, and revert.

Purpose: These tests form the regression safety net for all future development. Each test validates end-to-end UI behavior for a core workflow.
Output: Three test spec files covering all four workflows required by TEST-01.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-testing-foundation/09-RESEARCH.md
@.planning/phases/09-e2e-testing-foundation/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write sync and file operation test specs</name>
  <files>
    e2e/test/specs/sync.test.ts
    e2e/test/specs/file-operations.test.ts
  </files>
  <action>
Read the 09-01-SUMMARY.md to learn what data-testid attributes were added and their exact names. Use those selectors in tests.

**e2e/test/specs/sync.test.ts** — Sync Workflow:

```typescript
import { expect } from '@wdio/globals';

describe('Sync Workflow', () => {
  before(async () => {
    // Wait for app to be ready
    await $('[data-testid="app-ready"]').waitForDisplayed({ timeout: 15000 });
  });

  it('should display sync button in toolbar', async () => {
    const syncBtn = await $('[data-testid="sync-button"]');
    await expect(syncBtn).toBeDisplayed();
    await expect(syncBtn).toBeEnabled();
  });

  it('should initiate sync and show completion', async () => {
    const syncBtn = await $('[data-testid="sync-button"]');
    await syncBtn.click();

    // Sync button should become disabled during operation
    // Then re-enable when complete
    await syncBtn.waitForEnabled({ timeout: 30000 });

    // After sync, connection status should still show connected
    const status = await $('[data-testid="connection-status"]');
    await expect(status).toBeDisplayed();
  });
});
```

Key patterns:
- Use `waitForDisplayed` with generous timeout (15s) for app startup
- Use `waitForEnabled` with 30s timeout for sync completion
- Assert outcome (button re-enabled, status shown) not intermediate states
- Use `before` hook for suite-level setup

**e2e/test/specs/file-operations.test.ts** — Checkout and Revert:

```typescript
import { expect } from '@wdio/globals';

describe('File Operations', () => {
  before(async () => {
    await $('[data-testid="app-ready"]').waitForDisplayed({ timeout: 15000 });
    // Ensure file tree is visible
    await $('[data-testid="file-tree"]').waitForDisplayed();
  });

  describe('Checkout', () => {
    it('should checkout a file via context menu', async () => {
      // Find a file node in the tree (use first available)
      // Right-click to open context menu
      // Click checkout option
      // Verify file appears in changelist panel
    });
  });

  describe('Revert', () => {
    it('should revert a checked out file', async () => {
      // Find the checked-out file in changelist panel
      // Right-click to open context menu
      // Click revert option
      // Verify file is removed from changelist panel
    });
  });
});
```

IMPORTANT implementation notes:
- Read the actual component files (from 09-01-SUMMARY.md) to find the EXACT data-testid values used
- For right-click context menus: use `element.click({ button: 2 })` for right-click, or `element.click({ button: 'right' })` — check WebdriverIO docs for correct API
- For finding a file to checkout: use `$$('[data-testid^="file-node-"]')` to find all file nodes, pick the first one
- For checking changelist panel: after checkout, verify a file appears under `[data-testid="changelist-panel"]`
- For revert: find the file in the changelist panel, right-click, select revert
- Use `waitForDisplayed` after menu clicks to wait for context menu to appear
- Use expect-webdriverio matchers (auto-retry) instead of manual waits
- Tests in same describe block may depend on order (checkout before revert) — this is acceptable per context decision (suite-level isolation)
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --project e2e/tsconfig.json --noEmit`
    - Files exist: `ls e2e/test/specs/sync.test.ts e2e/test/specs/file-operations.test.ts`
  </verify>
  <done>
    Sync test validates initiation and completion. File operations tests validate checkout via context menu and revert via context menu. All tests use data-testid selectors from Plan 01.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write changelist submit test spec</name>
  <files>
    e2e/test/specs/changelist.test.ts
  </files>
  <action>
Read the 09-01-SUMMARY.md to learn what data-testid attributes were added for the submit dialog.

**e2e/test/specs/changelist.test.ts** — Submit Workflow:

```typescript
import { expect } from '@wdio/globals';

describe('Changelist Submit', () => {
  before(async () => {
    await $('[data-testid="app-ready"]').waitForDisplayed({ timeout: 15000 });
  });

  it('should checkout a file to create pending changelist', async () => {
    // First, checkout a file so there's something to submit
    // (Similar to file-operations checkout test)
    // Verify file appears in changelist panel
  });

  it('should open submit dialog and fill description', async () => {
    // Find the changelist with the checked-out file
    // Right-click or find submit button
    // Click submit
    // Wait for submit dialog to appear
    const dialog = await $('[data-testid="submit-dialog"]');
    await dialog.waitForDisplayed();

    // Fill in description
    const desc = await $('[data-testid="submit-description"]');
    await desc.setValue('E2E test submit - automated test changelist');

    // Verify submit button is enabled
    const submitBtn = await $('[data-testid="submit-confirm-button"]');
    await expect(submitBtn).toBeEnabled();
  });

  it('should submit changelist and verify success', async () => {
    // Click submit button
    const submitBtn = await $('[data-testid="submit-confirm-button"]');
    await submitBtn.click();

    // Wait for dialog to close (indicates success)
    const dialog = await $('[data-testid="submit-dialog"]');
    await dialog.waitForDisplayed({ reverse: true, timeout: 30000 });

    // Verify the file is no longer in pending changelists
    // The changelist panel should reflect the submitted state
  });
});
```

IMPORTANT implementation notes:
- Read 09-01-SUMMARY.md for exact selector names
- The submit flow requires a file to already be checked out. The first test in this suite checks out a file.
- Use `element.setValue()` for textarea input (not `element.addValue()` which appends)
- Use `waitForDisplayed({ reverse: true })` to wait for dialog dismissal
- After submit, verify the changelist panel no longer shows the submitted file
- If submit requires selecting a changelist first, adapt the flow to match the actual UI (read SubmitDialog.tsx from summary)
- Timeout of 30s for submit operation (P4 network operation)
- These tests assume a connected P4 server with a writable workspace. Document this in a comment at top of file.
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --project e2e/tsconfig.json --noEmit`
    - File exists: `ls e2e/test/specs/changelist.test.ts`
    - All three spec files match the wdio.conf.ts glob pattern `./test/specs/**/*.ts`
  </verify>
  <done>
    Submit test validates opening dialog, filling description, submitting, and verifying dialog closes. Combined with sync and file-operations specs, all four workflows (sync, checkout, submit, revert) from TEST-01 are covered.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --project e2e/tsconfig.json --noEmit` — all test files compile
2. Three spec files exist covering all 4 workflows:
   - sync.test.ts → sync workflow
   - file-operations.test.ts → checkout + revert workflows
   - changelist.test.ts → submit workflow
3. All tests use data-testid selectors (no CSS class or structure-dependent selectors)
4. All assertions are outcome-focused (verify end state, not intermediate UI)
</verification>

<success_criteria>
- 3 test spec files in e2e/test/specs/
- Tests cover: sync initiation/completion, file checkout, file revert, changelist submit
- All tests use data-testid selectors from Plan 01
- TypeScript compiles without errors
- Tests follow suite-level isolation pattern with before/after hooks
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-testing-foundation/09-02-SUMMARY.md`
</output>
