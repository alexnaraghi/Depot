---
phase: 22-streaming-fstat-progress
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/components/StatusBar.tsx
  - src/hooks/useP4Command.ts
autonomous: true

must_haves:
  truths:
    - "Progress indicator shows file count and estimated total during streaming"
    - "Cancel button is visible and functional during streaming operations"
    - "Progress bar updates in real-time as batches arrive"
    - "Cancelled operations preserve partial results in the tree"
  artifacts:
    - path: "src/components/StatusBar.tsx"
      provides: "Enhanced progress display with file count"
      contains: "files"
    - path: "src/hooks/useP4Command.ts"
      provides: "Cancel function that kills backend process"
      contains: "invokeKillProcess"
  key_links:
    - from: "StatusBar.tsx"
      to: "operation.ts:useOperationStore"
      via: "currentOperation.progress and currentOperation.message"
      pattern: "currentOperation"
    - from: "useP4Command.ts"
      to: "tauri.ts:invokeKillProcess"
      via: "cancel callback"
      pattern: "invokeKillProcess"
---

<objective>
Enhance progress indicator UX for streaming operations with file count and cancellation.

Purpose: Users need feedback during long operations (>2 seconds). Show meaningful progress (file count, estimate), ensure cancel button works and preserves partial results.

Output: StatusBar shows streaming progress with file count, cancel button stops backend process.
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-streaming-fstat-progress/22-RESEARCH.md
@.planning/phases/22-streaming-fstat-progress/22-01-SUMMARY.md
@src/components/StatusBar.tsx (current implementation)
@src/hooks/useP4Command.ts (cancel function)
@src/store/operation.ts (operation store interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance StatusBar to display file count during streaming</name>
  <files>src/components/StatusBar.tsx</files>
  <action>
Update StatusBar to better display streaming progress with file count extraction from message.

The operation store's `message` field already contains file count info from useFileTree (e.g., "Loading files... (1500)"). The StatusBar should display this clearly alongside the progress bar.

Update StatusBar.tsx:

```typescript
import { useOperationStore } from '@/store/operation';
import { useP4Command } from '@/hooks/useP4Command';
import { Progress } from '@/components/ui/progress';
import { Loader2, X } from 'lucide-react';

/**
 * VS Code-style status bar showing current operation.
 * Per CONTEXT.md:
 * - Progress bar when p4 provides progress info, indeterminate spinner otherwise
 * - Cancel button appears only during active cancellable operations
 * - Unobtrusive but informative
 * - Shows file count during streaming operations
 */
export function StatusBar() {
  const { currentOperation } = useOperationStore();
  const { cancel, canCancel, isCancelling } = useP4Command();

  // Don't render if no operation
  if (!currentOperation) {
    return (
      <div className="fixed bottom-0 left-0 right-0 h-6 bg-accent border-t border-border px-4 flex items-center" data-testid="status-bar">
        <span className="text-xs text-muted-foreground">Ready</span>
      </div>
    );
  }

  const { status, message, progress } = currentOperation;
  const isActive = status === 'running' || status === 'cancelling';
  const isError = status === 'error';
  const isSuccess = status === 'success';

  // Extract file count from message if present (e.g., "Loading files... (1500)")
  const fileCountMatch = message.match(/\((\d+)\)/);
  const fileCount = fileCountMatch ? parseInt(fileCountMatch[1], 10) : null;

  // Format display message: show progress percentage and file count
  const displayMessage = fileCount !== null && progress !== undefined
    ? `${message.replace(/\s*\(\d+\)/, '')} ${fileCount.toLocaleString()} files (${progress}%)`
    : message;

  return (
    <div
      className={`fixed bottom-0 left-0 right-0 h-6 border-t px-4 flex items-center justify-between text-xs ${
        isError
          ? 'bg-destructive/20 border-destructive/30 text-destructive'
          : isSuccess
          ? 'bg-emerald-900/50 border-emerald-800/30 text-emerald-200'
          : 'bg-primary/20 border-primary/30 text-primary'
      }`}
      data-testid="status-bar"
    >
      {/* Left: Operation status */}
      <div className="flex items-center gap-2 min-w-0 flex-1">
        {/* Spinner or progress */}
        {isActive && (
          progress === undefined ? (
            <Loader2 className="h-3 w-3 animate-spin flex-shrink-0" />
          ) : (
            <Progress value={progress} className="w-24 h-1.5 flex-shrink-0" />
          )
        )}

        {/* Message - truncate if too long */}
        <span className="truncate">{displayMessage}</span>
      </div>

      {/* Right: Actions */}
      <div className="flex items-center gap-2 flex-shrink-0 ml-4">
        {canCancel && (
          <button
            onClick={cancel}
            disabled={isCancelling}
            className="flex items-center gap-1 px-2 py-0.5 rounded hover:bg-black/20 disabled:opacity-50 disabled:cursor-not-allowed"
            title="Cancel operation"
          >
            <X className="h-3 w-3" />
            <span>Cancel</span>
          </button>
        )}
      </div>
    </div>
  );
}
```
  </action>
  <verify>Run `npm run typecheck` to verify TypeScript compiles</verify>
  <done>StatusBar displays file count and progress percentage during streaming</done>
</task>

<task type="auto">
  <name>Task 2: Verify useP4Command cancel preserves partial results</name>
  <files>src/hooks/useP4Command.ts</files>
  <action>
Review and verify that useP4Command's cancel function correctly:
1. Kills the backend process via invokeKillProcess
2. Does NOT clear the query cache (partial results preserved)
3. Updates operation store to show cancelled state

Read the current useP4Command.ts implementation. If cancel does NOT preserve partial results (i.e., it invalidates/clears queries), update it to only call invokeKillProcess and update operation status without clearing data.

The cancel function should look like:

```typescript
const cancel = useCallback(async () => {
  const operation = useOperationStore.getState().currentOperation;
  if (!operation?.processId) return;

  const { setCancelling, completeOperation } = useOperationStore.getState();
  setCancelling();

  try {
    await invokeKillProcess(operation.processId);
    // Mark as cancelled WITHOUT invalidating queries
    // This preserves partial results in the tree
    completeOperation(false, 'Cancelled by user');
  } catch (error) {
    completeOperation(false, `Cancel failed: ${error}`);
  }
}, []);
```

CRITICAL: Do NOT add queryClient.invalidateQueries() to the cancel function. Partial results must remain visible after cancellation. The streaming accumulation in useFileTree already populated the query cache with received files.
  </action>
  <verify>
Manual test:
1. Connect to a large workspace
2. Start file tree load (observe streaming progress)
3. Click Cancel before completion
4. Verify: partial files remain visible in tree
5. Verify: status shows "Cancelled by user"
  </verify>
  <done>Cancel function kills process and preserves partial results in query cache</done>
</task>

</tasks>

<verification>
Run the following checks:
1. `npm run typecheck` - Verify TypeScript compiles
2. `npm run build` - Verify full build succeeds
3. Manual test flow:
   - Open app with connected workspace
   - Observe progress bar filling during file load
   - Observe file count updating in status bar
   - Click Cancel before completion
   - Verify partial files remain in tree
   - Verify "Cancelled by user" message
</verification>

<success_criteria>
- StatusBar extracts and displays file count from operation message
- Progress percentage shown alongside file count
- Cancel button visible during streaming operations
- Clicking cancel kills backend process (verified via Task Manager - no orphan p4.exe)
- Partial results preserved in tree after cancellation
- Status shows "Cancelled by user" after cancellation
</success_criteria>

<output>
After completion, create `.planning/phases/22-streaming-fstat-progress/22-03-SUMMARY.md`
</output>
