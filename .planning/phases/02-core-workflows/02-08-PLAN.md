---
phase: 02-core-workflows
plan: 08
type: execute
wave: 5
depends_on: ["02-05", "02-06", "02-07"]
files_modified:
  - src/App.tsx
  - src/components/MainLayout.tsx
autonomous: true

must_haves:
  truths:
    - "App displays file tree in main area"
    - "App displays changelist panel in sidebar"
    - "App has sync toolbar with global sync button"
    - "Event subscription is initialized on app mount"
  artifacts:
    - path: "src/components/MainLayout.tsx"
      provides: "Main application layout"
      exports: ["MainLayout"]
    - path: "src/App.tsx"
      provides: "Updated app entry"
      contains: "MainLayout"
  key_links:
    - from: "src/App.tsx"
      to: "src/hooks/useP4Events.ts"
      via: "event subscription"
      pattern: "useP4Events"
    - from: "src/components/MainLayout.tsx"
      to: "src/components/FileTree/FileTree.tsx"
      via: "component composition"
      pattern: "FileTree"
    - from: "src/components/MainLayout.tsx"
      to: "src/components/ChangelistPanel/ChangelistPanel.tsx"
      via: "component composition"
      pattern: "ChangelistPanel"
---

<objective>
Integrate all Phase 2 components into a cohesive application layout with file tree, changelist sidebar, sync toolbar, and event subscription.

Purpose: Bring together all the individual components into a working application that users can actually use. The layout should follow the CONTEXT.md decisions: tree view main area, changelist sidebar, toolbar.

Output: MainLayout component and updated App.tsx with full Phase 2 UI integration.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-workflows/02-CONTEXT.md
@src/App.tsx
@src/components/StatusBar.tsx
@src/components/OutputPanel.tsx
@src/components/Toaster.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MainLayout component</name>
  <files>src/components/MainLayout.tsx</files>
  <action>
Create the main application layout with all components:

```typescript
import { useState } from 'react';
import { FileTree } from '@/components/FileTree/FileTree';
import { ChangelistPanel } from '@/components/ChangelistPanel/ChangelistPanel';
import { SyncToolbar } from '@/components/SyncToolbar';
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { cn } from '@/lib/utils';

interface MainLayoutProps {
  className?: string;
}

export function MainLayout({ className }: MainLayoutProps) {
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [sidebarWidth, setSidebarWidth] = useState(300);

  return (
    <div className={cn('flex flex-col h-full', className)}>
      {/* Toolbar */}
      <header className="flex items-center gap-4 px-4 py-2 border-b border-slate-700 bg-slate-800">
        <h1 className="text-lg font-semibold text-slate-100">P4Now</h1>
        <SyncToolbar />
      </header>

      {/* Main content area */}
      <div className="flex flex-1 overflow-hidden">
        {/* File tree (main area) */}
        <main className="flex-1 overflow-hidden">
          <FileTree
            className="h-full"
            height={undefined} // Will use CSS height
          />
        </main>

        {/* Resizable divider */}
        <div
          className="w-1 bg-slate-700 hover:bg-blue-500 cursor-col-resize"
          onMouseDown={(e) => {
            const startX = e.clientX;
            const startWidth = sidebarWidth;

            const handleMouseMove = (moveEvent: MouseEvent) => {
              const delta = startX - moveEvent.clientX;
              const newWidth = Math.max(200, Math.min(500, startWidth + delta));
              setSidebarWidth(newWidth);
            };

            const handleMouseUp = () => {
              document.removeEventListener('mousemove', handleMouseMove);
              document.removeEventListener('mouseup', handleMouseUp);
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
          }}
        />

        {/* Changelist sidebar */}
        <aside
          className={cn(
            'overflow-hidden bg-slate-850 border-l border-slate-700 transition-all',
            sidebarCollapsed ? 'w-0' : ''
          )}
          style={{ width: sidebarCollapsed ? 0 : sidebarWidth }}
        >
          <div className="h-full flex flex-col">
            {/* Collapse toggle */}
            <button
              onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
              className="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-6 h-12 bg-slate-700 hover:bg-slate-600 rounded-l flex items-center justify-center z-10"
              style={{ left: sidebarCollapsed ? '100%' : undefined }}
            >
              {sidebarCollapsed ? (
                <ChevronLeft className="w-4 h-4" />
              ) : (
                <ChevronRight className="w-4 h-4" />
              )}
            </button>

            <ChangelistPanel className="flex-1 overflow-auto" />
          </div>
        </aside>
      </div>
    </div>
  );
}
```

Layout structure:
- Header with title and sync toolbar
- Main area with file tree (flexible width)
- Resizable sidebar with changelist panel
- Sidebar can be collapsed
- Uses existing dark theme colors
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/MainLayout.tsx`</verify>
  <done>MainLayout combines file tree, changelist panel, and toolbar in responsive layout</done>
</task>

<task type="auto">
  <name>Task 2: Update App.tsx with MainLayout and event subscription</name>
  <files>src/App.tsx</files>
  <action>
Replace the Phase 1 test UI with the full Phase 2 layout:

```typescript
import { useEffect } from 'react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { MainLayout } from '@/components/MainLayout';
import { StatusBar } from '@/components/StatusBar';
import { OutputPanel } from '@/components/OutputPanel';
import { Toaster } from '@/components/Toaster';
import { useP4Events } from '@/hooks/useP4Events';

// Create query client outside component to avoid recreation
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
      retry: 1,
      staleTime: 30000,
    },
  },
});

function AppContent() {
  // Initialize event subscriptions on mount
  useP4Events();

  return (
    <div className="min-h-screen h-screen bg-slate-900 text-slate-100 flex flex-col overflow-hidden">
      {/* Main application layout */}
      <MainLayout className="flex-1 overflow-hidden" />

      {/* Output panel (above status bar) */}
      <div className="fixed bottom-6 left-0 right-0 pointer-events-none">
        <div className="pointer-events-auto">
          <OutputPanel />
        </div>
      </div>

      {/* Status bar (fixed at bottom) */}
      <StatusBar />

      {/* Toast notifications */}
      <Toaster />
    </div>
  );
}

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AppContent />
    </QueryClientProvider>
  );
}

export default App;
```

Key changes from Phase 1:
- Removed test buttons (p4 info, p4 sync -n)
- Added MainLayout as primary content
- Added QueryClientProvider wrapper
- Initialize useP4Events for real-time updates
- Kept StatusBar, OutputPanel, Toaster from Phase 1

Note: QueryClientProvider is now at the App level to ensure hooks work throughout the app.
  </action>
  <verify>App runs: `npm run dev` starts without errors, UI shows file tree and changelist panel</verify>
  <done>App.tsx integrates all Phase 2 components with proper providers</done>
</task>

<task type="auto">
  <name>Task 3: Add FileTree height handling via CSS</name>
  <files>src/components/FileTree/FileTree.tsx, src/index.css</files>
  <action>
Update FileTree to handle dynamic height properly:

**In FileTree.tsx:**
```typescript
import { useRef, useEffect, useState } from 'react';

export function FileTree({ className, height }: FileTreeProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const [treeHeight, setTreeHeight] = useState(height || 600);

  // Calculate height from container if not provided
  useEffect(() => {
    if (height !== undefined) return;

    const updateHeight = () => {
      if (containerRef.current) {
        const rect = containerRef.current.getBoundingClientRect();
        setTreeHeight(rect.height);
      }
    };

    updateHeight();
    window.addEventListener('resize', updateHeight);
    return () => window.removeEventListener('resize', updateHeight);
  }, [height]);

  // ... rest of component

  return (
    <div ref={containerRef} className={cn('h-full', className)}>
      <Tree
        // ...
        height={treeHeight}
        // ...
      />
    </div>
  );
}
```

**In src/index.css, add helper class:**
```css
/* Ensure full height for tree containers */
.tree-container {
  height: 100%;
  min-height: 0; /* Allow flex children to shrink */
}
```

This ensures the tree fills available space and responds to window resizing.
  </action>
  <verify>File tree fills available height and adjusts on window resize</verify>
  <done>FileTree handles dynamic height via container measurement</done>
</task>

</tasks>

<verification>
- App launches without errors
- File tree displays in main area
- Changelist panel displays in sidebar
- Sync button in toolbar is functional
- Output panel and status bar from Phase 1 still work
- Layout is responsive to window resize
</verification>

<success_criteria>
- Complete Phase 2 UI is integrated and functional
- All components communicate via stores and events
- Layout matches CONTEXT.md specifications (tree view main, sidebar changelists)
- Phase 1 infrastructure (StatusBar, OutputPanel, Toaster) remains functional
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-workflows/02-08-SUMMARY.md`
</output>
