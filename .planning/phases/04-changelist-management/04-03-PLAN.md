---
phase: 04-changelist-management
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/components/ChangelistPanel/ChangelistContextMenu.tsx
  - src/components/ChangelistPanel/ChangelistNode.tsx
  - src/components/ChangelistPanel/ChangelistPanel.tsx
autonomous: false

must_haves:
  truths:
    - "User can right-click a file in changelist panel and see 'Move to Changelist' with submenu of available changelists"
    - "Selecting a target changelist from the submenu moves the file on the P4 server and updates the UI"
    - "Multi-selected files can all be moved via context menu"
    - "Drag-and-drop between changelists uses p4 reopen (not p4 edit)"
    - "User can submit any specific numbered changelist from the panel"
  artifacts:
    - path: "src/components/ChangelistPanel/ChangelistContextMenu.tsx"
      provides: "Right-click context menu with 'Move to Changelist' submenu"
      contains: "ChangelistContextMenu"
    - path: "src/components/ChangelistPanel/ChangelistNode.tsx"
      provides: "onContextMenu handler for file nodes"
      contains: "onContextMenu"
    - path: "src/components/ChangelistPanel/ChangelistPanel.tsx"
      provides: "Context menu state, reopen-based DnD handler"
      contains: "invokeP4Reopen"
  key_links:
    - from: "ChangelistContextMenu.tsx"
      to: "src/lib/tauri.ts"
      via: "invokeP4Reopen for file movement"
      pattern: "invokeP4Reopen"
    - from: "ChangelistPanel.tsx"
      to: "src/lib/tauri.ts"
      via: "invokeP4Reopen in handleMove"
      pattern: "invokeP4Reopen"
---

<objective>
Add right-click context menu for file movement between changelists, fix drag-and-drop to use p4 reopen, and verify all changelist management features work end-to-end.

Purpose: Complete file movement interactions (CL-05, CL-06) and verify submit works for any CL (CL-07).
Output: Context menu component with "Move to Changelist" submenu, reopen-based DnD, and verified changelist management.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-changelist-management/04-RESEARCH.md
@.planning/phases/04-changelist-management/04-02-SUMMARY.md

Key existing patterns:
- FileContextMenu.tsx provides the context menu pattern (click-outside close, Escape close, fixed positioning, z-50)
- ChangelistPanel.tsx handleMove currently uses invokeP4Edit — change to invokeP4Reopen
- react-arborist's onMove provides dragIds and parentId for DnD
- Connection store provides p4port/p4user/p4client
- Multi-select: react-arborist provides selectedIds automatically in dragIds
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create changelist context menu with "Move to Changelist" submenu</name>
  <files>
    src/components/ChangelistPanel/ChangelistContextMenu.tsx
  </files>
  <action>
Create ChangelistContextMenu.tsx following the FileContextMenu.tsx pattern:

**Props:**
- `files: P4File[]` (supports multi-select — array of selected files)
- `changelists: P4Changelist[]` (all available changelists for the submenu)
- `currentChangelistId: number` (CL the files are currently in — excluded from submenu)
- `x: number, y: number` (position)
- `onClose: () => void`

**Structure:**
- Fixed-position div with z-50, bg-slate-900, border-slate-700, rounded-md, shadow-xl (same as FileContextMenu)
- Click-outside and Escape key close handlers (same useEffect pattern)
- Menu item: "Move to Changelist >" with hover-to-show submenu
  - Submenu appears to the right (absolute left-full top-0 ml-1)
  - Lists all changelists except currentChangelistId
  - Default CL shows "Default" label, numbered CLs show "#{id} — {description}"
  - Truncate long descriptions (max-w-64)
- On click submenu item:
  - Call `invokeP4Reopen(files.map(f => f.depotPath), targetId, server, user, client)`
  - On success: toast "Moved {N} file(s) to changelist #{targetId}", invalidate queries ['p4', 'changes'] and ['p4', 'opened'], close menu
  - On error: toast error, close menu
- Show file count in header if multi-select: "Move {N} files to Changelist >"

Use `useConnectionStore()` for connection args and `useQueryClient()` for invalidation.
Use `ArrowRight` from lucide-react for the submenu indicator (or plain ">" text).
  </action>
  <verify>
`npx tsc --noEmit` passes. Component file exists and exports ChangelistContextMenu.
  </verify>
  <done>ChangelistContextMenu shows "Move to Changelist" with submenu of available changelists. Clicking a target CL calls invokeP4Reopen and invalidates queries.</done>
</task>

<task type="auto">
  <name>Task 2: Wire context menu to file nodes and fix DnD to use reopen</name>
  <files>
    src/components/ChangelistPanel/ChangelistNode.tsx
    src/components/ChangelistPanel/ChangelistPanel.tsx
  </files>
  <action>
**ChangelistNode.tsx changes:**
- Add `onContextMenu?: (e: React.MouseEvent, file: P4File) => void` prop
- On file rows (type === 'file'), add `onContextMenu` handler:
  ```
  onContextMenu={(e) => {
    e.preventDefault();
    onContextMenu?.(e, file);
  }}
  ```

**ChangelistPanel.tsx changes:**

1. **Add context menu state:**
   - `contextMenuState: { files: P4File[], currentClId: number, x: number, y: number } | null`
   - Set on right-click, clear on close

2. **Wire context menu to ChangelistNode:**
   - Pass `onContextMenu` callback that:
     - Gets the right-clicked file from the event
     - Gets the current changelist ID from the node's parent
     - Gets all selected files if multi-select is active (use tree ref's `selectedNodes`)
     - Sets contextMenuState with files, currentClId, x, y coordinates

3. **Render ChangelistContextMenu** when contextMenuState is not null:
   - Pass `files`, `changelists` (from useChangelists), `currentChangelistId`, position, and onClose

4. **Fix DnD handleMove to use invokeP4Reopen instead of invokeP4Edit:**
   - Change: `await invokeP4Edit(filePaths, targetClId)`
   - To: `await invokeP4Reopen(filePaths, targetClId, p4port, p4user, p4client)`
   - Get connection args from useConnectionStore
   - After success, invalidate both `['p4', 'changes']` and `['p4', 'opened']` queries
   - After error, also invalidate to ensure UI shows correct state

5. **Add tree ref** for accessing selected nodes:
   - `const treeRef = useRef<TreeApi<ChangelistTreeNode>>(null);`
   - Pass `ref={treeRef}` to Tree component
   - Use `treeRef.current?.selectedNodes` in context menu handler to get multi-selected files
  </action>
  <verify>
`npx tsc --noEmit` passes. Right-click on file shows context menu. DnD uses invokeP4Reopen.
  </verify>
  <done>File nodes have right-click context menu with "Move to Changelist" submenu. Multi-select works for both context menu and DnD. DnD uses p4 reopen instead of p4 edit. All movements invalidate query cache.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete changelist management: CRUD operations, drag-and-drop file movement, right-click context menu, and submit for any changelist</what-built>
  <how-to-verify>
1. Start the app with `npm run tauri dev`
2. **View changelists (CL-01):** Verify default changelist appears first with "Default" badge and muted styling. Verify numbered changelists show #{id}, description, and file count.
3. **Create changelist (CL-02):** Click "+" button in Pending Changes header. Enter a description and submit. Verify new changelist appears in the list.
4. **Edit description (CL-03):** Hover over the new changelist header, click edit (pencil) button. Change description and save. Verify description updates.
5. **Delete changelist (CL-04):** With the new changelist empty, hover and click delete (trash) button. Verify it disappears immediately (no confirmation).
6. **Drag-and-drop (CL-05):** If you have files in a changelist, drag a file to another changelist header. Verify the file moves.
7. **Context menu move (CL-06):** Right-click a file in a changelist. Verify "Move to Changelist" submenu appears listing other changelists. Select one and verify the file moves.
8. **Submit numbered CL (CL-07):** Create a changelist with files, hover and click submit button. Verify submit dialog opens for that specific changelist.
9. **Default CL edit (CL-01):** Click edit on default changelist. Verify it shows "Create Numbered Changelist" dialog and creates a new CL.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `cd src-tauri && cargo check` passes
3. All 7 requirements (CL-01 through CL-07) are testable in the running app
4. Context menu follows same visual pattern as FileContextMenu
5. DnD uses p4 reopen (not p4 edit)
6. All mutations invalidate TanStack Query cache
</verification>

<success_criteria>
- Right-click context menu on files shows "Move to Changelist" with working submenu
- Drag-and-drop moves files between changelists using p4 reopen
- Multi-select works for both DnD and context menu
- Submit button works on any changelist (default and numbered)
- Human verification confirms all 7 CL requirements work
</success_criteria>

<output>
After completion, create `.planning/phases/04-changelist-management/04-03-SUMMARY.md`
</output>
