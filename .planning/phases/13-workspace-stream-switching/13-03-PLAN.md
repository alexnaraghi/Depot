---
phase: 13-workspace-stream-switching
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/components/Header/StreamSwitcher.tsx
  - src/components/dialogs/ShelveConfirmDialog.tsx
  - src/components/MainLayout.tsx
autonomous: true

must_haves:
  truths:
    - "User sees stream dropdown in header showing current stream name"
    - "User can select a different stream and UI refreshes with new stream context"
    - "If any files are open (default or numbered CLs), confirmation dialog shows listing files to be shelved"
    - "On confirm, files are shelved to a new CL before stream switch proceeds"
    - "Stream dropdown is disabled/hidden when workspace has no stream"
  artifacts:
    - path: "src/components/Header/StreamSwitcher.tsx"
      provides: "Stream dropdown with pre-switch shelve check"
    - path: "src/components/dialogs/ShelveConfirmDialog.tsx"
      provides: "Confirmation dialog listing files that will be shelved"
  key_links:
    - from: "src/components/Header/StreamSwitcher.tsx"
      to: "src/lib/tauri.ts"
      via: "invokeP4ListStreams, invokeP4Opened, invokeP4UpdateClientStream"
      pattern: "invokeP4ListStreams|invokeP4Opened|invokeP4UpdateClientStream"
    - from: "src/components/Header/StreamSwitcher.tsx"
      to: "src/components/dialogs/ShelveConfirmDialog.tsx"
      via: "State-driven dialog open/close"
      pattern: "ShelveConfirmDialog"
---

<objective>
Create stream switcher dropdown with pre-switch shelve safety and confirmation dialog.

Purpose: Users can switch streams without losing pending work — files are automatically shelved after confirmation.
Output: StreamSwitcher component with ShelveConfirmDialog, integrated into header.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-workspace-stream-switching/13-CONTEXT.md
@.planning/phases/13-workspace-stream-switching/13-RESEARCH.md
@.planning/phases/13-workspace-stream-switching/13-01-SUMMARY.md
@src/components/MainLayout.tsx
@src/stores/connectionStore.ts
@src/stores/detailPaneStore.ts
@src/lib/tauri.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShelveConfirmDialog</name>
  <files>src/components/dialogs/ShelveConfirmDialog.tsx</files>
  <action>
Create src/components/dialogs/ShelveConfirmDialog.tsx using existing Dialog pattern (Radix Dialog from @/components/ui/dialog):

Props:
- open: boolean
- onOpenChange: (open: boolean) => void
- files: Array<{ depot_path: string; action?: string; changelist?: number }> — files that will be shelved
- onConfirm: () => void — called when user clicks "Shelve & Switch"
- onCancel: () => void — called when user cancels
- isShelving: boolean — shows spinner on confirm button while shelving

Content:
- DialogTitle: "Shelve Files Before Switching?"
- DialogDescription: "The following files have pending changes. They will be shelved to a new changelist before switching streams."
- File list: Scrollable list (max-h-[300px] overflow-y-auto) showing each file's depot path and action (edit/add/delete). Group by changelist if files span multiple CLs (show "Default Changelist" or "CL #NNN" as headers).
- Footer buttons: "Cancel" (outline) and "Shelve & Switch" (default/primary). Shelve button disabled+spinner when isShelving.
- Closing dialog = cancel (via onOpenChange)
  </action>
  <verify>Run `npx tsc --noEmit`</verify>
  <done>ShelveConfirmDialog renders file list with confirm/cancel actions</done>
</task>

<task type="auto">
  <name>Task 2: Create StreamSwitcher with shelve workflow</name>
  <files>src/components/Header/StreamSwitcher.tsx, src/components/MainLayout.tsx</files>
  <action>
Create src/components/Header/StreamSwitcher.tsx:

1. **Fetch streams** on mount using invokeP4ListStreams (from Plan 01). Store in local state. Only fetch when connected.

2. **Dropdown UI** using Radix Select:
   - Label: "Stream" in same style as WorkspaceSwitcher label
   - SelectTrigger shows current stream name (from connectionStore.stream). Show just the last segment of the stream path (e.g., "main" from "//depot/main") for readability.
   - SelectContent lists all streams. Show stream name (last segment) as primary text, full path as smaller muted text below if helpful.
   - Disable while switching

3. **Don't render** if connectionStore.stream is null (workspace has no stream — classic depot workspace).

4. **Switch logic** (when user selects new stream):
   a. Call invokeP4Opened(server, user, client) to check for open files
   b. If open files exist: open ShelveConfirmDialog showing the files. Wait for user confirmation.
   c. On confirm (shelveAndSwitch function):
      - For each unique changelist with open files: call invokeP4Shelve(clId, [], server, user, client) to shelve all files in that CL. For default CL files (changelist === 0 or undefined): create a new numbered CL first with invokeP4CreateChange("Auto-shelve before stream switch to <newStream>"), reopen files to it with invokeP4Reopen, then shelve.
      - After all shelving complete: call invokeP4UpdateClientStream(workspace, newStream, server, user)
      - Call invokeP4Info to get fresh state
      - Update connectionStore.setConnected() with new stream
      - queryClient.invalidateQueries()
      - detailPaneStore.clear()
      - toast.success(`Switched to stream ${shortName}`)
   d. On error at any step: toast.error, revert state if partially completed
   e. On cancel: close dialog, don't switch

5. **Loading state**: isSwitching flag disables dropdown, shows spinner.

6. **Integrate into MainLayout**: Import StreamSwitcher. Replace the existing static stream display div in the header with `<StreamSwitcher />`. Place it after WorkspaceSwitcher in the header's left section.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run build`</verify>
  <done>StreamSwitcher dropdown appears in header. Switching with open files shows confirmation dialog. Files are shelved before stream switch proceeds.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — compiles
2. `npm run build` — full build succeeds
3. StreamSwitcher imported in MainLayout
4. ShelveConfirmDialog shows file list before stream switch
</verification>

<success_criteria>
- Stream dropdown visible when workspace has a stream
- Selecting new stream checks for open files
- Confirmation dialog lists files to shelve with option to cancel
- On confirm: files shelved, stream switched, UI refreshes
- Toast notification on success
</success_criteria>

<output>
After completion, create `.planning/phases/13-workspace-stream-switching/13-03-SUMMARY.md`
</output>
