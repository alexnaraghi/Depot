---
phase: 20-bug-fixes-and-ui-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/commands/p4.rs
  - src/components/SettingsDialog.tsx
autonomous: true

must_haves:
  truths:
    - "Client spec loads successfully regardless of field casing in p4 output"
    - "Settings dialog is scrollable when content overflows viewport"
  artifacts:
    - path: "src-tauri/src/commands/p4.rs"
      provides: "Case-insensitive Root field lookup in parse_ztag_client_spec"
    - path: "src/components/SettingsDialog.tsx"
      provides: "Scrollable dialog content with max-height constraint"
  key_links:
    - from: "src-tauri/src/commands/p4.rs"
      to: "P4 CLI output"
      via: "parse_ztag_client_spec parses -ztag fields"
      pattern: "fields\\.get.*Root"
---

<objective>
Fix client spec parsing to handle case-insensitive field names and make the settings dialog scrollable when content overflows.

Purpose: Client spec fails to load in some configurations due to case-sensitive field parsing. Settings dialog truncates content on smaller screens.
Output: Robust client spec parsing and scrollable settings dialog.
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src-tauri/src/commands/p4.rs (lines 2210-2263 for parse_ztag_client_spec)
@src/components/SettingsDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix case-sensitive client spec field parsing</name>
  <files>src-tauri/src/commands/p4.rs</files>
  <action>
In the `parse_ztag_client_spec` function (around line 2211), the parser uses exact case-sensitive lookups like `fields.get("Root")`. Different P4 server versions or configurations may return different casing.

**Create a helper closure** at the top of the function to do case-insensitive lookups:

```rust
fn parse_ztag_client_spec(output: &str) -> Result<P4ClientSpec, String> {
    let records = parse_ztag_records(output);
    let fields = records.into_iter().next().unwrap_or_default();

    // Case-insensitive field lookup helper
    let get_field = |name: &str| -> Option<String> {
        fields.get(name).cloned().or_else(|| {
            let lower = name.to_lowercase();
            fields.iter()
                .find(|(k, _)| k.to_lowercase() == lower)
                .map(|(_, v)| v.clone())
        })
    };
```

Then replace all `fields.get("X")` calls with `get_field("X")`:

```rust
    // View lines still use exact keys (View0, View1, ...) since they're indexed
    let mut view_lines: Vec<String> = Vec::new();
    let mut view_idx = 0;
    loop {
        let key = format!("View{}", view_idx);
        if let Some(value) = get_field(&key) {
            view_lines.push(value);
            view_idx += 1;
        } else {
            break;
        }
    }

    let client = get_field("Client").ok_or("Missing Client field")?;
    let root = get_field("Root").unwrap_or_default();  // Make Root optional with fallback
    let stream = get_field("Stream");
    let owner = get_field("Owner").ok_or("Missing Owner field")?;
    let description = get_field("Description").unwrap_or_default();
    let options = get_field("Options").unwrap_or_default();
    let host = get_field("Host").unwrap_or_default();
    let submit_options = get_field("SubmitOptions")
        .unwrap_or_else(|| "submitunchanged".to_string());
```

Key changes:
1. `Root` field is now optional with `unwrap_or_default()` instead of `ok_or("Missing Root field")?` â€” stream-based workspaces with virtual roots may not have a Root field.
2. All field lookups are case-insensitive.
3. View lines also use case-insensitive lookup.
  </action>
  <verify>
Run `cargo build` in `src-tauri/` directory to verify compilation. Run existing tests:
```bash
cd src-tauri && cargo test test_parse_ztag_client_spec
```
  </verify>
  <done>Client spec parser handles any field casing. Root field is optional (defaults to empty string for virtual-root workspaces).</done>
</task>

<task type="auto">
  <name>Task 2: Make settings dialog scrollable</name>
  <files>src/components/SettingsDialog.tsx</files>
  <action>
The DialogContent currently has `className="sm:max-w-[525px]"` but no height constraint or overflow handling. When there are many settings sections, content can overflow the viewport.

**Fix**: Add `max-h-[85vh]` to DialogContent and wrap the form content (between header and footer) in a scrollable container.

1. Update the DialogContent class:
```tsx
<DialogContent className="sm:max-w-[525px] max-h-[85vh] flex flex-col">
```

2. Wrap the form's field sections in a scrollable div. The form currently has `className="space-y-4"`. Restructure so the form has a scrollable body with sticky header/footer:

```tsx
<Form {...form}>
  <form onSubmit={form.handleSubmit(onSubmit)} className="flex flex-col min-h-0 flex-1">
    <div className="space-y-4 overflow-y-auto flex-1 pr-1">
      {/* All the existing form sections go here */}
      <div>
        <h3>Diff Tool</h3>
        ...
      </div>
      <div className="border-t ...">
        <h3>Logging</h3>
        ...
      </div>
      {/* etc. */}
    </div>

    <DialogFooter className="mt-4 flex-shrink-0">
      ...
    </DialogFooter>
  </form>
</Form>
```

The key changes:
- `DialogContent` gets `max-h-[85vh] flex flex-col` for height constraint
- `form` gets `flex flex-col min-h-0 flex-1` for flex layout
- A wrapper `div` around the field sections gets `overflow-y-auto flex-1 pr-1` (pr-1 gives scrollbar breathing room)
- `DialogFooter` gets `flex-shrink-0` to stay at bottom
  </action>
  <verify>
Run `npx tsc --noEmit`. Visually verify:
1. Open settings dialog
2. Resize window to be shorter than dialog content
3. Dialog should be scrollable with footer staying at bottom
  </verify>
  <done>Settings dialog scrolls when content exceeds viewport. Header and footer remain visible. Scroll area shows all form sections.</done>
</task>

</tasks>

<verification>
1. `cargo build` and `cargo test` pass in src-tauri/
2. `npx tsc --noEmit` passes
3. Client spec loads without errors (including workspaces with non-standard field casing)
4. Settings dialog is scrollable on small viewports
</verification>

<success_criteria>
- Client spec loads successfully with any field casing from p4 output
- Root field being missing doesn't crash the parser
- Settings dialog scrolls when content overflows, footer stays visible
</success_criteria>

<output>
After completion, create `.planning/phases/20-bug-fixes-and-ui-polish/20-04-SUMMARY.md`
</output>
