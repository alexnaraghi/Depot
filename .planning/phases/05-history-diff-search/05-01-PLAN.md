---
phase: 05-history-diff-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/Cargo.toml
  - src-tauri/src/commands/p4.rs
  - src/lib/tauri.ts
  - src/types/settings.ts
  - src/lib/settings.ts
  - src/hooks/useSettings.ts
autonomous: true

must_haves:
  truths:
    - "p4_filelog command returns structured revision data with rev, change, action, date, user, description"
    - "p4_print_to_file writes a specific depot revision to a temp file"
    - "launch_diff_tool spawns external diff process without blocking the app"
    - "p4_changes_submitted returns submitted changelists with full descriptions for search"
    - "Diff tool path and args are persisted in settings and loadable by UI"
  artifacts:
    - path: "src-tauri/src/commands/p4.rs"
      provides: "p4_filelog, p4_print_to_file, launch_diff_tool, p4_changes_submitted commands"
    - path: "src/lib/tauri.ts"
      provides: "TypeScript invoke wrappers for all new commands"
    - path: "src/types/settings.ts"
      provides: "Extended P4Settings with diffToolPath and diffToolArgs"
    - path: "src/lib/settings.ts"
      provides: "Persistence for diff tool settings"
  key_links:
    - from: "src/lib/tauri.ts"
      to: "src-tauri/src/commands/p4.rs"
      via: "Tauri invoke bindings"
      pattern: "invoke.*p4_filelog|invoke.*launch_diff"
    - from: "src/lib/settings.ts"
      to: "src/types/settings.ts"
      via: "Settings type import"
      pattern: "diffToolPath|diffToolArgs"
---

<objective>
Implement all Rust backend commands for file history, revision printing, external diff tool launching, and submitted changelist fetching. Add tempfile dependency, TypeScript invoke bindings, and extend settings to persist diff tool configuration.

Purpose: Provides the complete backend foundation that the History dialog, Diff UI, and Search panel all depend on.
Output: Working Tauri commands callable from frontend, extended settings schema.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-history-diff-search/05-RESEARCH.md

@src-tauri/src/commands/p4.rs
@src-tauri/Cargo.toml
@src/lib/tauri.ts
@src/types/settings.ts
@src/lib/settings.ts
@src/hooks/useSettings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rust backend commands for filelog, print, diff launch, and submitted changes</name>
  <files>src-tauri/Cargo.toml, src-tauri/src/commands/p4.rs</files>
  <action>
1. Add `tempfile = "3"` to `[dependencies]` in Cargo.toml.

2. In `p4.rs`, add a new struct:
```rust
#[derive(Debug, Clone, Serialize)]
pub struct P4Revision {
    pub rev: i32,
    pub change: i32,
    pub action: String,
    pub file_type: String,
    pub time: i64,
    pub user: String,
    pub client: String,
    pub desc: String,
}
```

3. Add `parse_ztag_filelog(output: &str) -> Result<Vec<P4Revision>, String>` function:
   - Parse `-ztag` output where each revision block is separated by blank lines
   - Each line is `... key value` format
   - Keys: `rev`, `change`, `action`, `type`, `time`, `user`, `client`, `desc`
   - NOTE: `p4 filelog -ztag` produces records with indexed fields like `rev0`, `change0`, `action0`, `type0`, `time0`, `user0`, `client0`, `desc0`, `rev1`, `change1`, etc. — all revisions are in a single record. Parse these indexed fields to extract revisions.
   - Convert `rev`, `change` to i32, `time` to i64 (epoch seconds)

4. Add `#[tauri::command] pub async fn p4_filelog(depot_path: String, max_revisions: Option<i32>, server: Option<String>, user: Option<String>, client: Option<String>) -> Result<Vec<P4Revision>, String>`:
   - Build command: `p4 -ztag filelog -m {max} {depot_path}`
   - Use `apply_connection_args` pattern from existing commands
   - Parse with `parse_ztag_filelog`

5. Add `#[tauri::command] pub async fn p4_print_to_file(depot_path: String, revision: i32, server: Option<String>, user: Option<String>, client: Option<String>) -> Result<String, String>`:
   - Create `NamedTempFile` with `.suffix()` matching the file extension from depot_path (so diff tools show syntax highlighting)
   - Run `p4 print -q -o {temp_path} {depot_path}#{revision}`
   - Use `.persist()` or `into_temp_path()` to prevent deletion — return the temp file path as String
   - Note: Use `tempfile::Builder::new().suffix(".ext").tempfile()` to set extension

6. Add `#[tauri::command] pub async fn launch_diff_tool(left_path: String, right_path: String, diff_tool_path: String, diff_tool_args: Option<String>, app: AppHandle) -> Result<(), String>`:
   - If `diff_tool_args` is provided and non-empty, parse it to extract custom argument patterns. Support `{left}` and `{right}` placeholders in the args string. If placeholders found, substitute them. If no placeholders, append left_path and right_path as final args.
   - If no args, just pass `left_path` and `right_path` as arguments
   - Use `std::process::Command::new(&diff_tool_path).args(...).spawn()` (NOT `.output()` — must not block)
   - Return Ok(()) immediately after spawn

7. Add `#[tauri::command] pub async fn p4_changes_submitted(max_changes: Option<i32>, server: Option<String>, user: Option<String>, client: Option<String>) -> Result<Vec<P4Changelist>, String>`:
   - Build command: `p4 -ztag changes -l -s submitted -m {max}`
   - Use existing `parse_ztag_changes` function (already handles `-ztag` changelist parsing)
   - Default max to 500 if None

8. Register all new commands in `mod.rs` or wherever commands are registered (check existing pattern).
  </action>
  <verify>
Run `cargo build` in src-tauri/ — must compile without errors. Check that all 4 new commands are registered.
  </verify>
  <done>Four new Tauri commands compile and are registered: p4_filelog, p4_print_to_file, launch_diff_tool, p4_changes_submitted.</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript bindings and diff tool settings persistence</name>
  <files>src/lib/tauri.ts, src/types/settings.ts, src/lib/settings.ts, src/hooks/useSettings.ts</files>
  <action>
1. In `src/types/settings.ts`, extend the settings schema to add:
   - `diffToolPath: z.string()` (default: `""`)
   - `diffToolArgs: z.string()` (default: `""` — for custom args like `--diff {left} {right}`)
   Update `defaultSettings` accordingly.

2. In `src/lib/settings.ts`, update `loadSettings` and `saveSettings` to handle the new `diffToolPath` and `diffToolArgs` fields.

3. In `src/hooks/useSettings.ts`, ensure the settings hook exposes the new fields (should work automatically if it reads from the settings type).

4. In `src/lib/tauri.ts`, add:

```typescript
export interface P4Revision {
  rev: number;
  change: number;
  action: string;
  file_type: string;
  time: number;
  user: string;
  client: string;
  desc: string;
}

export async function invokeP4Filelog(
  depotPath: string, maxRevisions?: number,
  server?: string, user?: string, client?: string
): Promise<P4Revision[]> {
  return invoke<P4Revision[]>('p4_filelog', { depotPath, maxRevisions, server, user, client });
}

export async function invokeP4PrintToFile(
  depotPath: string, revision: number,
  server?: string, user?: string, client?: string
): Promise<string> {
  return invoke<string>('p4_print_to_file', { depotPath, revision, server, user, client });
}

export async function invokeLaunchDiffTool(
  leftPath: string, rightPath: string,
  diffToolPath: string, diffToolArgs?: string
): Promise<void> {
  return invoke<void>('launch_diff_tool', { leftPath, rightPath, diffToolPath, diffToolArgs });
}

export async function invokeP4ChangesSubmitted(
  maxChanges?: number,
  server?: string, user?: string, client?: string
): Promise<P4ChangelistInfo[]> {
  return invoke<P4ChangelistInfo[]>('p4_changes_submitted', { maxChanges, server, user, client });
}
```

5. Note: `invokeP4ChangesSubmitted` returns `P4ChangelistInfo[]` (the existing frontend type that maps to `P4Changelist` on Rust side).
  </action>
  <verify>
Run `npm run check` or TypeScript compilation — no type errors. Verify settings schema includes diffToolPath and diffToolArgs.
  </verify>
  <done>TypeScript bindings exist for all 4 new commands. Settings schema extended with diffToolPath/diffToolArgs. Settings load/save handles new fields.</done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds in src-tauri/
2. TypeScript compiles without errors
3. All 4 new commands registered and have matching TS bindings
4. Settings schema includes diff tool configuration fields
</verification>

<success_criteria>
- p4_filelog, p4_print_to_file, launch_diff_tool, p4_changes_submitted commands compile and are registered
- TypeScript invoke wrappers match Rust command signatures
- Settings persist diff tool path and arguments
</success_criteria>

<output>
After completion, create `.planning/phases/05-history-diff-search/05-01-SUMMARY.md`
</output>
