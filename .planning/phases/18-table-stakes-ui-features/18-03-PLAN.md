---
phase: 18-table-stakes-ui-features
plan: 03
type: execute
wave: 2
depends_on: ["18-02"]
files_modified:
  - src/hooks/useChangelistFiles.ts
  - src/components/DetailPane/ChangelistDetailView.tsx
  - src/components/DetailPane/RevisionDetailView.tsx
autonomous: true

must_haves:
  truths:
    - "User can view complete file list for any submitted changelist"
    - "Files in submitted CL show action indicators (add, edit, delete, integrate)"
    - "User can click file in submitted CL to view that revision"
    - "RevisionDetailView shows sibling files from same changelist"
  artifacts:
    - path: "src/hooks/useChangelistFiles.ts"
      provides: "Hook for fetching submitted changelist file list"
      contains: "useChangelistFiles"
    - path: "src/components/DetailPane/ChangelistDetailView.tsx"
      provides: "Submitted changelist file list display"
      contains: "useChangelistFiles"
    - path: "src/components/DetailPane/RevisionDetailView.tsx"
      provides: "Sibling files section with real data"
      contains: "useChangelistFiles"
  key_links:
    - from: "src/hooks/useChangelistFiles.ts"
      to: "src/lib/tauri.ts"
      via: "invokeP4Describe"
      pattern: "invokeP4Describe"
    - from: "src/components/DetailPane/ChangelistDetailView.tsx"
      to: "src/hooks/useChangelistFiles.ts"
      via: "useChangelistFiles hook"
      pattern: "useChangelistFiles"
---

<objective>
Display submitted changelist file lists with action badges and click-to-view.

Purpose: Satisfies CLFILE-01, CLFILE-02, CLFILE-03 requirements. Removes TODO placeholder from RevisionDetailView.

Output: Submitted changelists show complete file list with action badges; clicking files navigates to revision view.
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-table-stakes-ui-features/18-RESEARCH.md
@.planning/phases/18-table-stakes-ui-features/18-02-SUMMARY.md

# Existing patterns to follow
@src/components/DetailPane/ChangelistDetailView.tsx — getActionBadgeColor function, file list display pattern
@src/components/DetailPane/RevisionDetailView.tsx — TODO comment for sibling files
@src/hooks/useFileHistory.ts — TanStack Query hook pattern
@src/lib/tauri.ts — invokeP4Describe wrapper
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useChangelistFiles hook</name>
  <files>src/hooks/useChangelistFiles.ts</files>
  <action>
Create new hook file at src/hooks/useChangelistFiles.ts:

```typescript
import { useQuery } from '@tanstack/react-query';
import { invokeP4Describe, P4ChangelistDescription } from '@/lib/tauri';

/**
 * Hook for fetching submitted changelist file list
 *
 * Uses p4 describe -s to get file list without diffs.
 * Only fetches for submitted changelists (pending CLs have files in P4Changelist already).
 *
 * @param changelistId - The changelist ID to fetch files for
 * @param enabled - Whether to fetch (false for pending CLs)
 * @returns Query result with changelist description including files
 */
export function useChangelistFiles(
  changelistId: number,
  enabled: boolean = true
) {
  return useQuery({
    queryKey: ['p4', 'describe', changelistId],
    queryFn: async (): Promise<P4ChangelistDescription> => {
      return invokeP4Describe(changelistId);
    },
    enabled: enabled && changelistId > 0,
    staleTime: 60000, // Submitted CLs don't change, cache for 1 minute
    refetchOnWindowFocus: false,
  });
}
```
  </action>
  <verify>Run `npm run build` to verify TypeScript compiles</verify>
  <done>useChangelistFiles hook created with TanStack Query pattern</done>
</task>

<task type="auto">
  <name>Task 2: Update ChangelistDetailView to show submitted CL files</name>
  <files>src/components/DetailPane/ChangelistDetailView.tsx</files>
  <action>
Import the new hook and add file list for submitted changelists.

Add import at top:
```typescript
import { useChangelistFiles } from '@/hooks/useChangelistFiles';
```

Inside the component, add the query for submitted CLs (after existing hooks):
```typescript
// Fetch file list for submitted changelists (pending CLs already have files)
const { data: submittedCLData, isLoading: filesLoading } = useChangelistFiles(
  changelist.id,
  isSubmitted
);
```

Extract the existing getActionBadgeColor function to module level (move it outside the component) so it can be reused. It's currently inside ChangelistDetailView.

Update the file list section to handle submitted changelists. After the existing `{hasFiles && (...)}` block, add a section for submitted CL files:

```tsx
{/* File list for submitted changelists */}
{isSubmitted && (
  <div>
    <h3 className="text-sm font-semibold mb-2 text-muted-foreground">
      FILES {submittedCLData ? `(${submittedCLData.files.length})` : ''}
    </h3>
    {filesLoading ? (
      <div className="space-y-2">
        {Array.from({ length: 3 }).map((_, i) => (
          <div key={i} className="h-8 bg-slate-700/50 rounded animate-pulse" />
        ))}
      </div>
    ) : submittedCLData?.files.length ? (
      <div className="space-y-1">
        {submittedCLData.files.map((file) => {
          const fileName = file.depotPath.split('/').pop() || file.depotPath;

          return (
            <div
              key={file.depotPath}
              className={cn(
                'flex items-center gap-3 px-3 py-2 rounded cursor-pointer',
                'hover:bg-accent transition-colors'
              )}
              onClick={() => handleSubmittedFileClick(file.depotPath, file.revision)}
            >
              {/* Action badge */}
              <Badge
                className={cn('px-2 py-0.5 text-xs', getActionBadgeColor(file.action))}
              >
                {file.action || 'edit'}
              </Badge>

              {/* Filename */}
              <span className="flex-1 truncate text-sm">{fileName}</span>

              {/* Revision */}
              <span className="text-xs text-muted-foreground">
                #{file.revision}
              </span>
            </div>
          );
        })}
      </div>
    ) : (
      <p className="text-sm text-muted-foreground italic">No files in changelist</p>
    )}
  </div>
)}
```

Update the getActionBadgeColor function to accept string action (to match P4DescribeFile):
```typescript
const getActionBadgeColor = (action?: FileAction | string): string => {
  const actionLower = typeof action === 'string' ? action.toLowerCase() : action;
  switch (actionLower) {
    case FileAction.Edit:
    case 'edit':
      return 'bg-blue-900/30 text-blue-300';
    case FileAction.Add:
    case 'add':
      return 'bg-green-900/30 text-green-300';
    case FileAction.Delete:
    case 'delete':
      return 'bg-red-900/30 text-red-300';
    case FileAction.Branch:
    case 'branch':
      return 'bg-purple-900/30 text-purple-300';
    case FileAction.Integrate:
    case 'integrate':
      return 'bg-yellow-900/30 text-yellow-300';
    case FileAction.MoveAdd:
    case 'move/add':
    case FileAction.MoveDelete:
    case 'move/delete':
      return 'bg-orange-900/30 text-orange-300';
    default:
      return 'bg-muted text-muted-foreground';
  }
};
```

Add handler for clicking submitted CL files:
```typescript
const handleSubmittedFileClick = (depotPath: string, revision: number) => {
  // Navigate to revision detail view
  // Need to get localPath from depot path - use empty string as placeholder
  // RevisionDetailView will handle showing content via depot path
  useDetailPaneStore.getState().drillToRevision(depotPath, '', {
    rev: revision,
    action: 'edit', // Will be refined when viewing
    user: changelist.user,
    time: 0, // Unknown from describe
    desc: changelist.description,
  });
};
```

Note: The drillToRevision method needs depotPath, localPath, and revision object. For submitted files, localPath may not exist locally. Use empty string and the viewer will handle it via depot path.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles.
Manually test clicking on a submitted changelist and verify files load with action badges.
  </verify>
  <done>ChangelistDetailView displays submitted changelist file list with action badges and click navigation</done>
</task>

<task type="auto">
  <name>Task 3: Update RevisionDetailView sibling files section</name>
  <files>src/components/DetailPane/RevisionDetailView.tsx</files>
  <action>
Replace the TODO placeholder with real sibling files from p4 describe.

Add imports at top:
```typescript
import { useChangelistFiles } from '@/hooks/useChangelistFiles';
import { Badge } from '@/components/ui/badge';
import { cn } from '@/lib/utils';
```

Inside the component, add hook to fetch changelist files. The revision object has the changelist info, but we need to find it. Use the revision's change number (revision.change):

Actually, looking at P4Revision type, it doesn't have a change field. We need to determine the changelist ID that this revision belongs to. The best approach is to add a new query.

Actually, simpler approach: We already have the changelist ID available when navigating from a changelist view (via handleAnnotationClick which calls selectChangelist). But when viewing from file history, we don't have the CL ID.

For now, let's use a different approach: Show a "View Changelist" button that navigates to the changelist detail when clicked.

Update the sibling files section:

```tsx
{/* Sibling files section */}
<div>
  <h3 className="text-sm font-semibold mb-2 text-muted-foreground">
    FILES IN THIS SUBMIT
  </h3>
  <p className="text-sm text-muted-foreground">
    Change #{revision.change || 'unknown'}
  </p>
  {revision.change && (
    <Button
      variant="outline"
      size="sm"
      className="mt-2"
      onClick={() => handleAnnotationClick(revision.change!)}
    >
      View Changelist Files
    </Button>
  )}
</div>
```

Wait, checking the P4Revision interface... Let me verify the type.

Actually, looking at the code more carefully:
1. P4Revision is from filelog, it has: rev, action, user, time, desc, change
2. The 'change' field is the changelist number

Check the backend p4_filelog command output to confirm 'change' field exists. If it does, we can use it.

Assuming P4Revision has 'change' field (checking the tauri.ts types), update RevisionDetailView:

```typescript
// Fetch sibling files for this revision's changelist
const { data: changelistData, isLoading: siblingFilesLoading } = useChangelistFiles(
  revision.change || 0,
  !!revision.change
);
```

Replace the TODO section with:

```tsx
{/* Sibling files section */}
<div>
  <h3 className="text-sm font-semibold mb-2 text-muted-foreground">
    FILES IN THIS SUBMIT
    {changelistData && ` (${changelistData.files.length})`}
  </h3>
  {siblingFilesLoading ? (
    <div className="space-y-2">
      {Array.from({ length: 3 }).map((_, i) => (
        <div key={i} className="h-6 bg-slate-700/50 rounded animate-pulse" />
      ))}
    </div>
  ) : changelistData?.files.length ? (
    <div className="space-y-1 max-h-48 overflow-y-auto">
      {changelistData.files.map((file) => {
        const fileName = file.depotPath.split('/').pop() || file.depotPath;
        const isCurrent = file.depotPath === depotPath;

        return (
          <div
            key={file.depotPath}
            className={cn(
              'flex items-center gap-2 px-2 py-1 rounded text-sm',
              !isCurrent && 'cursor-pointer hover:bg-accent',
              isCurrent && 'bg-accent/50'
            )}
            onClick={() => !isCurrent && handleSiblingClick(file.depotPath, file.revision)}
          >
            <Badge
              variant="outline"
              className={cn('px-1 py-0 text-xs', getActionColor(file.action))}
            >
              {file.action}
            </Badge>
            <span className={cn('flex-1 truncate', isCurrent && 'font-medium')}>
              {fileName}
            </span>
            <span className="text-xs text-muted-foreground">#{file.revision}</span>
          </div>
        );
      })}
    </div>
  ) : revision.change ? (
    <p className="text-sm text-muted-foreground italic">No files found</p>
  ) : (
    <p className="text-sm text-muted-foreground italic">Changelist unknown</p>
  )}
</div>
```

Add helper functions:
```typescript
const handleSiblingClick = (siblingDepotPath: string, siblingRevision: number) => {
  // Navigate to the sibling file's revision view
  useDetailPaneStore.getState().drillToRevision(siblingDepotPath, '', {
    rev: siblingRevision,
    action: 'edit',
    user: revision.user,
    time: revision.time,
    desc: revision.desc,
  });
};

const getActionColor = (action: string): string => {
  switch (action.toLowerCase()) {
    case 'edit': return 'text-blue-400 border-blue-400/30';
    case 'add': return 'text-green-400 border-green-400/30';
    case 'delete': return 'text-red-400 border-red-400/30';
    case 'branch': return 'text-purple-400 border-purple-400/30';
    case 'integrate': return 'text-yellow-400 border-yellow-400/30';
    case 'move/add':
    case 'move/delete': return 'text-orange-400 border-orange-400/30';
    default: return 'text-muted-foreground';
  }
};
```

Note: Check P4Revision interface in tauri.ts to confirm 'change' field exists. If not, need to update p4_filelog to include it.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles.
Manually test clicking on a file revision and verify sibling files section shows real data.
  </verify>
  <done>RevisionDetailView shows sibling files from same changelist with click navigation</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Clicking submitted changelist shows file list with action badges
3. Clicking file in submitted CL navigates to revision view
4. RevisionDetailView shows sibling files from same changelist
5. Current file is highlighted in sibling list
6. Clicking sibling file navigates to that revision
</verification>

<success_criteria>
- CLFILE-01: User can view complete file list for any submitted changelist
- CLFILE-02: Files show action indicators (add, edit, delete, integrate, branch, move)
- CLFILE-03: User can click file in submitted CL to view that revision
- RevisionDetailView TODO removed and replaced with real sibling files
</success_criteria>

<output>
After completion, create `.planning/phases/18-table-stakes-ui-features/18-03-SUMMARY.md`
</output>
