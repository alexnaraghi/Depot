---
phase: 02-core-workflows
plan: 06
type: execute
wave: 3
depends_on: ["02-02", "02-04"]
files_modified:
  - src/components/ChangelistPanel/ChangelistPanel.tsx
  - src/components/ChangelistPanel/useChangelists.ts
  - src/components/ChangelistPanel/SubmitDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can view pending changelists in sidebar"
    - "User can see files in each changelist"
    - "User can submit changelist with description"
    - "User can drag files between changelists"
  artifacts:
    - path: "src/components/ChangelistPanel/ChangelistPanel.tsx"
      provides: "Changelist sidebar component"
      exports: ["ChangelistPanel"]
    - path: "src/components/ChangelistPanel/useChangelists.ts"
      provides: "Changelist data loading hook"
      exports: ["useChangelists"]
    - path: "src/components/ChangelistPanel/SubmitDialog.tsx"
      provides: "Submit confirmation dialog"
      exports: ["SubmitDialog"]
  key_links:
    - from: "src/components/ChangelistPanel/ChangelistPanel.tsx"
      to: "react-arborist"
      via: "Tree component"
      pattern: "import.*Tree.*from.*react-arborist"
    - from: "src/components/ChangelistPanel/useChangelists.ts"
      to: "src/stores/changelistStore.ts"
      via: "store subscription"
      pattern: "useChangelistStore"
    - from: "src/components/ChangelistPanel/SubmitDialog.tsx"
      to: "src/hooks/useFileOperations.ts"
      via: "submit action"
      pattern: "useFileOperations"
---

<objective>
Create the changelist sidebar panel showing pending changelists with file lists, submit functionality, and drag-and-drop between changelists.

Purpose: Users organize their work into changelists. The sidebar shows all pending changes grouped by changelist, allows submitting with a description, and supports moving files between changelists.

Output: ChangelistPanel component with tree view, SubmitDialog for submissions, and drag-and-drop support.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-workflows/02-CONTEXT.md
@.planning/phases/02-core-workflows/02-RESEARCH.md
@src/components/ChangelistPanel/ChangelistNode.tsx
@src/stores/changelistStore.ts
@src/hooks/useFileOperations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useChangelists hook</name>
  <files>src/components/ChangelistPanel/useChangelists.ts</files>
  <action>
Create hook for loading and managing changelist data:

```typescript
import { useEffect, useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { useChangelistStore } from '@/stores/changelistStore';
import { invokeP4Changes, invokeP4Opened } from '@/lib/tauri';
import { buildChangelistTree, ChangelistTreeNode } from '@/utils/treeBuilder';
import { P4Changelist, P4File } from '@/types/p4';

export function useChangelists() {
  const { changelists, setChangelists, setLoading } = useChangelistStore();

  // Load pending changelists
  const { data: clData, isLoading: clLoading } = useQuery({
    queryKey: ['p4', 'changes', 'pending'],
    queryFn: () => invokeP4Changes('pending'),
    refetchOnWindowFocus: false,
    staleTime: 30000,
  });

  // Load opened files (to associate with changelists)
  const { data: openedData, isLoading: openedLoading } = useQuery({
    queryKey: ['p4', 'opened'],
    queryFn: () => invokeP4Opened(),
    refetchOnWindowFocus: false,
    staleTime: 30000,
  });

  // Merge changelist data with opened files
  useEffect(() => {
    if (!clData || !openedData) return;

    const clMap = new Map<number, P4Changelist>();

    // Initialize default changelist
    clMap.set(0, {
      id: 0,
      description: 'Default changelist',
      user: '',
      client: '',
      status: 'pending',
      files: [],
      fileCount: 0,
    });

    // Add named changelists
    for (const cl of clData) {
      clMap.set(cl.id, {
        id: cl.id,
        description: cl.description,
        user: cl.user,
        client: cl.client,
        status: cl.status,
        files: [],
        fileCount: 0,
      });
    }

    // Associate files with changelists
    for (const file of openedData) {
      const clId = file.changelist ?? 0;
      const cl = clMap.get(clId);
      if (cl) {
        const p4File: P4File = {
          depotPath: file.depot_path,
          localPath: file.local_path,
          status: mapStatus(file.status, file.action),
          action: file.action,
          revision: file.revision,
          headRevision: file.head_revision,
          changelist: file.changelist,
          fileType: file.file_type,
          isDirectory: false,
        };
        cl.files.push(p4File);
        cl.fileCount++;
      }
    }

    setChangelists(Array.from(clMap.values()));
  }, [clData, openedData, setChangelists]);

  // Build tree from store
  const treeData = useMemo(() => {
    const clArray = Array.from(changelists.values());
    // Only show changelists with files or non-empty description
    const nonEmpty = clArray.filter(cl => cl.fileCount > 0 || cl.id !== 0);
    return buildChangelistTree(nonEmpty);
  }, [changelists]);

  const isLoading = clLoading || openedLoading;

  return {
    treeData,
    isLoading,
    changelists: Array.from(changelists.values()),
  };
}

function mapStatus(status: string, action?: string): FileStatus {
  // Same mapping as useFileTree
  if (action) {
    switch (action) {
      case 'edit': return 'checkedOut';
      case 'add': return 'added';
      case 'delete': return 'deleted';
      default: return 'checkedOut';
    }
  }
  return 'synced';
}
```

Key points:
- Query both changelists and opened files
- Merge them to get complete picture
- Default changelist (id=0) always exists
- Hide default if empty
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/ChangelistPanel/useChangelists.ts`</verify>
  <done>useChangelists loads and merges changelist data with opened files</done>
</task>

<task type="auto">
  <name>Task 2: Create SubmitDialog component</name>
  <files>src/components/ChangelistPanel/SubmitDialog.tsx</files>
  <action>
Create submit dialog using shadcn/ui AlertDialog pattern:

**First, ensure AlertDialog component exists:**
```bash
npx shadcn@latest add alert-dialog
```

**Verify installation before proceeding:**
- Check that `src/components/ui/alert-dialog.tsx` exists after running the command
- If the file already exists, the command will skip it safely

**Then create SubmitDialog:**

```typescript
import { useState } from 'react';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { useFileOperations } from '@/hooks/useFileOperations';
import { P4Changelist } from '@/types/p4';

interface SubmitDialogProps {
  changelist: P4Changelist | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSubmitted?: (newChangelistId: number) => void;
}

export function SubmitDialog({
  changelist,
  open,
  onOpenChange,
  onSubmitted,
}: SubmitDialogProps) {
  const { submit } = useFileOperations();
  const [description, setDescription] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Initialize description from changelist
  const handleOpen = () => {
    if (changelist) {
      setDescription(changelist.description);
    }
  };

  const handleSubmit = async () => {
    if (!changelist) return;

    setIsSubmitting(true);
    try {
      const newClId = await submit(changelist.id, description);
      onOpenChange(false);
      onSubmitted?.(newClId);
    } catch (error) {
      // Error already handled by useFileOperations (toast)
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!changelist) return null;

  return (
    <AlertDialog open={open} onOpenChange={onOpenChange}>
      <AlertDialogContent className="max-w-md">
        <AlertDialogHeader>
          <AlertDialogTitle>
            Submit Changelist {changelist.id === 0 ? '(Default)' : changelist.id}
          </AlertDialogTitle>
          <AlertDialogDescription>
            {changelist.fileCount} file(s) will be submitted.
          </AlertDialogDescription>
        </AlertDialogHeader>

        <div className="my-4">
          <label className="block text-sm font-medium text-slate-300 mb-2">
            Description
          </label>
          <textarea
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            className="w-full h-24 px-3 py-2 bg-slate-800 border border-slate-700 rounded-md text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Enter changelist description..."
          />
        </div>

        <div className="mb-4 max-h-32 overflow-y-auto">
          <div className="text-sm text-slate-400 mb-1">Files:</div>
          {changelist.files.map((file) => (
            <div key={file.depotPath} className="text-sm text-slate-300 truncate">
              {file.depotPath.split('/').pop()}
            </div>
          ))}
        </div>

        <AlertDialogFooter>
          <AlertDialogCancel disabled={isSubmitting}>Cancel</AlertDialogCancel>
          <AlertDialogAction
            onClick={handleSubmit}
            disabled={isSubmitting || !description.trim()}
          >
            {isSubmitting ? 'Submitting...' : 'Submit'}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

Features:
- Shows changelist info and file list
- Editable description field
- Disable submit if description empty
- Loading state during submission
- Error handling via toast from hook
  </action>
  <verify>
1. Alert dialog component exists: `ls src/components/ui/alert-dialog.tsx` shows file
2. TypeScript compiles: `npx tsc --noEmit src/components/ChangelistPanel/SubmitDialog.tsx`
  </verify>
  <done>SubmitDialog allows user to edit description and submit changelist</done>
</task>

<task type="auto">
  <name>Task 3: Create ChangelistPanel component</name>
  <files>src/components/ChangelistPanel/ChangelistPanel.tsx</files>
  <action>
Create the changelist sidebar panel:

```typescript
import { useCallback, useState } from 'react';
import { Tree, MoveHandler } from 'react-arborist';
import { Send, Plus } from 'lucide-react';
import { useChangelists } from './useChangelists';
import { ChangelistNode } from './ChangelistNode';
import { SubmitDialog } from './SubmitDialog';
import { ChangelistTreeNode } from '@/utils/treeBuilder';
import { P4Changelist } from '@/types/p4';
import { invokeP4Edit } from '@/lib/tauri';
import { cn } from '@/lib/utils';
import toast from 'react-hot-toast';

interface ChangelistPanelProps {
  className?: string;
}

export function ChangelistPanel({ className }: ChangelistPanelProps) {
  const { treeData, isLoading, changelists } = useChangelists();
  const [selectedChangelist, setSelectedChangelist] = useState<P4Changelist | null>(null);
  const [submitDialogOpen, setSubmitDialogOpen] = useState(false);

  // Handle drag-and-drop between changelists
  const handleMove: MoveHandler<ChangelistTreeNode> = useCallback(async ({ dragIds, parentId }) => {
    // parentId is the changelist ID we're dropping onto
    if (!parentId) return;

    // Extract changelist number from parentId (format: "cl-{id}")
    const targetClId = parseInt(parentId.replace('cl-', ''), 10);
    if (isNaN(targetClId)) return;

    // Get depot paths of dragged files
    const filePaths: string[] = [];
    for (const dragId of dragIds) {
      // dragId format: "file-{depot_path}"
      if (dragId.startsWith('file-')) {
        filePaths.push(dragId.replace('file-', ''));
      }
    }

    if (filePaths.length === 0) return;

    try {
      // Move files to new changelist via p4 edit -c <changelist>
      // Note: p4 edit with already-opened files acts as p4 reopen, moving
      // files to the specified changelist. See 02-03-PLAN.md Task 2 for details.
      await invokeP4Edit(filePaths, targetClId);
      toast.success(`Moved ${filePaths.length} file(s) to changelist ${targetClId}`);
    } catch (error) {
      toast.error(`Failed to move files: ${error}`);
    }
  }, []);

  // Handle submit button click on changelist
  const handleSubmitClick = useCallback((cl: P4Changelist) => {
    setSelectedChangelist(cl);
    setSubmitDialogOpen(true);
  }, []);

  // Loading state
  if (isLoading) {
    return (
      <div className={cn('p-4', className)}>
        <div className="text-slate-400 text-sm">Loading changelists...</div>
      </div>
    );
  }

  // Empty state
  if (treeData.length === 0) {
    return (
      <div className={cn('p-4', className)}>
        <h2 className="text-lg font-semibold mb-4">Pending Changes</h2>
        <div className="text-slate-400 text-sm">No pending changes</div>
      </div>
    );
  }

  return (
    <div className={cn('flex flex-col h-full', className)}>
      <div className="flex items-center justify-between p-4 pb-2">
        <h2 className="text-lg font-semibold">Pending Changes</h2>
        {/* Future: Add new changelist button */}
      </div>

      <div className="flex-1 overflow-hidden">
        <Tree
          data={treeData}
          width="100%"
          height={400}
          indent={16}
          rowHeight={32}
          openByDefault
          disableDrag={(node) => node.data.type === 'changelist'}
          disableDrop={(node) => node.data.type === 'file'}
          onMove={handleMove}
        >
          {(props) => (
            <ChangelistNode
              {...props}
              onSubmit={() => {
                if (props.node.data.type === 'changelist') {
                  handleSubmitClick(props.node.data.data as P4Changelist);
                }
              }}
            />
          )}
        </Tree>
      </div>

      <SubmitDialog
        changelist={selectedChangelist}
        open={submitDialogOpen}
        onOpenChange={setSubmitDialogOpen}
      />
    </div>
  );
}
```

Update ChangelistNode to accept onSubmit prop:
```typescript
// In ChangelistNode.tsx, add submit button for changelist rows
{node.data.type === 'changelist' && (
  <button
    onClick={(e) => {
      e.stopPropagation();
      onSubmit?.();
    }}
    className="opacity-0 group-hover:opacity-100 p-1 hover:bg-slate-600 rounded"
    title="Submit"
  >
    <Send className="w-4 h-4" />
  </button>
)}
```

Features:
- Shows all pending changelists with file counts
- Expand changelist to see files
- Drag files between changelists
- Submit button appears on hover
- Submit dialog for confirmation
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/ChangelistPanel/ChangelistPanel.tsx`</verify>
  <done>ChangelistPanel shows changelists with drag-drop and submit functionality</done>
</task>

</tasks>

<verification>
- ChangelistPanel renders pending changelists
- Files display under their changelist
- Drag-drop moves files between changelists
- Submit dialog allows editing description
- Empty state displays when no pending changes
</verification>

<success_criteria>
- User can view all pending changelists in sidebar
- User can see which files are in each changelist
- User can drag files between changelists
- User can submit changelist with edited description
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-workflows/02-06-SUMMARY.md`
</output>
