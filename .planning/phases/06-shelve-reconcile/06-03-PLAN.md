---
phase: 06-shelve-reconcile
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/dialogs/ReconcilePreviewDialog.tsx
  - src/hooks/useReconcile.ts
  - src/components/MainLayout.tsx
  - src/components/SyncToolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Reconcile button in toolbar to scan workspace"
    - "User sees a preview dialog listing detected offline edits, adds, and deletes"
    - "User can select/deselect individual files with checkboxes before applying"
    - "User can apply reconcile for only selected files"
    - "User can choose target changelist for reconciled files"
    - "Progress feedback shown during reconcile scan"
  artifacts:
    - path: "src/components/dialogs/ReconcilePreviewDialog.tsx"
      provides: "Dialog with file checkboxes, select all/none, grouped by action type, apply button"
      min_lines: 80
    - path: "src/hooks/useReconcile.ts"
      provides: "Hook for reconcile preview query and apply mutation"
      min_lines: 30
  key_links:
    - from: "src/hooks/useReconcile.ts"
      to: "src/lib/tauri.ts"
      via: "invokeP4ReconcilePreview, invokeP4ReconcileApply"
      pattern: "invokeP4Reconcile(Preview|Apply)"
    - from: "src/components/dialogs/ReconcilePreviewDialog.tsx"
      to: "src/hooks/useReconcile.ts"
      via: "useReconcile hook"
      pattern: "useReconcile"
    - from: "src/components/SyncToolbar.tsx"
      to: "src/components/dialogs/ReconcilePreviewDialog.tsx"
      via: "Reconcile button opens dialog"
      pattern: "ReconcilePreviewDialog"
---

<objective>
Add reconcile preview dialog with file selection and a toolbar button to trigger workspace reconcile.

Purpose: Users can detect offline edits/adds/deletes and selectively apply them — completing RECON-01 through RECON-04.
Output: ReconcilePreviewDialog component, useReconcile hook, Reconcile toolbar button.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-shelve-reconcile/06-RESEARCH.md
@.planning/phases/06-shelve-reconcile/06-01-SUMMARY.md

@src/components/SyncToolbar.tsx
@src/components/MainLayout.tsx
@src/components/dialogs/FileHistoryDialog.tsx
@src/components/ChangelistPanel/SubmitDialog.tsx
@src/lib/tauri.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useReconcile hook and ReconcilePreviewDialog component</name>
  <files>src/hooks/useReconcile.ts, src/components/dialogs/ReconcilePreviewDialog.tsx</files>
  <action>
**useReconcile.ts:**
Create a hook providing:
- `reconcilePreview` — TanStack useMutation (not useQuery — user triggers manually) calling invokeP4ReconcilePreview. Returns ReconcilePreview[].
- `reconcileApply` — TanStack useMutation calling invokeP4ReconcileApply with selected file paths and optional changelistId. On success: toast success ("N file(s) reconciled"), invalidate `['p4', 'opened']`, `['p4', 'changes']`, `['p4', 'fstat']`.
- Use connection store for server/user/client args.

**ReconcilePreviewDialog.tsx:**
Create a dialog component following the AlertDialog pattern used by SubmitDialog and FileHistoryDialog:
- Props: `{ open: boolean; onOpenChange: (open: boolean) => void }`
- State:
  - `previewFiles: ReconcilePreview[]` — populated when dialog opens
  - `selectedPaths: Set<string>` — tracks which files are checked
  - `isScanning: boolean` — true during preview fetch
  - `isApplying: boolean` — true during apply
  - `targetChangelistId: number | undefined` — selected target CL (undefined = default)
- When dialog opens (open transitions to true):
  1. Set isScanning = true
  2. Call reconcilePreview.mutateAsync()
  3. Populate previewFiles with results
  4. Select all files by default (all paths in selectedPaths)
  5. Set isScanning = false
- Dialog content:
  - Title: "Reconcile Workspace"
  - If scanning: show spinner with "Scanning workspace for offline changes..."
  - If no changes found: show "No offline changes detected" with close button
  - If changes found, group files by action type (add, edit, delete):
    - Section headers: "Files to Add (N)", "Files to Edit (N)", "Files to Delete (N)"
    - Each file row: checkbox + file path (use depot_path, show last 2-3 segments for readability) + action badge
    - Action badges: green for add, yellow for edit, red for delete
  - Toolbar row above file list:
    - "Select All" / "Select None" toggle buttons
    - Count: "N of M files selected"
  - Changelist picker dropdown below the file list (above footer):
    - Label: "Target Changelist"
    - Fetch pending changelists using existing useChangelists hook or invokeP4Changes
    - Options: "Default Changelist" (value: undefined/null) + all numbered pending changelists (value: cl id)
    - Default selection: "Default Changelist"
    - Use shadcn Select component, consistent with project patterns
  - Footer:
    - "Apply Reconcile" primary button (disabled if no files selected or isApplying)
    - "Cancel" secondary button
- On Apply:
  1. Set isApplying = true
  2. Call reconcileApply.mutateAsync with Array.from(selectedPaths) and the selected changelistId (undefined for default CL)
  3. On success: close dialog, toast success
  4. On error: toast error, keep dialog open
  5. Set isApplying = false
- Use shadcn AlertDialog (or Dialog) component, consistent with project patterns
- Checkbox: use shadcn Checkbox component or simple HTML checkbox with Tailwind styling
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`. ReconcilePreviewDialog renders scanning state, empty state, and file list with checkboxes.
  </verify>
  <done>useReconcile hook provides preview + apply mutations. ReconcilePreviewDialog shows grouped file list with checkboxes, select all/none, and apply button. Progress feedback during scan.</done>
</task>

<task type="auto">
  <name>Task 2: Add Reconcile button to toolbar and wire dialog</name>
  <files>src/components/SyncToolbar.tsx, src/components/MainLayout.tsx</files>
  <action>
**SyncToolbar.tsx (or MainLayout.tsx header area — wherever toolbar buttons live):**
- Add a "Reconcile" button next to the existing Sync button
- Icon: RefreshCcw or FolderSync from lucide-react (choose what fits best)
- Tooltip: "Reconcile Workspace — detect offline changes"
- On click: set reconcileDialogOpen = true
- Button state: disabled during active reconcile operation

**Wire ReconcilePreviewDialog:**
- Add `const [reconcileDialogOpen, setReconcileDialogOpen] = useState(false)` in the component containing the toolbar
- Render `<ReconcilePreviewDialog open={reconcileDialogOpen} onOpenChange={setReconcileDialogOpen} />`
- Place dialog render alongside other dialogs (SubmitDialog, FileHistoryDialog, etc.)

Follow existing toolbar button patterns (icon + optional text, same sizing/spacing as Sync button).
  </action>
  <verify>
TypeScript compiles. Reconcile button visible in toolbar. Clicking opens ReconcilePreviewDialog.
  </verify>
  <done>Reconcile button in toolbar opens ReconcilePreviewDialog. Button follows existing toolbar styling. Dialog wired with open/onOpenChange state.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no TypeScript errors
2. Reconcile button visible in toolbar next to Sync
3. Clicking Reconcile opens preview dialog with scanning state
4. Preview shows files grouped by action with checkboxes
5. Select all/none works
6. Apply sends only selected files to reconcile
7. Success invalidates relevant queries
</verification>

<success_criteria>
- Reconcile toolbar button triggers workspace scan
- Preview dialog shows offline edits/adds/deletes grouped by type
- User can select/deselect individual files with checkboxes
- Apply reconcile processes only selected files to chosen target changelist
- Changelist picker allows choosing target CL (default or numbered)
- Scanning progress and empty state handled
</success_criteria>

<output>
After completion, create `.planning/phases/06-shelve-reconcile/06-03-SUMMARY.md`
</output>
