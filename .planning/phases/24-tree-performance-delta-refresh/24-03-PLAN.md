---
phase: 24-tree-performance-delta-refresh
plan: 03
type: execute
wave: 2
depends_on: [24-01]
files_modified:
  - src-tauri/src/p4_commands.rs
  - src/lib/tauri.ts
autonomous: true

must_haves:
  truths:
    - "Backend supports querying only opened files (p4 opened as fstat-like output)"
    - "Frontend can invoke delta query separately from full fstat"
  artifacts:
    - path: "src-tauri/src/p4_commands.rs"
      provides: "p4_fstat_opened command for delta refresh"
      contains: "p4_fstat_opened"
    - path: "src/lib/tauri.ts"
      provides: "invokeP4FstatOpened function"
      exports: ["invokeP4FstatOpened"]
  key_links:
    - from: "src/lib/tauri.ts"
      to: "src-tauri/src/p4_commands.rs"
      via: "Tauri invoke"
      pattern: "invoke.*p4_fstat_opened"
---

<objective>
Add backend command for querying only opened/modified files for delta refresh.

Purpose: Delta refresh needs to query only opened files (fast, 10-50 files) instead of full workspace fstat (slow, 10,000+ files). This provides the backend support for the two-tier refresh strategy.
Output: p4_fstat_opened backend command, invokeP4FstatOpened frontend wrapper
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-tree-performance-delta-refresh/24-CONTEXT.md
@.planning/phases/24-tree-performance-delta-refresh/24-RESEARCH.md
@.planning/phases/24-tree-performance-delta-refresh/24-01-SUMMARY.md
@src-tauri/src/p4_commands.rs
@src/lib/tauri.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add p4_fstat_opened backend command</name>
  <files>
    src-tauri/src/p4_commands.rs
  </files>
  <action>
    Add new Tauri command that runs p4 fstat on opened files only.

    1. Add the command function (place near existing p4_fstat):
       ```rust
       /// Get fstat info for currently opened files only.
       /// Much faster than full workspace fstat for delta refresh.
       /// Uses p4 opened to get list, then fstat for full details.
       #[tauri::command]
       pub async fn p4_fstat_opened(
           server: Option<String>,
           user: Option<String>,
           client: Option<String>,
       ) -> Result<Vec<P4FileInfo>, String> {
           // First get list of opened files
           let opened_result = p4_opened(server.clone(), user.clone(), client.clone()).await?;

           if opened_result.is_empty() {
               return Ok(vec![]);
           }

           // Extract depot paths from opened files
           let depot_paths: Vec<String> = opened_result
               .iter()
               .map(|f| f.depot_path.clone())
               .collect();

           // Query fstat for just these files (includes head revision info)
           p4_fstat(depot_paths, None, server, user, client).await
       }
       ```

    2. Register the command in main.rs (or wherever commands are registered):
       - Find the invoke_handler macro and add p4_fstat_opened to the list

    Note: This approach:
    - Uses existing p4_opened to get the list of opened files
    - Then queries fstat on those specific paths to get full P4FileInfo with head revision
    - Returns same P4FileInfo type as regular fstat for consistency
  </action>
  <verify>
    cargo build (Rust compiles)
    grep "p4_fstat_opened" src-tauri/src/p4_commands.rs
    grep "p4_fstat_opened" src-tauri/src/main.rs (or lib.rs for command registration)
  </verify>
  <done>
    p4_fstat_opened command exists in p4_commands.rs
    Command returns P4FileInfo[] for currently opened files
    Command registered in Tauri invoke handler
  </done>
</task>

<task type="auto">
  <name>Task 2: Add frontend wrapper for p4_fstat_opened</name>
  <files>
    src/lib/tauri.ts
  </files>
  <action>
    Add TypeScript wrapper function for the new backend command.

    Add near the existing invokeP4Fstat function:

    ```typescript
    /**
     * Get fstat info for currently opened files only.
     * Use for fast delta refresh (queries ~10-50 files instead of entire workspace).
     * Returns same P4FileInfo type as regular fstat.
     */
    export async function invokeP4FstatOpened(): Promise<P4FileInfo[]> {
      return invoke<P4FileInfo[]>('p4_fstat_opened', getConnectionArgs());
    }
    ```

    This function:
    - Takes no path arguments (always queries all opened files)
    - Returns P4FileInfo[] matching regular fstat output
    - Auto-injects connection args like other commands
  </action>
  <verify>
    TypeScript compiles: npm run build
    grep "invokeP4FstatOpened" src/lib/tauri.ts
  </verify>
  <done>
    invokeP4FstatOpened function exported from tauri.ts
    Function signature matches expected return type (P4FileInfo[])
    Function uses getConnectionArgs() for consistency
  </done>
</task>

</tasks>

<verification>
cargo build (Rust backend compiles)
npm run build (TypeScript compiles)
grep "p4_fstat_opened" src-tauri/src/p4_commands.rs src-tauri/src/main.rs
grep "invokeP4FstatOpened" src/lib/tauri.ts
</verification>

<success_criteria>
- p4_fstat_opened backend command returns P4FileInfo for opened files
- invokeP4FstatOpened frontend wrapper available in tauri.ts
- Both Rust and TypeScript compile without errors
- Command registered in Tauri invoke handler
</success_criteria>

<output>
After completion, create `.planning/phases/24-tree-performance-delta-refresh/24-03-SUMMARY.md`
</output>
