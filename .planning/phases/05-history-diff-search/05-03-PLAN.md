---
phase: 05-history-diff-search
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/SearchBar.tsx
  - src/components/SearchResultsPanel.tsx
  - src/hooks/useSearch.ts
  - src/components/MainLayout.tsx
autonomous: true

must_haves:
  truths:
    - "User can click a search icon in the header to reveal a text input"
    - "User can type a query and see matching submitted changelists filtered by number, author, description, or file path"
    - "Search results show changelist number, date, user, and description"
    - "Search result changelists expand inline to show details"
    - "Search auto-detects input type (number vs user vs keyword)"
  artifacts:
    - path: "src/components/SearchBar.tsx"
      provides: "Header search icon that expands to text input"
    - path: "src/components/SearchResultsPanel.tsx"
      provides: "Panel displaying filtered changelist search results"
    - path: "src/hooks/useSearch.ts"
      provides: "TanStack Query hook with client-side filtering"
  key_links:
    - from: "src/hooks/useSearch.ts"
      to: "src/lib/tauri.ts"
      via: "invokeP4ChangesSubmitted"
      pattern: "invokeP4ChangesSubmitted"
    - from: "src/components/SearchBar.tsx"
      to: "src/hooks/useSearch.ts"
      via: "useSearch hook"
      pattern: "useSearch"
    - from: "src/components/MainLayout.tsx"
      to: "src/components/SearchBar.tsx"
      via: "SearchBar rendered in header"
      pattern: "SearchBar"
---

<objective>
Build the submitted changelist search experience: a GitKraken-style search icon in the header that expands to a text input, with a results panel showing filtered submitted changelists.

Purpose: Users can quickly find submitted changelists by number, author, or description text without leaving P4Now.
Output: SearchBar component, SearchResultsPanel, useSearch hook, integrated into MainLayout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-history-diff-search/05-RESEARCH.md
@.planning/phases/05-history-diff-search/05-01-SUMMARY.md

@src/components/MainLayout.tsx
@src/lib/tauri.ts
@src/hooks/useSettings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Search hook with client-side filtering</name>
  <files>src/hooks/useSearch.ts</files>
  <action>
1. Create `src/hooks/useSearch.ts`:
   - Export `useSearch(searchTerm: string)` hook
   - Use TanStack Query to fetch submitted changelists: `queryKey: ['p4', 'changes', 'submitted']`, calls `invokeP4ChangesSubmitted(500)`
   - Set `staleTime: 5 * 60 * 1000` (5 minutes) for caching — avoid refetching on every search
   - Use connection store for server/user/client args
   - Only enable query when search term is non-empty (don't fetch until user starts typing)
   - Actually, prefetch on mount so search feels instant — set `enabled: true` always
   - Use `useMemo` for client-side filtering:
     - If searchTerm is empty, return empty array (don't show all results)
     - If searchTerm is all digits (`/^\d+$/`), filter by changelist number (includes/startsWith)
     - If searchTerm matches a simple username pattern (`/^[a-zA-Z][\w.-]*$/`) AND matches a user in the results, filter by user. Otherwise fall back to description search.
     - Default: filter by description text (case-insensitive includes)
     - Also always check file path match if the term contains `/` or `\`
   - Return `{ results, isLoading, isSearching }` — `isSearching` true when term is non-empty
   - Expose `loadMore()` to fetch beyond initial 500 (increase max_changes and refetch)
  </action>
  <verify>
TypeScript compiles. Hook returns filtered results when given a search term.
  </verify>
  <done>useSearch hook fetches submitted changelists, caches for 5 min, and filters client-side by auto-detected type (number/user/description/path).</done>
</task>

<task type="auto">
  <name>Task 2: Search bar and results panel integrated into layout</name>
  <files>src/components/SearchBar.tsx, src/components/SearchResultsPanel.tsx, src/components/MainLayout.tsx</files>
  <action>
1. Create `src/components/SearchBar.tsx`:
   - GitKraken-style: starts as a `Search` icon button (lucide-react) in the header
   - On click, expands to show a text input with search icon prefix
   - Input has placeholder "Search changelists..." with auto-focus
   - Debounce input (300ms) before passing to useSearch
   - Show a small "X" button or Escape key to close/collapse the search bar
   - When collapsed, clear the search term
   - Props: `onSearchActive(active: boolean)` callback to notify parent when search results should show
   - Manage search term state internally, pass filtered results via `onResults` callback OR use a shared state/context

   Better approach: Use Zustand store or lift state to MainLayout:
   - SearchBar manages the input UI and debounced term
   - Pass `searchTerm` up to MainLayout which renders SearchResultsPanel conditionally
   - Or simpler: SearchBar uses useSearch internally and renders SearchResultsPanel as a dropdown/overlay

   Simplest approach: SearchBar component manages everything:
   - Contains the icon button, expandable input, and renders SearchResultsPanel as an absolute-positioned dropdown below the search bar
   - When search is active and has results, the panel shows below
   - When search is inactive (collapsed or empty term), panel is hidden

2. Create `src/components/SearchResultsPanel.tsx`:
   - Receives `results: P4ChangelistInfo[]` and `isLoading: boolean` as props
   - Renders a scrollable list of changelist cards
   - Each card shows: changelist number (bold), date, user, description (first line, truncated)
   - Cards are clickable to expand — expanded view shows full description and a "Show files" section
   - "Show files" fetches files for that changelist using `p4 describe -s {change}` (or a new command if needed — if no command exists, skip file listing for now and just show the full description)
   - Style: dark theme, max-h-96 overflow-auto, border, shadow, positioned absolute below search bar
   - Show "No results" message when term is non-empty but no matches
   - Show "Loading..." when fetching initial data
   - Show result count (e.g., "42 results")

3. Update `src/components/MainLayout.tsx`:
   - Add SearchBar component to the header area (top-right, near existing controls)
   - SearchBar is self-contained — just needs to be placed in the header
  </action>
  <verify>
Click search icon — input expands. Type a changelist number — matching results appear. Type a username — user's changelists appear. Type text — description matches appear. Press Escape or X — search collapses. Results show changelist number, date, user, description.
  </verify>
  <done>Search icon in header expands to text input. Typing filters submitted changelists by auto-detected type. Results panel shows changelist number, date, user, description. Expandable result cards show full details.</done>
</task>

</tasks>

<verification>
1. Search icon visible in header area
2. Click icon — text input appears with focus
3. Type changelist number — exact/partial match results appear
4. Type username — that user's changelists appear
5. Type description text — matching changelists appear
6. Results show: changelist number, date, user, description
7. Click result — expands to show full description
8. Press Escape — search collapses and clears
9. Search feels fast (cached data, no network on each keystroke)
</verification>

<success_criteria>
- Search bar in header with expand/collapse behavior
- Client-side filtering by number, user, description, and file path
- Results display changelist number, date, user, and description
- Expandable result cards for details
- 5-minute cache prevents repeated fetches
</success_criteria>

<output>
After completion, create `.planning/phases/05-history-diff-search/05-03-SUMMARY.md`
</output>
