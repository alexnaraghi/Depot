---
phase: 07-context-menus-keyboard-shortcuts
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/ui/command.tsx
  - src/components/CommandPalette.tsx
  - src/components/MainLayout.tsx
  - src/lib/shortcuts.ts
  - src/components/FileTree/FileContextMenu.tsx
  - src/components/FileTree/FileTree.tsx
autonomous: true

must_haves:
  truths:
    - "User can open command palette with Ctrl+Shift+P or Ctrl+Comma"
    - "Command palette shows all major operations with fuzzy search"
    - "Command palette displays shortcut hints as right-aligned muted text"
    - "Right-clicking a file in workspace view shows Checkout, Add, Diff, File History, and Get Revision"
    - "Keyboard shortcuts for context-sensitive operations (Revert, Diff, History) work when a file is selected"
  artifacts:
    - path: "src/components/CommandPalette.tsx"
      provides: "Command palette dialog with grouped commands and fuzzy search"
    - path: "src/components/ui/command.tsx"
      provides: "shadcn Command component wrapping cmdk"
  key_links:
    - from: "src/components/CommandPalette.tsx"
      to: "src/lib/shortcuts.ts"
      via: "imports SHORTCUTS for command shortcut display"
      pattern: "SHORTCUTS\\."
    - from: "src/components/MainLayout.tsx"
      to: "src/components/CommandPalette.tsx"
      via: "renders CommandPalette and controls open state via shortcut"
      pattern: "CommandPalette"
---

<objective>
Create the command palette with fuzzy search for all operations, add workspace file context menu additions (Add, Get Revision), and wire context-sensitive keyboard shortcuts that activate based on file selection.

Purpose: Completes the command palette (KEY-03), workspace context menu (CTX-03), and context-sensitive shortcuts (KEY-01) requirements.
Output: Working command palette, complete workspace file context menu, context-sensitive keyboard shortcuts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-context-menus-keyboard-shortcuts/07-CONTEXT.md
@.planning/phases/07-context-menus-keyboard-shortcuts/07-RESEARCH.md
@.planning/phases/07-context-menus-keyboard-shortcuts/07-01-SUMMARY.md
@src/lib/shortcuts.ts
@src/components/MainLayout.tsx
@src/components/CommandPalette.tsx (will be created)
@src/components/FileTree/FileContextMenu.tsx
@src/components/FileTree/FileTree.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build command palette with grouped commands and fuzzy search</name>
  <files>
    src/components/ui/command.tsx (already added by shadcn in plan 01)
    src/components/CommandPalette.tsx
    src/components/MainLayout.tsx
    src/lib/shortcuts.ts
  </files>
  <action>
1. Create `src/components/CommandPalette.tsx`:
   - Use shadcn `CommandDialog` (wraps cmdk) for the palette UI
   - Props: `open: boolean`, `onOpenChange: (open: boolean) => void`
   - Command groups (use `CommandGroup` with heading):
     - **Workspace**: Refresh, Sync Workspace, Reconcile
     - **Changelist**: New Changelist, Submit (if changelist selected)
     - **File** (context-sensitive, show only if relevant): Diff, Revert, File History, Checkout
     - **Navigation**: Open Settings
   - Each command item (`CommandItem`):
     - Icon on left (same icons used in menus/toolbar)
     - Command name
     - Right-aligned shortcut hint: `<CommandShortcut>{SHORTCUTS.X.label}</CommandShortcut>` (only for commands with shortcuts)
   - On select: execute the command action and close the palette
   - Actions use the same custom event dispatch pattern from Plan 01 (e.g., `window.dispatchEvent(new CustomEvent('p4now:sync'))`)
   - For file-specific commands: dispatch events like 'p4now:diff-selected', 'p4now:revert-selected', 'p4now:history-selected' that the components with selected file context will handle
   - For settings: dispatch 'p4now:open-settings'
   - Search: cmdk provides built-in fuzzy filtering via CommandInput — just set `placeholder="Type a command..."`

2. In `MainLayout.tsx`:
   - Add state: `const [commandPaletteOpen, setCommandPaletteOpen] = useState(false)`
   - Wire the existing COMMAND_PALETTE hotkey (from Plan 01) to set `commandPaletteOpen = true`
   - Also bind 'ctrl+comma' as alias for command palette
   - Render `<CommandPalette open={commandPaletteOpen} onOpenChange={setCommandPaletteOpen} />` at the end of the component
   - Listen for 'p4now:open-settings' custom event to open settings dialog

3. In `src/lib/shortcuts.ts`:
   - If not already done, ensure COMMAND_PALETTE shortcut has both 'ctrl+shift+p' and 'ctrl+comma' defined (can use array or separate entries — react-hotkeys-hook supports comma-separated: 'ctrl+shift+p, ctrl+comma')
  </action>
  <verify>
    - `npm run build` compiles without errors
    - Press Ctrl+Shift+P → command palette opens with grouped commands
    - Type to filter commands (fuzzy search)
    - Select a command → it executes and palette closes
    - Shortcut hints visible in palette items
  </verify>
  <done>
    - Command palette opens with Ctrl+Shift+P or Ctrl+Comma
    - Commands grouped by category (Workspace, Changelist, File, Navigation)
    - Fuzzy search filters commands as user types
    - Shortcut hints displayed for commands that have keyboard shortcuts
    - Selecting a command executes it and closes the palette
  </done>
</task>

<task type="auto">
  <name>Task 2: Workspace file menu additions and context-sensitive shortcuts</name>
  <files>
    src/components/FileTree/FileContextMenu.tsx
    src/components/FileTree/FileTree.tsx
    src/components/shared/FileContextMenuItems.tsx
    src/components/MainLayout.tsx
  </files>
  <action>
1. In `FileContextMenuItems.tsx` (or FileContextMenu.tsx for workspace-specific items):
   - Add "Add to Depot" menu item: visible when file is NOT tracked (status indicates not in depot — check how FileStatus handles untracked files; if no untracked status exists, skip this or show for files with status that indicates they could be added)
   - Add "Get Revision" menu item: visible for files that are synced or out of date, triggers `p4 sync` for just that file to get latest revision
     - Icon: Download from lucide-react
     - On click: invoke sync for just that file's depot path
   - These items should appear in workspace file context menu. Since FileContextMenu delegates to FileContextMenuItems, check if these operations make sense for both workspace and changelist contexts. If "Add" and "Get Revision" are workspace-only, add them directly in FileContextMenu.tsx rather than the shared component.
   - For workspace-only items in `FileContextMenu.tsx`: Add items after the FileContextMenuItems, with a separator. Items:
     - **Add to Depot** (if file is not tracked — check status; may need `p4 add` command which should exist or be similar to reconcile add)
     - **Get Revision** (for synced/out-of-date files — calls sync for single file)
   - NOTE: If `p4 add` is not already exposed as a Tauri command, use reconcile or skip. Check existing Rust backend. If it exists, use it. If not, this can be deferred — the requirement says "Add" should be in the menu, so add the menu item but show a toast "Not yet implemented" if the backend command doesn't exist. Better to have the menu item than nothing.

2. Wire context-sensitive keyboard shortcuts in `MainLayout.tsx` or at the component level:
   - The approach: use custom events for context-sensitive shortcuts
   - In MainLayout, add hotkeys for:
     - `SHORTCUTS.DIFF.keys` → dispatch 'p4now:diff-selected'
     - `SHORTCUTS.HISTORY.keys` → dispatch 'p4now:history-selected'
     - `SHORTCUTS.REVERT.keys` → dispatch 'p4now:revert-selected'
     - `SHORTCUTS.SUBMIT.keys` → dispatch 'p4now:submit'
   - These are global shortcuts that fire custom events; the relevant component (FileTree, ChangelistPanel) listens and acts if it has a selected file/changelist
   - In `FileTree.tsx` (or wherever file selection state lives): listen for 'p4now:diff-selected', 'p4now:history-selected', 'p4now:revert-selected' events and trigger the action on the currently selected file (if any)
   - In `ChangelistPanel.tsx`: listen for 'p4now:submit' event to open submit dialog for selected changelist
   - If no file/changelist is selected when the shortcut fires, do nothing (no error, just ignore)

3. Ensure all shortcuts have `enableOnFormTags: false` and `preventDefault: true` where needed to avoid conflicts.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - Right-click a file in workspace tree → shows Checkout, Revert, File History, Diff, Copy Path, Open in Explorer, Get Revision
    - Select a file and press Ctrl+D → diff opens (if file is checked out)
    - Select a file and press Ctrl+H → file history dialog opens
    - Press Ctrl+Shift+Enter → submit dialog opens (if changelist has files)
    - Shortcuts do nothing when no file is selected
  </verify>
  <done>
    - Workspace file context menu includes all required items (Checkout, Add, Diff, File History, Get Revision)
    - Context-sensitive shortcuts (Ctrl+D for Diff, Ctrl+H for History, Ctrl+Shift+R for Revert, Ctrl+Shift+Enter for Submit) work when selection exists
    - Shortcuts are no-ops when no selection exists
    - Build passes
  </done>
</task>

</tasks>

<verification>
1. Press Ctrl+Shift+P → command palette opens with fuzzy search
2. Press Ctrl+Comma → same palette opens
3. Type "sync" → filters to show Sync command, select it → sync starts
4. Right-click file in workspace → shows all required items (Checkout, Add, Diff, History, Get Revision)
5. Select a file, press Ctrl+D → diff opens
6. Select a file, press Ctrl+H → history opens
7. Press Ctrl+Shift+Enter → submit dialog opens
8. No file selected, press Ctrl+D → nothing happens (no error)
9. `npm run build` succeeds
</verification>

<success_criteria>
- Command palette opens with Ctrl+Shift+P or Ctrl+Comma, shows all operations grouped, supports fuzzy search
- Workspace file context menu shows Checkout, Add, Diff, File History, Get Revision
- Context-sensitive shortcuts activate only when relevant selection exists
- All menus show shortcut hints
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-context-menus-keyboard-shortcuts/07-02-SUMMARY.md`
</output>
