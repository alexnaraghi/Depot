---
phase: 03-settings-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/SettingsDialog.tsx
  - src/components/ConnectionStatus.tsx
  - src/components/MainLayout.tsx
  - src/components/SyncToolbar.tsx
  - src/App.tsx
  - src/hooks/useSettings.ts
autonomous: false

must_haves:
  truths:
    - "User can open a settings dialog from the header"
    - "User can enter server, user, and workspace in the settings form"
    - "User can browse and select from available workspaces"
    - "Settings persist across app restarts without re-entry"
    - "Connection status badge is always visible in the header"
    - "Current workspace name and stream are displayed in the header"
  artifacts:
    - path: "src/components/SettingsDialog.tsx"
      provides: "Settings dialog with form for server/user/workspace and workspace browser"
      contains: "SettingsDialog"
    - path: "src/components/ConnectionStatus.tsx"
      provides: "Connection status badge component"
      contains: "ConnectionStatus"
    - path: "src/hooks/useSettings.ts"
      provides: "Hook that loads settings on mount, tests connection, and syncs to connection store"
      exports: ["useSettings"]
  key_links:
    - from: "src/components/SettingsDialog.tsx"
      to: "src/lib/settings.ts"
      via: "loadSettings/saveSettings calls"
      pattern: "saveSettings|loadSettings"
    - from: "src/hooks/useSettings.ts"
      to: "src/stores/connectionStore.ts"
      via: "setConnected/setError on p4_info result"
      pattern: "useConnectionStore|setConnected|setError"
    - from: "src/components/MainLayout.tsx"
      to: "src/components/ConnectionStatus.tsx"
      via: "ConnectionStatus rendered in header"
      pattern: "<ConnectionStatus"
---

<objective>
Build the settings dialog UI, connection status indicator, and header workspace display.

Purpose: This is the user-facing layer of Phase 03. Users can configure their P4 connection, browse workspaces, and always see their connection status and current workspace. This completes all 6 requirements (CONN-01, CONN-04, CONN-05, CONN-06, CONN-07, CONN-08).

Output: Settings dialog with form validation and workspace browser, connection status badge in header, workspace/stream display in header, auto-load settings on app startup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-settings-infrastructure/03-RESEARCH.md
@.planning/phases/03-settings-infrastructure/03-01-SUMMARY.md

@src/components/MainLayout.tsx
@src/components/StatusBar.tsx
@src/components/SyncToolbar.tsx
@src/components/ui/button.tsx
@src/App.tsx
@src/lib/settings.ts
@src/lib/tauri.ts
@src/types/settings.ts
@src/stores/connectionStore.ts
@src/hooks/useP4Command.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings dialog, connection status, and useSettings hook</name>
  <files>
    src/components/SettingsDialog.tsx
    src/components/ConnectionStatus.tsx
    src/hooks/useSettings.ts
  </files>
  <action>
    **First, add required shadcn/ui components** (if not already present):
    ```bash
    npx shadcn@latest add dialog form input label select badge
    ```

    **1. Create `src/hooks/useSettings.ts`:**
    - On mount, call `loadSettings()` from `src/lib/settings.ts`
    - If settings have non-empty p4port/p4user/p4client, call `p4_info` (via invoke with connection args) to test the connection
    - On success: call `useConnectionStore.setConnected()` with workspace, stream, server, user
    - On error: call `useConnectionStore.setError()` with error message
    - If settings are empty (first launch): leave status as 'disconnected'
    - Export `useSettings` hook that returns `{ settings, isLoading, refreshConnection }`
    - `refreshConnection` re-runs the p4_info check (useful after saving new settings)

    **2. Create `src/components/ConnectionStatus.tsx`:**
    - Reads from `useConnectionStore()`
    - Renders a shadcn Badge with variant based on status:
      - `connected` -> green badge (variant="default" with green className override or use variant="outline" with green text)
      - `disconnected` -> gray/muted badge
      - `error` -> red/destructive badge
      - `connecting` -> blue badge with pulse animation
    - Badge text: capitalize status ("Connected", "Disconnected", "Error", "Connecting...")
    - On error, show tooltip or title attr with errorMessage
    - Keep it small and unobtrusive (fits in header)

    **3. Create `src/components/SettingsDialog.tsx`:**
    - Use shadcn Dialog + Form components
    - Form uses react-hook-form with zodResolver(settingsSchema)
    - Three fields: Server (p4port), User (p4user), Workspace (p4client)
    - **Workspace field** has a "Browse" button next to it:
      - When clicked, calls `invokeListWorkspaces(server, user)` using current form values
      - Shows results in a shadcn Select dropdown (or a simple list)
      - Selecting a workspace fills the p4client field
      - If server or user is empty, show toast "Enter server and user first"
      - If browse fails, show toast with error message
    - **Submit flow:**
      1. Validate form with Zod
      2. Call `invokeTestConnection(server, user, client)` to verify connection
      3. If test passes: call `saveSettings(data)`, update connection store via refreshConnection, close dialog, show success toast
      4. If test fails: show error toast with message, keep dialog open
    - **Default values:** Load from `loadSettings()` on dialog open (use react-hook-form `defaultValues` async function or `reset()` on open)
    - Form validation mode: `onSubmit` (not onChange — avoid nagging errors per research)
    - Props: `open: boolean, onOpenChange: (open: boolean) => void`
  </action>
  <verify>
    - `npm run build` succeeds (TypeScript compilation)
    - All three files exist with correct exports
    - SettingsDialog uses react-hook-form with Zod resolver
    - ConnectionStatus reads from useConnectionStore
  </verify>
  <done>
    Settings dialog with form validation, workspace browsing, and connection testing is complete. Connection status badge renders based on store state. useSettings hook loads settings on mount and tests connection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire settings into MainLayout header and app startup</name>
  <files>
    src/components/MainLayout.tsx
    src/App.tsx
  </files>
  <action>
    **1. Update `src/components/MainLayout.tsx` header:**
    - Import ConnectionStatus, SettingsDialog, useConnectionStore, and a settings icon (Settings from lucide-react)
    - Add state for settings dialog: `const [settingsOpen, setSettingsOpen] = useState(false)`
    - Update header layout to show:
      - Left side: "P4Now" title (keep existing)
      - Center/left: workspace name and stream/repo from connectionStore
        - `{workspace || 'No workspace'}` in font-medium
        - `{stream}` in smaller muted text (only if stream exists)
      - Right side: ConnectionStatus badge + Settings gear button
    - Settings gear button opens the SettingsDialog
    - Render `<SettingsDialog open={settingsOpen} onOpenChange={setSettingsOpen} />` inside the component
    - Keep existing SyncToolbar below header

    **2. Update `src/App.tsx`:**
    - Import and call `useSettings()` at the top level (inside App component or a wrapper)
    - This triggers settings load + connection test on app startup
    - While loading, the connection status will show 'connecting', then resolve to 'connected' or 'error'
    - If settings are empty (first launch), status stays 'disconnected' — user sees gear icon to configure

    **Layout of updated header (single row):**
    ```
    [P4Now]  [workspace-name  stream/path]  ............  [● Connected] [⚙]
    ```
    Keep the dark theme consistent with existing bg-slate-900 styling.
  </action>
  <verify>
    - `npm run build` succeeds
    - MainLayout.tsx imports and renders ConnectionStatus and SettingsDialog
    - App.tsx calls useSettings() on mount
    - Header shows workspace name, stream, connection badge, and settings button
  </verify>
  <done>
    Header displays workspace name, stream, connection status badge, and settings gear icon. Settings dialog is accessible from the header. App loads settings and tests connection on startup. All 6 CONN requirements are satisfied.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete settings infrastructure: settings dialog with form validation, workspace browsing, connection testing, persistent storage, connection status badge in header, and workspace/stream display.</what-built>
  <how-to-verify>
    1. Run `npm run tauri dev` to start the app
    2. Verify the header shows "No workspace" and a "Disconnected" badge (if no settings saved)
    3. Click the gear/settings icon in the header — settings dialog should open
    4. Enter your P4 server address, username, and click "Browse" for workspaces
    5. Select a workspace from the browse results
    6. Click Save — dialog should close, header should update with workspace name and "Connected" badge
    7. Close and reopen the app — settings should persist (no need to re-enter)
    8. If stream workspace: verify stream name appears in header
    9. Enter invalid server address, try to save — should show connection error, not save
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Settings dialog opens from header gear icon
- Form validates required fields (server, user, workspace)
- Browse button lists workspaces from server
- Save tests connection before persisting
- Settings persist across app restarts (tauri-plugin-store)
- Connection status badge always visible in header (connected/disconnected/error)
- Workspace name displayed in header
- Stream/repo name displayed in header (when applicable)
- Invalid settings show error, don't save
- Empty settings on first launch show "Disconnected" gracefully
</verification>

<success_criteria>
All 6 CONN requirements met:
- CONN-01: Settings dialog with server/user/workspace fields
- CONN-04: Workspace browsing via Browse button
- CONN-05: Settings persist via tauri-plugin-store
- CONN-06: Connection status badge always visible
- CONN-07: Stream/repository name in header
- CONN-08: Workspace name in header
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-infrastructure/03-02-SUMMARY.md`
</output>
