---
phase: 20-bug-fixes-and-ui-polish
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/DepotBrowser/DepotNode.tsx
  - src/components/ChangelistPanel/ChangelistNode.tsx
  - src/components/DetailPane/ChangelistDetailView.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a file in depot browser updates toolbar icons (checkout, revert, diff become enabled)"
    - "Clicking a file in changelist panel updates toolbar icons"
    - "CL details panel shows correct file count for pending changelists"
  artifacts:
    - path: "src/components/DepotBrowser/DepotNode.tsx"
      provides: "File click updates fileTreeStore.selectedFile"
    - path: "src/components/ChangelistPanel/ChangelistNode.tsx"
      provides: "File click updates fileTreeStore.selectedFile"
    - path: "src/components/DetailPane/ChangelistDetailView.tsx"
      provides: "Correct file count display using changelist.fileCount"
  key_links:
    - from: "src/components/DepotBrowser/DepotNode.tsx"
      to: "src/stores/fileTreeStore.ts"
      via: "useFileTreeStore.getState().setSelectedFile()"
      pattern: "setSelectedFile"
    - from: "src/components/ChangelistPanel/ChangelistNode.tsx"
      to: "src/stores/fileTreeStore.ts"
      via: "useFileTreeStore.getState().setSelectedFile()"
      pattern: "setSelectedFile"
---

<objective>
Fix file selection state sharing so toolbar icons update when files are clicked in any panel, and fix CL detail file count display.

Purpose: The toolbar's context-sensitive buttons (checkout, revert, diff) only activate when a file is selected in the workspace file tree. Clicking files in depot browser or changelist panel doesn't update the shared selection state.
Output: All file click handlers update the shared fileTreeStore, toolbar reacts to selections from any panel.
</objective>

<execution_context>
@C:\Users\a\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\a\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/DepotBrowser/DepotNode.tsx
@src/components/ChangelistPanel/ChangelistNode.tsx
@src/stores/fileTreeStore.ts
@src/types/p4.ts
@src/components/DetailPane/ChangelistDetailView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update file click handlers to set shared selection state</name>
  <files>src/components/DepotBrowser/DepotNode.tsx, src/components/ChangelistPanel/ChangelistNode.tsx</files>
  <action>
**In DepotNode.tsx:**

1. Add import for `useFileTreeStore`:
```tsx
import { useFileTreeStore } from '@/stores/fileTreeStore';
```

2. In the `handleClick` function (around line 22-29), when a non-folder file is clicked, also update the shared file selection store:

```tsx
function handleClick() {
  if (isFolder) {
    node.toggle();
  } else {
    // Update shared selection state for toolbar
    useFileTreeStore.getState().setSelectedFile({
      depotPath: node.data.id,
      localPath: '',
      status: FileStatus.Synced,
      revision: 0,
      headRevision: 0,
      fileType: '',
      isDirectory: false,
    });
    // Show in detail pane
    useDetailPaneStore.getState().selectFile(node.data.id, '');
  }
}
```

3. Add the FileStatus import:
```tsx
import { FileStatus } from '@/types/p4';
```

Note: Depot files don't have localPath (they're depot-only), so we use empty string. The toolbar buttons (checkout, diff) will be enabled but may have limited functionality for depot-only paths. This is acceptable â€” the toolbar state correctly reflects "a file is selected."

**In ChangelistNode.tsx:**

1. Add import for `useFileTreeStore`:
```tsx
import { useFileTreeStore } from '@/stores/fileTreeStore';
```

2. In the file row click handler (around line 199-207), add the shared selection update. The file data is already available as a `P4File`:

```tsx
onClick={() => {
  if (dimmed) return;
  // Update shared selection state for toolbar
  useFileTreeStore.getState().setSelectedFile(file);
  // Update detail pane to show file
  useDetailPaneStore.getState().selectFile(file.depotPath, file.localPath, fromClId);
  // Clear filter after navigating to file
  const isActive = useSearchFilterStore.getState().isActive;
  if (isActive) {
    useSearchFilterStore.getState().clearFilter();
  }
}}
```

The only addition is the `useFileTreeStore.getState().setSelectedFile(file)` call before the existing `selectFile` call.
  </action>
  <verify>
Run `npx tsc --noEmit`. Test:
1. Click a file in depot browser -> toolbar checkout/revert/diff buttons should become enabled
2. Click a file in changelist panel -> toolbar buttons should become enabled
3. Click a file in workspace file tree -> still works as before
  </verify>
  <done>File clicks in depot browser and changelist panel update shared selection state. Toolbar icons react to selections from any panel.</done>
</task>

<task type="auto">
  <name>Task 2: Fix CL details file count display</name>
  <files>src/components/DetailPane/ChangelistDetailView.tsx</files>
  <action>
The CL details view shows `FILES ({changelist.files.length})` at line 165. This displays correctly when files are loaded, but the `hasFiles` check at line 45 also uses `changelist.files.length > 0`.

Looking at the data flow in `useChangelists.ts`, both `files` array and `fileCount` are populated in sync (lines 127-139). However, `fileCount` is the canonical count used in the changelist panel tree (ChangelistNode line 132: `{changelist.fileCount}`).

For consistency and correctness, update the detail view to use `fileCount` as the source of truth:

1. Update `hasFiles` (line 45):
```tsx
const hasFiles = changelist.fileCount > 0;
```

2. Update the FILES header count (line 165):
```tsx
FILES ({changelist.fileCount})
```

This ensures consistency between the CL panel badge and the detail view count, and is more resilient to timing issues where `files` array might not be populated yet but `fileCount` is set.

Additionally, review the condition for showing the pending files section. Currently it shows when `hasFiles` is true (line 162). The files array should always match `fileCount` for pending CLs, but using `fileCount` makes the heading more reliable.
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify:
1. Select a pending CL with files -> detail view shows correct file count matching the badge count in CL panel
2. Select a pending CL with 0 files -> no FILES section shown
3. Select a submitted CL -> shows separate submitted file section with its own count (unchanged)
  </verify>
  <done>CL details panel shows correct file count using fileCount as the source of truth, consistent with the changelist panel badge.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Clicking files in any panel enables toolbar buttons
3. CL detail view file count matches CL panel badge count
</verification>

<success_criteria>
- File selection in depot browser updates toolbar icons
- File selection in changelist panel updates toolbar icons
- CL details panel shows correct file count
</success_criteria>

<output>
After completion, create `.planning/phases/20-bug-fixes-and-ui-polish/20-05-SUMMARY.md`
</output>
