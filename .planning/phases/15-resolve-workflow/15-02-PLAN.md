---
phase: 15-resolve-workflow
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/hooks/useResolve.ts
  - src/types/p4.ts
  - src/components/DetailPane/FileDetailView.tsx
  - src/components/dialogs/ResolveBlockingOverlay.tsx
  - src/components/dialogs/ResolveConfirmDialog.tsx
  - src/components/shared/FileContextMenuItems.tsx
  - src/components/ChangelistPanel/ChangelistNode.tsx
autonomous: false

must_haves:
  truths:
    - "User sees conflict warning icon on files needing resolution"
    - "User sees yellow conflict banner in file detail view with resolve action buttons"
    - "User can launch merge tool from context menu or conflict banner"
    - "App shows blocking overlay while merge tool is open"
    - "User sees confirmation dialog after merge tool exits before accepting"
    - "Quick resolve (Accept Theirs/Yours) shows confirmation before executing"
    - "File status updates in UI after resolution completes"
    - "Submit is blocked if changelist has unresolved conflicts"
  artifacts:
    - path: "src/hooks/useResolve.ts"
      provides: "Resolve operations hook with query management"
      exports: ["useResolve", "useUnresolvedFiles"]
    - path: "src/components/dialogs/ResolveBlockingOverlay.tsx"
      provides: "Blocking overlay during merge tool execution"
      exports: ["ResolveBlockingOverlay"]
    - path: "src/components/dialogs/ResolveConfirmDialog.tsx"
      provides: "Confirmation dialogs for resolve actions"
      exports: ["ResolveConfirmDialog"]
  key_links:
    - from: "src/hooks/useResolve.ts"
      to: "p4_fstat_unresolved Tauri command"
      via: "invoke('p4_fstat_unresolved')"
      pattern: "invoke.*p4_fstat_unresolved"
    - from: "src/hooks/useResolve.ts"
      to: "p4_resolve_accept Tauri command"
      via: "invoke('p4_resolve_accept')"
      pattern: "invoke.*p4_resolve_accept"
    - from: "src/components/DetailPane/FileDetailView.tsx"
      to: "src/hooks/useResolve.ts"
      via: "useResolve hook for resolve actions"
      pattern: "useResolve|useUnresolvedFiles"
    - from: "resolve operations"
      to: "TanStack Query cache"
      via: "queryClient.invalidateQueries after resolve"
      pattern: "invalidateQueries"
---

<objective>
Build the complete frontend resolve workflow: conflict detection display, merge tool launching with blocking overlay, quick resolve with confirmations, context menu integration, and submit blocking for unresolved files.

Purpose: Makes conflicts visible and resolvable from the UI. This is the user-facing half of the resolve workflow — without it, conflicts are invisible and unresolvable in P4Now.
Output: Working resolve flow from conflict indicator through resolution to status update.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-resolve-workflow/15-RESEARCH.md
@.planning/phases/15-resolve-workflow/15-01-SUMMARY.md

@src/types/p4.ts — P4File, FileStatus types
@src/hooks/useFileOperations.ts — Pattern for file operation hooks
@src/hooks/useDiff.ts — Pattern for tool launching hooks
@src/components/DetailPane/FileDetailView.tsx — File detail view to add conflict banner
@src/components/shared/FileContextMenuItems.tsx — Shared context menu items to add resolve option
@src/components/dialogs/ShelveConfirmDialog.tsx — Pattern for confirmation dialogs
@src/components/ChangelistPanel/ChangelistNode.tsx — Changelist display (add submit blocking)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useResolve hook, types, and dialog components</name>
  <files>src/hooks/useResolve.ts, src/types/p4.ts, src/components/dialogs/ResolveBlockingOverlay.tsx, src/components/dialogs/ResolveConfirmDialog.tsx</files>
  <action>
1. **Add P4UnresolvedFile type to src/types/p4.ts:**
   ```typescript
   export interface P4UnresolvedFile {
     depotPath: string;
     localPath: string;
     headRev: number;
     haveRev: number;
     resolveAction: string;
   }
   ```
   No changes to FileStatus enum — FileStatus.Conflict already exists.

2. **Create src/hooks/useResolve.ts:**
   - `useUnresolvedFiles()` — TanStack Query hook:
     - queryKey: `['p4', 'unresolved', p4port, p4user, p4client]`
     - queryFn: `invoke<P4UnresolvedFile[]>('p4_fstat_unresolved', { server, user, client })`
     - enabled: only when connected (check useConnectionStore)
     - NO automatic refetchInterval (detect conflicts on manual refresh/sync/unshelve only)
     - Export a helper `isFileUnresolved(depotPath: string)` that checks the query data
   - `useResolve()` — Returns resolve operation functions:
     - `resolveAccept(depotPath: string, mode: 'theirs' | 'yours' | 'merge')` — invokes `p4_resolve_accept`, invalidates queries on success
     - `launchMergeTool(depotPath: string, localPath: string)` — invokes `launch_merge_tool`, returns exit code
     - After ANY resolve operation, invalidate: `['p4', 'opened']`, `['p4', 'changes']`, `['p4', 'unresolved']`, `['fileTree']`
   - Get connection params from `useConnectionStore` (follow useFileOperations pattern)
   - Use `useQueryClient` for invalidation

3. **Create src/components/dialogs/ResolveBlockingOverlay.tsx:**
   - Full-screen modal overlay using shadcn Dialog
   - Props: `isOpen: boolean`, `filePath: string`
   - Shows: spinning Loader2 icon, "Waiting for merge tool..." message, file path, "Complete your merge in the external tool to continue" subtitle
   - Prevent close: `onInteractOutside={(e) => e.preventDefault()}`, `onEscapeKeyDown={(e) => e.preventDefault()}`
   - Dark semi-transparent background (bg-slate-900/95)

4. **Create src/components/dialogs/ResolveConfirmDialog.tsx:**
   - Reusable confirmation dialog for resolve actions
   - Props: `open: boolean`, `title: string`, `description: string`, `onConfirm: () => void`, `onCancel: () => void`, `confirmLabel?: string`
   - Use shadcn Dialog pattern (reference ShelveConfirmDialog for styling)
   - Destructive styling for Accept Theirs (warns about discarding local changes)
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compilation. Check that useResolve.ts exports both hooks and ResolveBlockingOverlay/ResolveConfirmDialog compile.</verify>
  <done>useResolve hook provides resolve operations with query invalidation, P4UnresolvedFile type exists, blocking overlay and confirm dialog components created.</done>
</task>

<task type="auto">
  <name>Task 2: Wire conflict UI into FileDetailView, context menus, and submit blocking</name>
  <files>src/components/DetailPane/FileDetailView.tsx, src/components/shared/FileContextMenuItems.tsx, src/components/ChangelistPanel/ChangelistNode.tsx</files>
  <action>
1. **Add conflict banner to FileDetailView.tsx:**
   - Import `useUnresolvedFiles`, `useResolve` from hooks/useResolve
   - Import `ResolveBlockingOverlay`, `ResolveConfirmDialog` from dialogs
   - Import `AlertTriangle` from lucide-react
   - Check if current file is unresolved using `useUnresolvedFiles().isFileUnresolved(depotPath)` OR `fileInfo?.status === FileStatus.Conflict`
   - When conflicted, render yellow/orange banner at top of detail view (BEFORE the action buttons section):
     - Left: AlertTriangle icon + "This file has unresolved conflicts" text
     - Below text: three buttons in a flex row:
       - "Launch Merge Tool" — sets isLaunching state, calls launchMergeTool, on exit code 0 shows confirm dialog ("Merge tool completed. Accept merged result?"), on confirm calls resolveAccept(depotPath, 'merge'), on non-zero shows error toast
       - "Accept Theirs" — shows ResolveConfirmDialog with warning "This will discard your local changes and use the depot version.", on confirm calls resolveAccept(depotPath, 'theirs')
       - "Accept Yours" — shows ResolveConfirmDialog with warning "This will keep your local changes and discard the depot changes.", on confirm calls resolveAccept(depotPath, 'yours')
   - Banner styling: `bg-yellow-900/30 border-l-4 border-yellow-500 p-4 mb-4 rounded-r`
   - Render `<ResolveBlockingOverlay isOpen={isLaunching} filePath={depotPath} />` at component bottom
   - Use local state: `isLaunching`, `confirmAction` (for which confirm dialog to show)

2. **Add "Resolve" context menu item to FileContextMenuItems.tsx:**
   - Import `useUnresolvedFiles` from hooks/useResolve
   - Add check: `const isUnresolved = useUnresolvedFiles().isFileUnresolved(file.depotPath)` (or check `file.status === FileStatus.Conflict`)
   - When file is unresolved, show a "Resolve..." menu item (with AlertTriangle icon) that navigates to the file detail view where the conflict banner is shown
   - The onResolve callback should use the existing `onShowHistory` pattern — add an optional `onResolve?: (depotPath: string, localPath: string) => void` prop
   - Position the resolve item at the TOP of the menu (before checkout/revert) with a separator after it
   - Style the item with yellow/warning text color: `text-yellow-400`

3. **Block submit for changelists with unresolved files:**
   - In ChangelistNode.tsx (or wherever the submit action is triggered), check if any files in the changelist are unresolved before allowing submit
   - Import `useUnresolvedFiles` and check if any changelist file depot paths appear in the unresolved list
   - If unresolved files exist, show a toast error: "Cannot submit: {N} file(s) have unresolved conflicts" instead of proceeding with submit
   - This is a soft block (toast + prevent), not a disabled button

4. **Add conflict icon overlay to file nodes:**
   - In FileNode.tsx (or wherever file icons are rendered), check if file is unresolved
   - If unresolved, add a small AlertTriangle overlay icon (yellow, positioned at bottom-right of existing icon)
   - Use absolute positioning within a relative container: `<AlertTriangle className="w-3 h-3 text-yellow-500 absolute -bottom-1 -right-1" />`
  </action>
  <verify>Run `npx tsc --noEmit`. Visually inspect the app: conflicted files should show warning icon, clicking a conflicted file should show the yellow conflict banner in detail pane, context menu should show "Resolve..." item for conflicted files.</verify>
  <done>Conflict banner with resolve actions renders in FileDetailView, context menu shows resolve option for conflicted files, submit is blocked when changelist has unresolved files, file nodes show conflict icon overlay.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete resolve workflow: conflict detection, merge tool launching with blocking overlay, quick resolve with confirmations, context menu integration, submit blocking</what-built>
  <how-to-verify>
    1. Run `npm run tauri dev` to start the app
    2. Create a conflict scenario: sync a file, edit it, have someone else submit a change to the same file, then sync again
    3. Verify: conflicted file shows yellow warning icon overlay in file tree
    4. Verify: clicking the conflicted file shows yellow conflict banner at top of detail pane with three buttons
    5. Verify: clicking "Launch Merge Tool" shows blocking overlay, launches P4MERGE (or shows error if not set)
    6. Verify: after merge tool exits, confirmation dialog appears asking to accept result
    7. Verify: clicking "Accept Theirs" shows confirmation warning, then resolves the file
    8. Verify: after resolution, file status updates (warning icon disappears, banner disappears)
    9. Verify: right-clicking conflicted file shows "Resolve..." item at top of context menu
    10. Verify: attempting to submit a changelist with unresolved files shows error toast
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Conflict banner renders for files with FileStatus.Conflict or in unresolved query results
3. Merge tool launch shows blocking overlay and waits for exit
4. Confirmation dialog appears after merge tool exits (not auto-accept)
5. Quick resolve (theirs/yours) shows confirmation before executing
6. Query cache invalidated after any resolve operation (opened, changes, unresolved, fileTree)
7. Submit blocked with descriptive error for changelists with unresolved files
8. Context menu shows "Resolve..." for conflicted files only
</verification>

<success_criteria>
End-to-end resolve workflow functional: user sees conflict indicators, can resolve via merge tool or quick resolve, gets confirmation before destructive actions, sees status update after resolution, and cannot submit with unresolved conflicts.
</success_criteria>

<output>
After completion, create `.planning/phases/15-resolve-workflow/15-02-SUMMARY.md`
</output>
