---
phase: 09-e2e-testing-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/wdio.conf.ts
  - e2e/tsconfig.json
  - package.json
  - src/components/SyncToolbar.tsx
  - src/components/FileTree/FileTree.tsx
  - src/components/FileTree/FileTreeNode.tsx
  - src/components/ChangelistPanel/ChangelistPanel.tsx
  - src/components/ChangelistPanel/ChangelistItem.tsx
  - src/components/dialogs/SubmitDialog.tsx
  - src/components/MainLayout.tsx
  - src/components/StatusBar.tsx
  - src/components/ConnectionStatus.tsx
autonomous: true

must_haves:
  truths:
    - "Running `npm run test:e2e` invokes WebdriverIO with tauri-driver configuration"
    - "All core UI elements have data-testid attributes for stable test selectors"
    - "TypeScript compiles test files without errors"
  artifacts:
    - path: "e2e/wdio.conf.ts"
      provides: "WebdriverIO configuration with tauri-driver lifecycle"
    - path: "e2e/tsconfig.json"
      provides: "TypeScript config for test files"
    - path: "package.json"
      provides: "test:e2e script and devDependencies"
  key_links:
    - from: "e2e/wdio.conf.ts"
      to: "src-tauri/target/release/p4now.exe"
      via: "tauri:options.application path"
    - from: "package.json"
      to: "e2e/wdio.conf.ts"
      via: "test:e2e script references wdio config"
---

<objective>
Set up WebdriverIO E2E testing infrastructure and add data-testid attributes to all UI components needed for core workflow tests.

Purpose: Creates the foundation that test specs depend on — without infrastructure and stable selectors, no tests can run.
Output: Working wdio config, TypeScript setup, npm script, and data-testid attributes on all testable UI elements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-testing-foundation/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create E2E infrastructure</name>
  <files>
    package.json
    e2e/wdio.conf.ts
    e2e/tsconfig.json
  </files>
  <action>
1. Install WebdriverIO dependencies:
   `npm install --save-dev @wdio/cli @wdio/local-runner @wdio/mocha-framework @wdio/spec-reporter @wdio/types tsx`

2. Add npm script to package.json:
   `"test:e2e": "wdio run e2e/wdio.conf.ts"`

3. Create `e2e/tsconfig.json`:
   - target: ES2022, module: ESNext, moduleResolution: Node
   - types: ["node", "@wdio/globals/types", "@wdio/mocha-framework"]
   - strict: true, esModuleInterop: true, skipLibCheck: true
   - include: ["./test/**/*.ts", "./wdio.conf.ts"]

4. Create `e2e/wdio.conf.ts` following the Tauri WebdriverIO pattern:
   - Import spawn from node:child_process, join from node:path
   - Let tauriDriver: ChildProcess at module scope
   - specs: ['./test/specs/**/*.ts']
   - maxInstances: 1 (sequential execution)
   - capabilities: single capability with `'tauri:options': { application: join(process.cwd(), '..', 'src-tauri', 'target', 'release', 'p4now.exe') }`
   - onPrepare: spawn `npm run tauri build` with shell:true, stdio:'inherit', cwd: join(process.cwd(), '..'). Wait for process to exit (return new Promise wrapping child.on('close')).
   - beforeSession: spawn 'tauri-driver' with stdio: ['ignore', 'pipe', 'pipe']. Wait 500ms for startup.
   - afterSession: tauriDriver.kill()
   - framework: 'mocha'
   - reporters: ['spec']
   - mochaOpts: { ui: 'bdd', timeout: 60000 }
   - waitforTimeout: 10000

NOTE: The cwd for wdio is the e2e/ directory, so paths to the app binary go up one level. Do NOT add an onPrepare that builds the app — that would add minutes to every test run. Users build separately with `npm run tauri build` before running tests. Instead, add a comment in the config explaining this prerequisite.
  </action>
  <verify>
    - `npm ls @wdio/cli` shows installed version
    - `npx tsc --project e2e/tsconfig.json --noEmit` compiles without errors (may need a dummy .ts file — create e2e/test/specs/.gitkeep if needed)
    - `npm run test:e2e -- --help` shows WebdriverIO help output
  </verify>
  <done>
    WebdriverIO infrastructure exists in e2e/ directory. `npm run test:e2e` is a valid command. TypeScript config compiles test files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add data-testid attributes to core UI components</name>
  <files>
    src/components/SyncToolbar.tsx
    src/components/FileTree/FileTree.tsx
    src/components/FileTree/FileTreeNode.tsx
    src/components/ChangelistPanel/ChangelistPanel.tsx
    src/components/ChangelistPanel/ChangelistItem.tsx
    src/components/dialogs/SubmitDialog.tsx
    src/components/MainLayout.tsx
    src/components/StatusBar.tsx
    src/components/ConnectionStatus.tsx
  </files>
  <action>
Add data-testid attributes to these elements (read each file first to find the exact JSX elements):

**SyncToolbar.tsx:**
- Sync button: `data-testid="sync-button"`
- Any progress indicator: `data-testid="sync-progress"`

**FileTree/ components:**
- File tree container: `data-testid="file-tree"`
- Individual file nodes: `data-testid="file-node-{depotPath-or-filename}"` (use a sanitized version of the file identifier)
- File status indicator on each node (if separate element): `data-testid="file-status-{filename}"`

**ChangelistPanel/ components:**
- Changelist panel container: `data-testid="changelist-panel"`
- Default changelist: `data-testid="changelist-default"`
- Numbered changelists: `data-testid="changelist-{number}"`
- Individual changelist items (files in CL): `data-testid="cl-file-{filename}"`

**dialogs/SubmitDialog.tsx:**
- Submit dialog container: `data-testid="submit-dialog"`
- Description textarea: `data-testid="submit-description"`
- Submit button in dialog: `data-testid="submit-confirm-button"`

**MainLayout.tsx:**
- Main app container: `data-testid="app-ready"` (on the outermost rendered element, signals app has loaded)

**StatusBar.tsx:**
- Status bar container: `data-testid="status-bar"`

**ConnectionStatus.tsx:**
- Connection status element: `data-testid="connection-status"`

**Context menu items** (find where context menus are rendered — likely in FileTree or ChangelistPanel):
- Checkout menu item: `data-testid="context-menu-checkout"`
- Revert menu item: `data-testid="context-menu-revert"`
- Submit menu item: `data-testid="context-menu-submit"`

IMPORTANT: Only ADD data-testid attributes to existing JSX elements. Do NOT change any component logic, styling, or structure. This is purely additive.

For dynamic testids (file names, CL numbers), sanitize by replacing special characters with hyphens: `data-testid={\`file-node-${filename.replace(/[^a-zA-Z0-9]/g, '-')}\`}`
  </action>
  <verify>
    - `grep -r "data-testid" src/components/ | wc -l` shows 15+ occurrences
    - `npm run build` succeeds (no TypeScript errors from added attributes)
  </verify>
  <done>
    All core UI elements have stable data-testid selectors. The app builds successfully with the added attributes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds — app still compiles with data-testid additions
2. `npm run test:e2e -- --help` works — WebdriverIO infrastructure is functional
3. `grep -r "data-testid" src/components/` shows attributes on all key elements
</verification>

<success_criteria>
- e2e/ directory contains wdio.conf.ts and tsconfig.json
- package.json has test:e2e script and WebdriverIO devDependencies
- 15+ data-testid attributes added across core components
- App builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-testing-foundation/09-01-SUMMARY.md`
</output>
