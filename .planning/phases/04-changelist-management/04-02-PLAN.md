---
phase: 04-changelist-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/ChangelistPanel/ChangelistPanel.tsx
  - src/components/ChangelistPanel/ChangelistNode.tsx
  - src/components/ChangelistPanel/useChangelists.ts
  - src/components/ChangelistPanel/CreateChangelistDialog.tsx
  - src/components/ChangelistPanel/EditDescriptionDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a new changelist with a description via a dialog"
    - "User can edit a changelist description via a dialog opened from the header"
    - "User can delete an empty changelist immediately (no confirmation)"
    - "Default changelist is always visible first with muted styling and 'Default' label"
    - "Editing default CL description creates a new numbered changelist instead"
  artifacts:
    - path: "src/components/ChangelistPanel/CreateChangelistDialog.tsx"
      provides: "Dialog for creating new changelist with description textarea"
      contains: "CreateChangelistDialog"
    - path: "src/components/ChangelistPanel/EditDescriptionDialog.tsx"
      provides: "Dialog for editing changelist description"
      contains: "EditDescriptionDialog"
    - path: "src/components/ChangelistPanel/ChangelistPanel.tsx"
      provides: "Create button in header, dialog state management"
      contains: "CreateChangelistDialog"
    - path: "src/components/ChangelistPanel/ChangelistNode.tsx"
      provides: "Edit and delete buttons on changelist headers"
      contains: "EditDescriptionDialog"
  key_links:
    - from: "CreateChangelistDialog.tsx"
      to: "src/lib/tauri.ts"
      via: "invokeP4CreateChange"
      pattern: "invokeP4CreateChange"
    - from: "EditDescriptionDialog.tsx"
      to: "src/lib/tauri.ts"
      via: "invokeP4EditChangeDescription"
      pattern: "invokeP4EditChangeDescription"
    - from: "ChangelistNode.tsx"
      to: "src/lib/tauri.ts"
      via: "invokeP4DeleteChange"
      pattern: "invokeP4DeleteChange"
---

<objective>
Build changelist CRUD UI: create dialog, edit description dialog, delete button, and proper default changelist handling.

Purpose: Users need to create, edit, and delete changelists to organize their pending work (CL-01 through CL-04).
Output: Two new dialog components, updated changelist headers with edit/delete actions, and default CL always-visible behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-changelist-management/04-RESEARCH.md
@.planning/phases/04-changelist-management/04-01-SUMMARY.md

Key existing patterns:
- SubmitDialog.tsx uses AlertDialog from shadcn/ui — follow same pattern for new dialogs
- ChangelistNode.tsx has hover-to-show Submit button pattern — extend for Edit/Delete
- useChangelists.ts merges changelist + opened data — fix default CL to always show
- Connection store provides p4port/p4user/p4client for command invocations
- TanStack Query invalidation pattern: `queryClient.invalidateQueries({ queryKey: ['p4', 'changes'] })`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and Edit Description dialogs</name>
  <files>
    src/components/ChangelistPanel/CreateChangelistDialog.tsx
    src/components/ChangelistPanel/EditDescriptionDialog.tsx
  </files>
  <action>
**CreateChangelistDialog.tsx:**
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`
- Uses AlertDialog (same as SubmitDialog pattern)
- Title: "New Changelist"
- Body: textarea for description (required, placeholder "Enter changelist description...")
- On submit: call `invokeP4CreateChange(description, server, user, client)` using connection store values
- On success: toast success with "Created changelist #NNN", invalidate `['p4', 'changes']` query, close dialog
- On error: toast error, keep dialog open
- Disable submit button when description is empty or submitting
- Loading state: button shows "Creating..." while submitting

**EditDescriptionDialog.tsx:**
- Props: `changelist: P4Changelist | null`, `open: boolean`, `onOpenChange: (open: boolean) => void`
- Uses AlertDialog (same pattern)
- Title: "Edit Changelist #{id}"
- Body: textarea pre-filled with current description
- On submit: call `invokeP4EditChangeDescription(changelist.id, description, server, user, client)`
- On success: toast success, invalidate `['p4', 'changes']` query, close dialog
- On error: toast error, keep dialog open

**Special case for default CL (id === 0):**
- When EditDescriptionDialog receives a changelist with id === 0, change title to "Create Numbered Changelist"
- Change description text to: "The default changelist cannot have a description. Entering a description will create a new numbered changelist."
- On submit: call `invokeP4CreateChange(description)` instead of edit
- This reflects P4's actual behavior

Both dialogs use `useConnectionStore()` to get p4port/p4user/p4client and `useQueryClient()` for invalidation.
  </action>
  <verify>
`npx tsc --noEmit` passes. Both dialog files exist and export their components.
  </verify>
  <done>CreateChangelistDialog creates changelists via invokeP4CreateChange. EditDescriptionDialog edits descriptions via invokeP4EditChangeDescription. Default CL "edit" creates a new numbered CL instead.</done>
</task>

<task type="auto">
  <name>Task 2: Update changelist headers with CRUD actions and fix default CL visibility</name>
  <files>
    src/components/ChangelistPanel/ChangelistPanel.tsx
    src/components/ChangelistPanel/ChangelistNode.tsx
    src/components/ChangelistPanel/useChangelists.ts
  </files>
  <action>
**useChangelists.ts changes:**
- Fix the filter in treeData memo (line ~102): default CL (id === 0) should ALWAYS be included, even when empty
- Change filter to: `const visible = clArray.filter(cl => cl.id === 0 || cl.fileCount > 0 || cl.description);`
- Sort: default CL first (id === 0), then numbered CLs by ID ascending

**ChangelistPanel.tsx changes:**
- Add "+" button next to "Pending Changes" header to open CreateChangelistDialog
- Import and render CreateChangelistDialog with open/onOpenChange state
- Import and render EditDescriptionDialog with state for selected changelist
- Pass `onEdit` and `onDelete` callbacks to Tree/ChangelistNode
- Add `onEdit(cl: P4Changelist)` handler that opens EditDescriptionDialog with the changelist
- Add `onDelete(cl: P4Changelist)` handler that:
  - Validates: cannot delete default (id === 0) or non-empty (fileCount > 0)
  - Calls `invokeP4DeleteChange(cl.id, server, user, client)`
  - On success: toast "Deleted changelist #{id}", invalidate queries
  - On error: toast error
  - No confirmation dialog needed (per CONTEXT.md)

**ChangelistNode.tsx changes:**
- Add `onEdit?: () => void` and `onDelete?: () => void` props
- In changelist header (type === 'changelist'), add hover-to-show action buttons after the Submit button:
  - Edit button (Pencil icon from lucide-react): always visible on hover for all CLs
  - Delete button (Trash2 icon): only visible on hover when `changelist.id !== 0 && changelist.fileCount === 0`
  - Both use same opacity-0 group-hover:opacity-100 pattern as existing Submit button
- Changelist header format: "#{id} — {description} ({fileCount} files)" for numbered CLs
  - For default CL: show "(no description)" with muted text color (text-slate-400 instead of text-slate-200)
- Add changelist number before description in header: `#{changelist.id}` for numbered CLs, skip for default

Use `Plus`, `Pencil`, `Trash2` from lucide-react for icons.
  </action>
  <verify>
`npx tsc --noEmit` passes. Default CL always appears first. Create/Edit/Delete actions work from header buttons.
  </verify>
  <done>Changelist headers show #{id}, description, file count, and hover actions (submit, edit, delete). Default CL is always visible with muted styling. "+" button creates new changelists. Delete is disabled for non-empty CLs and default CL.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Default CL always appears first in the panel, even when empty
3. "+" button in header opens CreateChangelistDialog
4. Edit button on changelist header opens EditDescriptionDialog
5. Delete button only appears on empty, non-default changelists
6. Editing default CL creates a new numbered changelist
</verification>

<success_criteria>
- User can create a new changelist via dialog with description
- User can edit a changelist description via dialog
- User can delete empty non-default changelists immediately
- Default changelist is always visible first with distinct styling
- All operations invalidate TanStack Query cache for immediate UI updates
</success_criteria>

<output>
After completion, create `.planning/phases/04-changelist-management/04-02-SUMMARY.md`
</output>
