---
phase: 16-file-content-viewer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/languageMap.ts
  - src-tauri/src/commands/p4.rs
  - src/lib/tauri.ts
autonomous: true

must_haves:
  truths:
    - "prism-react-renderer library is installed and importable"
    - "languageMap.ts exports getLanguageFromPath function"
    - "Backend can return file content for a depot path and revision"
  artifacts:
    - path: "src/lib/languageMap.ts"
      provides: "File extension to Prism language mapping"
      exports: ["getLanguageFromPath"]
    - path: "src/lib/tauri.ts"
      provides: "Frontend invoke function for p4_print_content"
      contains: "invokeP4PrintContent"
  key_links:
    - from: "src/lib/tauri.ts"
      to: "src-tauri/src/commands/p4.rs"
      via: "Tauri invoke for p4_print_content command"
      pattern: "invoke.*p4_print_content"
---

<objective>
Install syntax highlighting library and create infrastructure for file content viewing.

Purpose: Lay the foundation for file content display with syntax highlighting.
Output: prism-react-renderer installed, language mapping utility, backend command for reading file content.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-file-content-viewer/16-RESEARCH.md
@src/lib/tauri.ts
@src-tauri/src/commands/p4.rs (focus on p4_print_to_file at line ~1185)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install prism-react-renderer and create language map</name>
  <files>package.json, src/lib/languageMap.ts</files>
  <action>
1. Install prism-react-renderer:
   ```
   npm install prism-react-renderer
   ```

2. Create src/lib/languageMap.ts with the getLanguageFromPath function:
   - Map common file extensions to Prism language identifiers
   - Handle extensionless files (Makefile, Dockerfile, Jenkinsfile)
   - Default to 'plaintext' for unknown extensions
   - Include mappings for: js, jsx, ts, tsx, html, xml, css, scss, json, c, h, cpp, cc, cxx, hpp, cs, rs, go, java, py, rb, sh, bat, ps1, yaml, yml, toml, ini, md, sql, graphql

Reference Pattern 3 from 16-RESEARCH.md for the implementation.
  </action>
  <verify>
- Run `npm list prism-react-renderer` to verify installation
- Verify languageMap.ts exports getLanguageFromPath
- Test: getLanguageFromPath("test.tsx") returns "tsx"
- Test: getLanguageFromPath("Makefile") returns "makefile"
- Test: getLanguageFromPath("unknown.xyz") returns "plaintext"
  </verify>
  <done>prism-react-renderer is installed, languageMap.ts exists with comprehensive extension mapping</done>
</task>

<task type="auto">
  <name>Task 2: Add p4_print_content backend command</name>
  <files>src-tauri/src/commands/p4.rs, src/lib/tauri.ts</files>
  <action>
1. In src-tauri/src/commands/p4.rs, add a new command `p4_print_content`:
   - Takes depot_path, revision, and connection args (server, user, client)
   - Reuse the existing temp file pattern from p4_print_to_file
   - After p4 print completes, read the temp file content using tokio::fs::read_to_string
   - Return the content as a String
   - Add MAX_CONTENT_SIZE constant (10MB = 10 * 1024 * 1024 bytes)
   - If file exceeds MAX_CONTENT_SIZE, return an error with the size

2. Register the command in main.rs or lib.rs (where other p4 commands are registered)

3. In src/lib/tauri.ts, add invokeP4PrintContent function:
   ```typescript
   export async function invokeP4PrintContent(
     depotPath: string,
     revision: number
   ): Promise<string> {
     return invoke<string>('p4_print_content', {
       depotPath,
       revision,
       ...getConnectionArgs()
     });
   }
   ```

IMPORTANT: The backend should check file size BEFORE reading to prevent memory exhaustion. Use p4 fstat to get fileSize first, or catch read errors gracefully.
  </action>
  <verify>
- Rust compiles without errors: `cd src-tauri && cargo check`
- TypeScript compiles: `npm run build` (or tsc check)
- Manual test: Call invokeP4PrintContent with a known depot path and revision
  </verify>
  <done>Backend returns file content for a given depot path and revision, with size limit enforced</done>
</task>

</tasks>

<verification>
1. `npm list prism-react-renderer` shows version 2.x installed
2. `cargo check` in src-tauri passes
3. `npm run build` completes without TypeScript errors
4. languageMap.ts correctly maps common extensions
</verification>

<success_criteria>
- prism-react-renderer ^2.4.1+ installed in package.json
- src/lib/languageMap.ts exports getLanguageFromPath with 20+ extension mappings
- p4_print_content backend command registered and callable
- invokeP4PrintContent exported from src/lib/tauri.ts
</success_criteria>

<output>
After completion, create `.planning/phases/16-file-content-viewer/16-01-SUMMARY.md`
</output>
