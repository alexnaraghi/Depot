---
phase: 06-shelve-reconcile
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/ChangelistPanel/ChangelistPanel.tsx
  - src/components/ChangelistPanel/ShelvedFilesSection.tsx
  - src/components/ChangelistPanel/ChangelistContextMenu.tsx
  - src/components/ChangelistPanel/useChangelists.ts
  - src/hooks/useShelvedFiles.ts
autonomous: true

must_haves:
  truths:
    - "User can shelve selected files from a changelist via context menu"
    - "User can see shelved files in a collapsible section below pending files per changelist"
    - "User can unshelve all files from a shelf back to the changelist"
    - "User can delete a shelf from a changelist"
    - "User sees warning when unshelving and files are already opened locally"
  artifacts:
    - path: "src/components/ChangelistPanel/ShelvedFilesSection.tsx"
      provides: "Collapsible shelved files display with unshelve and delete actions"
      min_lines: 40
    - path: "src/hooks/useShelvedFiles.ts"
      provides: "Hook for querying shelved files and shelve/unshelve/delete mutations"
      min_lines: 30
  key_links:
    - from: "src/hooks/useShelvedFiles.ts"
      to: "src/lib/tauri.ts"
      via: "invokeP4DescribeShelved, invokeP4Shelve, invokeP4Unshelve, invokeP4DeleteShelf"
      pattern: "invokeP4(Shelve|Unshelve|DeleteShelf|DescribeShelved)"
    - from: "src/components/ChangelistPanel/ShelvedFilesSection.tsx"
      to: "src/hooks/useShelvedFiles.ts"
      via: "useShelvedFiles hook"
      pattern: "useShelvedFiles"
    - from: "src/components/ChangelistPanel/ChangelistContextMenu.tsx"
      to: "src/hooks/useShelvedFiles.ts"
      via: "shelve mutation from context menu"
      pattern: "shelve"
---

<objective>
Add shelved files display and shelve/unshelve/delete interactions to the changelist panel.

Purpose: Users can shelve pending files, see shelved files distinctly, unshelve them back, and delete shelves — completing SHELV-01 through SHELV-05.
Output: ShelvedFilesSection component, useShelvedFiles hook, context menu shelve action.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-shelve-reconcile/06-RESEARCH.md
@.planning/phases/06-shelve-reconcile/06-01-SUMMARY.md

@src/components/ChangelistPanel/ChangelistPanel.tsx
@src/components/ChangelistPanel/ChangelistNode.tsx
@src/components/ChangelistPanel/ChangelistContextMenu.tsx
@src/components/ChangelistPanel/useChangelists.ts
@src/lib/tauri.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useShelvedFiles hook and ShelvedFilesSection component</name>
  <files>src/hooks/useShelvedFiles.ts, src/components/ChangelistPanel/ShelvedFilesSection.tsx</files>
  <action>
**useShelvedFiles.ts:**
Create a hook that provides:
- `useShelvedFilesQuery(changelistId: number)` — TanStack useQuery calling invokeP4DescribeShelved. Query key: `['p4', 'shelved', changelistId]`. Enabled only when changelistId > 0 (default CL can't have shelved files).
- `useShelve()` — TanStack useMutation calling invokeP4Shelve. On success: toast success, invalidate `['p4', 'shelved']` and `['p4', 'opened']` and `['p4', 'changes']`.
- `useUnshelve()` — TanStack useMutation calling invokeP4Unshelve. Before executing:
  1. Call invokeP4Opened to get currently opened files
  2. Compare depot paths of shelved files against opened files
  3. If overlaps exist, show window.confirm warning: "N file(s) are already opened. Unshelving may create conflicts that need resolution. Continue?"
  4. If user cancels, throw to abort mutation
  On success: toast success, invalidate `['p4', 'shelved']`, `['p4', 'opened']`, `['p4', 'changes']`.
- `useDeleteShelf()` — TanStack useMutation calling invokeP4DeleteShelf. On success: toast success, invalidate `['p4', 'shelved']`.

Use connection store for server/user/client args (same pattern as useFileHistory, useSearch).

**ShelvedFilesSection.tsx:**
Create a component that renders inside a changelist node, below pending files:
- Props: `{ changelistId: number }`
- Uses `useShelvedFilesQuery(changelistId)` to fetch shelved files
- If no shelved files, render nothing (return null)
- If shelved files exist, render a collapsible section:
  - Header row: chevron icon + "Shelved Files (N)" text + action buttons
  - Action buttons (visible on header hover): "Unshelve" (ArrowDownToLine icon) and "Delete Shelf" (Trash2 icon)
  - Collapsible content: list of shelved files, each showing:
    - File icon (Archive or Package icon in purple/violet to distinguish from pending)
    - Filename (last segment of depot path)
    - Action badge (edit, add, delete) in muted text
  - Default state: collapsed
- Use shadcn Collapsible component (already used in OutputPanel)
- Use lucide-react icons (already in project)
- Styling: purple/violet accent for shelved files to distinguish from pending (per research recommendation)
- Unshelve button calls useUnshelve mutation with changelistId
- Delete Shelf button calls useDeleteShelf mutation with changelistId, with window.confirm "Delete all shelved files from CL N? This cannot be undone."
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`. ShelvedFilesSection renders shelved files section when data exists, returns null when empty.
  </verify>
  <done>useShelvedFiles hook provides query + 3 mutations. ShelvedFilesSection shows collapsible shelved files with unshelve/delete actions and conflict warning on unshelve.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate shelved files into changelist panel and add shelve to context menu</name>
  <files>src/components/ChangelistPanel/ChangelistPanel.tsx, src/components/ChangelistPanel/ChangelistNode.tsx, src/components/ChangelistPanel/ChangelistContextMenu.tsx</files>
  <action>
**ChangelistNode.tsx or ChangelistPanel.tsx:**
- For each numbered changelist node (id > 0), render `<ShelvedFilesSection changelistId={cl.id} />` below the existing pending files area
- The exact integration point depends on how the tree currently renders — if changelists are tree nodes with file children, add ShelvedFilesSection as a sibling after the file list section within the changelist's rendered area
- If the tree structure makes inline rendering difficult, add ShelvedFilesSection as a section that appears when a changelist is expanded, below the last file node

**ChangelistContextMenu.tsx:**
- Add "Shelve Selected Files" menu item to the file-level context menu (when right-clicking files in pending changes)
- This item calls useShelve mutation with the file's changelist ID and selected file depot paths
- Only show "Shelve" option for files in numbered changelists (not default CL — p4 shelve requires numbered CL)
- If multiple files are selected, shelve all selected files
- Add separator before the shelve option to group it visually

After shelve completes, the ShelvedFilesSection will auto-update via query invalidation.
  </action>
  <verify>
TypeScript compiles. Shelved files section appears below pending files for changelists that have shelved files. Context menu shows "Shelve" for files in numbered changelists.
  </verify>
  <done>ShelvedFilesSection integrated into changelist panel. Shelve action available in file context menu for numbered changelists. Query invalidation keeps UI in sync.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no TypeScript errors
2. ShelvedFilesSection component exists and renders shelved files with purple accent
3. Context menu has "Shelve Selected Files" option for files in numbered changelists
4. Unshelve shows conflict warning when files are already opened
5. Delete shelf has confirmation dialog
6. All mutations invalidate appropriate query keys
</verification>

<success_criteria>
- Shelved files appear in collapsible section below pending files per changelist
- User can shelve files via context menu
- User can unshelve all files with conflict warning
- User can delete a shelf with confirmation
- Shelved files visually distinct (purple/violet accent)
</success_criteria>

<output>
After completion, create `.planning/phases/06-shelve-reconcile/06-02-SUMMARY.md`
</output>
