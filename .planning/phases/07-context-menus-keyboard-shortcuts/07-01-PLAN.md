---
phase: 07-context-menus-keyboard-shortcuts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/shortcuts.ts
  - src/components/ChangelistPanel/ChangelistNode.tsx
  - src/components/ChangelistPanel/ChangelistPanel.tsx
  - src/components/shared/FileContextMenuItems.tsx
  - src/components/FileTree/FileContextMenu.tsx
  - src/components/ChangelistPanel/ChangelistContextMenu.tsx
  - src/components/SyncToolbar.tsx
  - src/components/MainLayout.tsx
autonomous: true

must_haves:
  truths:
    - "Right-clicking a changelist header shows Submit, Shelve, Unshelve, New Changelist, Edit Description, Delete, and Revert actions"
    - "Keyboard shortcuts work for Refresh (F5), Sync (Ctrl+Shift+S), New Changelist (Ctrl+Shift+N)"
    - "Keyboard shortcuts are displayed in context menus as right-aligned muted text"
    - "Toolbar buttons show keyboard shortcuts in their tooltips"
    - "Context menus show Open in Explorer option for files"
  artifacts:
    - path: "src/lib/shortcuts.ts"
      provides: "Centralized shortcut registry mapping action names to key combos and labels"
    - path: "src/components/ChangelistPanel/ChangelistNode.tsx"
      provides: "Changelist header right-click context menu trigger"
  key_links:
    - from: "src/lib/shortcuts.ts"
      to: "src/components/shared/FileContextMenuItems.tsx"
      via: "import shortcut labels for menu display"
      pattern: "SHORTCUTS\\."
    - from: "src/lib/shortcuts.ts"
      to: "src/components/MainLayout.tsx"
      via: "useHotkeys for global keyboard shortcuts"
      pattern: "useHotkeys"
---

<objective>
Install keyboard shortcut and command palette dependencies, create the centralized shortcut registry, add changelist header context menu, wire up global keyboard shortcuts, and add shortcut hints to all context menus and toolbar tooltips.

Purpose: Delivers the keyboard shortcuts and changelist header menu requirements (CTX-02, KEY-01, KEY-02) and prepares the shortcut registry needed by the command palette in Plan 02.
Output: Working keyboard shortcuts, changelist header right-click menu, shortcut hints displayed in menus and tooltips.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-context-menus-keyboard-shortcuts/07-CONTEXT.md
@.planning/phases/07-context-menus-keyboard-shortcuts/07-RESEARCH.md
@src/lib/shortcuts.ts (will be created)
@src/components/MainLayout.tsx
@src/components/SyncToolbar.tsx
@src/components/shared/FileContextMenuItems.tsx
@src/components/FileTree/FileContextMenu.tsx
@src/components/ChangelistPanel/ChangelistContextMenu.tsx
@src/components/ChangelistPanel/ChangelistNode.tsx
@src/components/ChangelistPanel/ChangelistPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install deps, create shortcut registry, add changelist header menu</name>
  <files>
    package.json
    src/lib/shortcuts.ts
    src/components/ChangelistPanel/ChangelistNode.tsx
    src/components/ChangelistPanel/ChangelistPanel.tsx
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install react-hotkeys-hook
   npx shadcn@latest add command dropdown-menu
   ```
   Note: `cmdk` comes bundled with shadcn command component. dropdown-menu adds @radix-ui/react-dropdown-menu.

2. Create `src/lib/shortcuts.ts` — centralized shortcut registry:
   - Export a `SHORTCUTS` object mapping action names to `{ keys: string, label: string }` objects
   - Shortcut definitions:
     - REFRESH: { keys: 'F5', label: 'F5' }
     - SYNC: { keys: 'ctrl+shift+s', label: 'Ctrl+Shift+S' }
     - SUBMIT: { keys: 'ctrl+shift+enter', label: 'Ctrl+Shift+Enter' }
     - REVERT: { keys: 'ctrl+shift+r', label: 'Ctrl+Shift+R' } (context-sensitive: only when file selected)
     - DIFF: { keys: 'ctrl+d', label: 'Ctrl+D' } (context-sensitive)
     - HISTORY: { keys: 'ctrl+h', label: 'Ctrl+H' } (context-sensitive — NOTE: Ctrl+H is browser history in browsers but fine in Tauri desktop)
     - NEW_CHANGELIST: { keys: 'ctrl+shift+n', label: 'Ctrl+Shift+N' }
     - COMMAND_PALETTE: { keys: 'ctrl+shift+p', label: 'Ctrl+Shift+P' } (also 'ctrl+comma' as alias)
   - Export helper function `formatShortcutLabel(shortcutKey: keyof typeof SHORTCUTS): string` that returns the human-readable label

3. Add changelist header context menu to `ChangelistNode.tsx`:
   - Add `onHeaderContextMenu` prop to ChangelistNode: `(e: React.MouseEvent, changelist: P4Changelist) => void`
   - On changelist header row (where type === 'changelist'), add `onContextMenu` handler that calls `e.preventDefault()` and `onHeaderContextMenu(e, changelist)`
   - This prop is passed from ChangelistPanel

4. In `ChangelistPanel.tsx`:
   - Add state for header context menu: `headerMenuState: { changelist: P4Changelist; x: number; y: number } | null`
   - Create `handleHeaderContextMenu` callback that sets this state
   - Pass `onHeaderContextMenu={handleHeaderContextMenu}` to `ChangelistNode`
   - When `headerMenuState` is set, render a new `ChangelistHeaderMenu` component (inline in ChangelistPanel or as separate div) using the same manual positioning pattern as existing context menus:
     - Fixed-position div at (x, y) with the same styling as other context menus (bg-slate-900, border-slate-700, rounded-md, shadow-xl)
     - Menu items based on changelist state:
       - **Submit** (always for CLs with files, calls existing onSubmit flow)
       - **Shelve** (only for numbered CLs with files)
       - **Unshelve** (only for numbered CLs with shelved files — check if changelist has shelved data)
       - Separator
       - **New Changelist** (always, opens create dialog)
       - **Edit Description** (always, opens edit dialog)
       - Separator
       - **Delete** (only for empty numbered CLs, calls existing delete flow)
       - **Revert All Files** (only for CLs with files — reverts all files in the changelist)
     - Each item: button with icon + label, same styling as FileContextMenuItems
     - Close on click outside or Escape (same useEffect pattern as ChangelistContextMenu)
   - Icons: Send for Submit, Archive for Shelve, ArrowDownToLine for Unshelve, Plus for New CL, Pencil for Edit, Trash2 for Delete, Undo2 for Revert
   - For "Revert All Files": call `revert()` from useFileOperations with all file depot paths in the changelist

  NOTE: To determine if a changelist has shelved files, look at how ShelvedFilesSection or useShelvedFiles works. The simplest approach is to check if the tree data for that changelist contains any 'shelved-section' or 'shelved-file' type nodes. Alternatively, just always show Unshelve for numbered CLs and let the backend handle the case where there are no shelves.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - `src/lib/shortcuts.ts` exports SHORTCUTS object with all defined shortcuts
    - Right-clicking a changelist header in ChangelistPanel shows the header context menu with appropriate actions
  </verify>
  <done>
    - Shortcut registry exists with all shortcut definitions
    - Changelist header right-click menu shows Submit, Shelve, Unshelve, New CL, Edit Description, Delete, Revert actions conditionally
    - Dependencies (react-hotkeys-hook, shadcn command + dropdown-menu) installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire global keyboard shortcuts and add shortcut hints to menus/tooltips</name>
  <files>
    src/components/MainLayout.tsx
    src/components/SyncToolbar.tsx
    src/components/shared/FileContextMenuItems.tsx
    src/components/ChangelistPanel/ChangelistContextMenu.tsx
    src/components/FileTree/FileContextMenu.tsx
  </files>
  <action>
1. In `MainLayout.tsx`, add global keyboard shortcuts using `react-hotkeys-hook`:
   - Import `useHotkeys` from 'react-hotkeys-hook' and `SHORTCUTS` from '@/lib/shortcuts'
   - Add `useHotkeys(SHORTCUTS.REFRESH.keys, () => { queryClient.invalidateQueries() }, { enableOnFormTags: false })` — refreshes all queries
   - Add `useHotkeys(SHORTCUTS.SYNC.keys, () => { /* trigger sync */ })` — need to lift sync trigger or use a ref/callback. Simplest: create a custom event `window.dispatchEvent(new CustomEvent('p4now:sync'))` and listen in SyncToolbar.
   - Add `useHotkeys(SHORTCUTS.NEW_CHANGELIST.keys, () => { /* open create dialog */ })` — dispatch custom event 'p4now:new-changelist' and listen in ChangelistPanel
   - Add `useHotkeys(SHORTCUTS.COMMAND_PALETTE.keys, () => { /* will be wired in plan 02 */ })` — for now, just preventDefault to reserve the shortcut. Also bind 'ctrl+comma' as alias.
   - Set `enableOnFormTags: false` on all shortcuts so they don't fire when typing in inputs/textareas
   - Set `preventDefault: true` on shortcuts that conflict with browser defaults

2. In `SyncToolbar.tsx`:
   - Listen for 'p4now:sync' custom event to trigger sync
   - Update Sync button title to include shortcut: `title="Sync Workspace (Ctrl+Shift+S)"`
   - Update Reconcile button title to include description (no shortcut assigned)
   - Add `useEffect` to listen for custom event and trigger handleSync

3. In `ChangelistPanel.tsx`:
   - Listen for 'p4now:new-changelist' custom event to open create dialog

4. Add shortcut hints to `FileContextMenuItems.tsx`:
   - Import SHORTCUTS from '@/lib/shortcuts'
   - For each menu item that has a shortcut, add a right-aligned `<span className="ml-auto text-xs text-slate-500">{SHORTCUTS.X.label}</span>` after the label text
   - Shortcuts to show:
     - Revert Changes → SHORTCUTS.REVERT.label
     - File History → SHORTCUTS.HISTORY.label
     - Diff against Have → SHORTCUTS.DIFF.label
   - Add "Open in Explorer" menu item at the bottom (after Copy Local Path):
     - Import `open` from '@tauri-apps/plugin-opener' (already installed per research)
     - On click: extract directory from file.localPath (remove filename) and call `open(directory)`
     - Icon: FolderOpen from lucide-react
   - Add separators between logical groups: [Checkout] | [Revert] | [History, Diff] | [Copy Path, Open in Explorer]

5. In `ChangelistContextMenu.tsx`:
   - Add shortcut hint for Shelve if a shortcut is defined (none currently, skip)
   - Add "Open in Explorer" via FileContextMenuItems (already included for single file selection)

6. In `FileContextMenu.tsx` (workspace tree):
   - Already delegates to FileContextMenuItems, so shortcut hints and Open in Explorer will appear automatically

  </action>
  <verify>
    - `npm run build` compiles without errors
    - Press F5 in the app → data refreshes
    - Press Ctrl+Shift+S → sync starts
    - Press Ctrl+Shift+N → create changelist dialog opens
    - Context menu items show shortcut hints (right-aligned muted text)
    - Keyboard shortcuts do NOT fire when typing in input fields
  </verify>
  <done>
    - Global keyboard shortcuts work for Refresh (F5), Sync (Ctrl+Shift+S), New Changelist (Ctrl+Shift+N)
    - All context menus display shortcut hints as right-aligned muted text
    - Toolbar tooltips include shortcut text
    - Open in Explorer option available in file context menus
    - Shortcuts suppressed when focus is on form elements
  </done>
</task>

</tasks>

<verification>
1. Right-click a changelist header → context menu appears with Submit, Shelve, New CL, Edit Description, Delete/Revert options
2. Right-click a file in pending changes → shows Diff, Revert, Move to CL, Shelve, File History with shortcut hints
3. Press F5 → data refreshes
4. Press Ctrl+Shift+S → sync initiates
5. Press Ctrl+Shift+N → new changelist dialog opens
6. Type in a text input → shortcuts do NOT fire
7. Toolbar buttons show shortcuts in tooltips
8. `npm run build` succeeds
</verification>

<success_criteria>
- Changelist header context menu functional with all conditional actions
- Keyboard shortcuts work for core operations (F5, Ctrl+Shift+S, Ctrl+Shift+N)
- Shortcut hints visible in context menus
- Open in Explorer option in file menus
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-context-menus-keyboard-shortcuts/07-01-SUMMARY.md`
</output>
