---
phase: 24-tree-performance-delta-refresh
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/stores/fileTreeStore.ts
  - src/types/settings.ts
  - src/lib/settings.ts
autonomous: true

must_haves:
  truths:
    - "Immer library is installed and importable"
    - "File tree store supports batch updates without N Map copies"
    - "Settings support separate fast/slow refresh intervals"
  artifacts:
    - path: "package.json"
      provides: "immer dependency"
      contains: "immer"
    - path: "src/stores/fileTreeStore.ts"
      provides: "batchUpdateFiles action"
      exports: ["useFileTreeStore"]
    - path: "src/types/settings.ts"
      provides: "deltaRefreshInterval and fullRefreshInterval settings"
      contains: "deltaRefreshInterval"
  key_links:
    - from: "src/stores/fileTreeStore.ts"
      to: "immer"
      via: "import produce"
      pattern: "from 'immer'"
---

<objective>
Install Immer for structural sharing and add batch update infrastructure to the file tree store.

Purpose: Foundation for incremental tree updates. Without Immer, every tree update breaks object identity. Without batch updates, N file changes trigger N re-renders.
Output: Immer installed, fileTreeStore with batchUpdateFiles action, settings with two-tier refresh intervals
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-tree-performance-delta-refresh/24-CONTEXT.md
@.planning/phases/24-tree-performance-delta-refresh/24-RESEARCH.md
@src/stores/fileTreeStore.ts
@src/types/settings.ts
@src/lib/settings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Immer and add settings for two-tier refresh</name>
  <files>
    package.json
    src/types/settings.ts
    src/lib/settings.ts
  </files>
  <action>
    1. Run `npm install immer` to add Immer dependency

    2. In src/types/settings.ts:
       - Add `deltaRefreshInterval: z.number().min(0).max(600000)` (fast refresh for opened files)
       - Add `fullRefreshInterval: z.number().min(0).max(3600000)` (slow refresh for full workspace)
       - Update defaultSettings: deltaRefreshInterval: 30000 (30s), fullRefreshInterval: 300000 (5min)
       - Keep existing autoRefreshInterval for backwards compatibility (changelists still use it)

    3. In src/lib/settings.ts:
       - Add loadSettings entries for deltaRefreshInterval and fullRefreshInterval
       - Add saveSettings entries for both
       - Add getDeltaRefreshInterval() and getFullRefreshInterval() helper functions
  </action>
  <verify>
    npm list immer (shows immer installed)
    grep -r "deltaRefreshInterval" src/types/settings.ts (shows new setting)
  </verify>
  <done>
    Immer installed in package.json dependencies
    Settings types include deltaRefreshInterval (default 30s) and fullRefreshInterval (default 5min)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add batch update action to fileTreeStore</name>
  <files>
    src/stores/fileTreeStore.ts
  </files>
  <action>
    1. Import produce from 'immer' at top of file

    2. Add to FileTreeState interface:
       ```typescript
       batchUpdateFiles: (updates: Map<string, Partial<P4File>>) => void;
       ```

    3. Implement batchUpdateFiles action:
       ```typescript
       batchUpdateFiles: (updates) => {
         set(state => {
           if (updates.size === 0) return state;

           const newFiles = new Map(state.files);
           let hasChanges = false;

           updates.forEach((update, depotPath) => {
             const existing = newFiles.get(depotPath);
             if (existing) {
               newFiles.set(depotPath, { ...existing, ...update });
               hasChanges = true;
             }
           });

           return hasChanges ? { files: newFiles } : state;
         });
       },
       ```

    4. Update existing updateFile to use same pattern (avoid new Map if no change):
       ```typescript
       updateFile: (depotPath, updates) => {
         const currentFiles = get().files;
         const existingFile = currentFiles.get(depotPath);

         if (existingFile) {
           const newFiles = new Map(currentFiles);
           newFiles.set(depotPath, { ...existingFile, ...updates });
           set({ files: newFiles });
         }
         // If file doesn't exist, do nothing (no state change)
       },
       ```

    Note: The actual Immer produce() usage will be in treeBuilder.ts for tree node updates (Plan 02).
    The store just needs efficient Map updates which Map.set() handles well.
  </action>
  <verify>
    TypeScript compiles without errors: npm run build (or tsc --noEmit)
    grep "batchUpdateFiles" src/stores/fileTreeStore.ts (shows new action)
  </verify>
  <done>
    fileTreeStore exports batchUpdateFiles action
    batchUpdateFiles applies multiple updates in single state change
    Only creates new Map reference if at least one update was applied
  </done>
</task>

</tasks>

<verification>
npm list immer
grep -r "deltaRefreshInterval\|fullRefreshInterval" src/types/ src/lib/
grep "batchUpdateFiles" src/stores/fileTreeStore.ts
npm run build (TypeScript compiles)
</verification>

<success_criteria>
- Immer is installed and listed in package.json dependencies
- Settings include deltaRefreshInterval (30s default) and fullRefreshInterval (5min default)
- fileTreeStore has batchUpdateFiles action that updates multiple files atomically
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-tree-performance-delta-refresh/24-01-SUMMARY.md`
</output>
